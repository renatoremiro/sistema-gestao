/* ========== üß™ SISTEMA DE TESTES - AGENDA H√çBRIDA v6.5.0 ========== */

const AgendaTests = {
    // ‚úÖ CONFIGURA√á√ÉO DOS TESTES
    config: {
        timeoutTeste: 5000,
        delayEntreTestes: 500,
        logDetalhado: true
    },

    // ‚úÖ ESTADO DOS TESTES
    state: {
        testesExecutados: 0,
        testesPassaram: 0,
        testesFalharam: 0,
        erros: [],
        relatorio: []
    },

    // ‚úÖ EXECUTAR TODOS OS TESTES
    async executarTodos() {
        console.log('üß™ ===== INICIANDO BATERIA DE TESTES v6.5.0 =====');
        this._resetarContadores();
        
        const suites = [
            this.testarInfraestruturaBasica,
            this.testarPersonalAgenda,
            this.testarPersonalDashboard,
            this.testarAgendaHelpers,
            this.testarIntegracoes,
            this.testarFluxosCompletos
        ];

        for (const suite of suites) {
            try {
                await suite.call(this);
                await this._delay(this.config.delayEntreTestes);
            } catch (error) {
                console.error('‚ùå Erro na suite de testes:', error);
                this._registrarErro('Suite de testes', error.message);
            }
        }

        this._gerarRelatorioFinal();
        return this._obterResultado();
    },

    // ‚úÖ TESTE 1: INFRAESTRUTURA B√ÅSICA
    async testarInfraestruturaBasica() {
        console.log('üìã Testando infraestrutura b√°sica...');
        
        // App.js dispon√≠vel
        this._teste('App.js carregado', () => {
            return typeof App !== 'undefined' && App.dados;
        });

        // Tasks.js dispon√≠vel
        this._teste('Tasks.js carregado', () => {
            return typeof Tasks !== 'undefined';
        });

        // Calendar.js dispon√≠vel
        this._teste('Calendar.js carregado', () => {
            return typeof Calendar !== 'undefined';
        });

        // Estrutura de dados
        this._teste('Estrutura App.dados v√°lida', () => {
            return App.dados && 
                   typeof App.dados === 'object' &&
                   Array.isArray(App.dados.tarefas);
        });

        // Utilit√°rios carregados
        this._teste('Notifications dispon√≠vel', () => {
            return typeof Notifications !== 'undefined';
        });

        this._teste('Helpers dispon√≠vel', () => {
            return typeof Helpers !== 'undefined';
        });
    },

    // ‚úÖ TESTE 2: PERSONAL AGENDA
    async testarPersonalAgenda() {
        console.log('üìã Testando PersonalAgenda...');

        // Objeto principal
        this._teste('PersonalAgenda carregado', () => {
            return typeof PersonalAgenda !== 'undefined';
        });

        // Configura√ß√µes
        this._teste('Configura√ß√µes v√°lidas', () => {
            return PersonalAgenda.config &&
                   Array.isArray(PersonalAgenda.config.tipos) &&
                   Array.isArray(PersonalAgenda.config.prioridades) &&
                   Array.isArray(PersonalAgenda.config.status);
        });

        // Estado inicial
        this._teste('Estado inicial correto', () => {
            return PersonalAgenda.state &&
                   typeof PersonalAgenda.state.modalAberto === 'boolean' &&
                   PersonalAgenda.state.viewModeAtual === 'dashboard';
        });

        // M√©todos principais
        this._teste('M√©todo abrirMinhaAgenda dispon√≠vel', () => {
            return typeof PersonalAgenda.abrirMinhaAgenda === 'function';
        });

        this._teste('M√©todo fecharModal dispon√≠vel', () => {
            return typeof PersonalAgenda.fecharModal === 'function';
        });

        this._teste('M√©todo mudarView dispon√≠vel', () => {
            return typeof PersonalAgenda.mudarView === 'function';
        });

        // Obter tarefas do usu√°rio
        this._teste('M√©todo _obterMinhasTarefas funcional', () => {
            const tarefas = PersonalAgenda._obterMinhasTarefas();
            return Array.isArray(tarefas);
        });
    },

    // ‚úÖ TESTE 3: PERSONAL DASHBOARD
    async testarPersonalDashboard() {
        console.log('üìä Testando PersonalDashboard...');

        // Objeto principal
        this._teste('PersonalDashboard carregado', () => {
            return typeof PersonalDashboard !== 'undefined';
        });

        // M√©todos de renderiza√ß√£o
        this._teste('M√©todo renderizarGraficoProgresso dispon√≠vel', () => {
            return typeof PersonalDashboard.renderizarGraficoProgresso === 'function';
        });

        this._teste('M√©todo renderizarTarefaMini dispon√≠vel', () => {
            return typeof PersonalDashboard.renderizarTarefaMini === 'function';
        });

        // Testar renderiza√ß√£o com dados mock
        this._teste('Renderiza√ß√£o de tarefa mini funcional', () => {
            const tarefaMock = {
                id: 999,
                titulo: 'Teste',
                tipo: 'pessoal',
                prioridade: 'media',
                progresso: 50
            };
            
            const html = PersonalDashboard.renderizarTarefaMini(tarefaMock);
            return html && html.includes('Teste') && html.includes('50%');
        });

        // Organiza√ß√£o de dados
        this._teste('Agrupar tarefas por status funcional', () => {
            const grupos = PersonalDashboard.agruparTarefasPorStatus();
            return grupos && typeof grupos === 'object';
        });
    },

    // ‚úÖ TESTE 4: AGENDA HELPERS
    async testarAgendaHelpers() {
        console.log('üõ†Ô∏è Testando AgendaHelpers...');

        // Objeto principal
        this._teste('AgendaHelpers carregado', () => {
            return typeof AgendaHelpers !== 'undefined';
        });

        // Formata√ß√£o de datas
        this._teste('Formata√ß√£o de semana funcional', () => {
            const data = new Date('2025-07-15');
            const semana = AgendaHelpers.formatarSemana(data);
            return semana && typeof semana === 'string' && semana.length > 0;
        });

        this._teste('Verifica√ß√£o isHoje funcional', () => {
            const hoje = new Date();
            const isHoje = AgendaHelpers.isHoje(hoje);
            return isHoje === true;
        });

        this._teste('Obter in√≠cio da semana funcional', () => {
            const data = new Date('2025-07-15'); // Ter√ßa
            const inicio = AgendaHelpers.obterInicioSemana(data);
            return inicio instanceof Date && inicio.getDay() === 0; // Domingo
        });

        // Valida√ß√£o de dados
        this._teste('Valida√ß√£o de dados funcional', () => {
            const resultado = AgendaHelpers.validarDados();
            return resultado && 
                   typeof resultado.valido === 'boolean' &&
                   Array.isArray(resultado.problemas);
        });

        // Estat√≠sticas
        this._teste('Estat√≠sticas detalhadas funcionais', () => {
            const stats = AgendaHelpers.obterEstatisticasDetalhadas();
            return stats && 
                   stats.geral && 
                   typeof stats.geral.total === 'number';
        });
    },

    // ‚úÖ TESTE 5: INTEGRA√á√ïES
    async testarIntegracoes() {
        console.log('üîó Testando integra√ß√µes...');

        // PersonalAgenda ‚Üî PersonalDashboard
        this._teste('Integra√ß√£o PersonalAgenda ‚Üî PersonalDashboard', () => {
            return typeof PersonalAgenda._renderizarGraficoProgresso === 'function' &&
                   typeof PersonalAgenda._renderizarTarefaMini === 'function';
        });

        // PersonalAgenda ‚Üî AgendaHelpers
        this._teste('Integra√ß√£o PersonalAgenda ‚Üî AgendaHelpers', () => {
            return typeof PersonalAgenda._formatarSemana === 'function' &&
                   typeof PersonalAgenda.navegarSemana === 'function' &&
                   typeof PersonalAgenda.validarDados === 'function';
        });

        // Tasks.js ‚Üî PersonalAgenda
        this._teste('Integra√ß√£o Tasks.js ‚Üî PersonalAgenda', () => {
            return typeof Tasks.abrirMinhaAgenda === 'function';
        });

        // Debug functions dispon√≠veis
        this._teste('Fun√ß√µes de debug dispon√≠veis', () => {
            return typeof PersonalAgenda_Debug !== 'undefined' &&
                   typeof PersonalDashboard_Debug !== 'undefined' &&
                   typeof AgendaHelpers_Debug !== 'undefined';
        });
    },

    // ‚úÖ TESTE 6: FLUXOS COMPLETOS
    async testarFluxosCompletos() {
        console.log('üîÑ Testando fluxos completos...');

        // Criar tarefa mock para testes
        const tarefaTeste = {
            id: Date.now(),
            titulo: 'Tarefa de Teste',
            tipo: 'pessoal',
            prioridade: 'media',
            status: 'pendente',
            responsavel: 'Teste User',
            progresso: 25,
            dataInicio: new Date().toISOString().split('T')[0],
            estimativa: 60,
            subtarefas: [
                { titulo: 'Subtarefa 1', concluida: false },
                { titulo: 'Subtarefa 2', concluida: true }
            ]
        };

        // Adicionar tarefa aos dados
        if (!App.dados.tarefas) App.dados.tarefas = [];
        App.dados.tarefas.push(tarefaTeste);

        // Testar obten√ß√£o de tarefas
        this._teste('Obter tarefas do usu√°rio', () => {
            PersonalAgenda.state.usuarioAtual = 'Teste User';
            const tarefas = PersonalAgenda._obterMinhasTarefas();
            return tarefas.length > 0 && tarefas.some(t => t.id === tarefaTeste.id);
        });

        // Testar filtros
        this._teste('Aplicar filtros', () => {
            PersonalAgenda.state.filtros = { tipo: 'pessoal', status: 'todos', prioridade: 'todos' };
            const tarefasFiltradas = PersonalAgenda._obterMinhasTarefasFiltradas();
            return tarefasFiltradas.some(t => t.tipo === 'pessoal');
        });

        // Testar c√°lculo de estat√≠sticas
        this._teste('Calcular estat√≠sticas pessoais', () => {
            PersonalAgenda._calcularEstatisticasPessoais();
            const stats = PersonalAgenda.state.estatisticasPessoais;
            return stats && typeof stats.total === 'number';
        });

        // Testar renderiza√ß√£o de tarefa
        this._teste('Renderizar tarefa completa', () => {
            const html = PersonalDashboard.renderizarTarefaCompleta(tarefaTeste);
            return html && 
                   html.includes(tarefaTeste.titulo) &&
                   html.includes('25%') &&
                   html.includes('Subtarefa');
        });

        // Testar organiza√ß√£o por dia
        this._teste('Organizar tarefas por dia', () => {
            const inicioSemana = AgendaHelpers.obterInicioSemana(new Date());
            const tarefasPorDia = PersonalDashboard.organizarTarefasPorDia(inicioSemana);
            return tarefasPorDia && typeof tarefasPorDia === 'object';
        });

        // Limpar tarefa de teste
        const index = App.dados.tarefas.findIndex(t => t.id === tarefaTeste.id);
        if (index > -1) {
            App.dados.tarefas.splice(index, 1);
        }
    },

    // ‚úÖ TESTES ESPEC√çFICOS DE INTERFACE
    async testarInterface() {
        console.log('üé® Testando interface...');

        // Verificar se bot√£o foi adicionado
        this._teste('Bot√£o Minha Agenda adicionado', () => {
            const botao = document.getElementById('btnMinhaAgenda');
            return botao !== null;
        });

        // Testar abertura de modal (simulada)
        this._teste('Modal pode ser criado', () => {
            try {
                // Simular usu√°rio
                PersonalAgenda.state.usuarioAtual = 'Teste User';
                PersonalAgenda._calcularEstatisticasPessoais();
                
                // Criar HTML do modal (sem adicionar ao DOM)
                const modalHTML = PersonalAgenda._criarModalMinhaAgenda;
                return typeof modalHTML === 'function';
            } catch (error) {
                return false;
            }
        });

        // Testar views dispon√≠veis
        this._teste('Views configuradas corretamente', () => {
            const views = PersonalAgenda.config.viewModes;
            return Array.isArray(views) && 
                   views.length === 4 &&
                   views.some(v => v.value === 'dashboard');
        });
    },

    // ‚úÖ M√âTODOS AUXILIARES DE TESTE
    _teste(nome, funcaoTeste) {
        this.state.testesExecutados++;
        
        try {
            const resultado = funcaoTeste();
            
            if (resultado) {
                this.state.testesPassaram++;
                this._log(`‚úÖ ${nome}`, 'success');
                this.state.relatorio.push({ nome, status: 'PASS', detalhes: null });
            } else {
                this.state.testesFalharam++;
                this._log(`‚ùå ${nome}`, 'error');
                this.state.relatorio.push({ nome, status: 'FAIL', detalhes: 'Retornou false' });
            }
            
        } catch (error) {
            this.state.testesFalharam++;
            this._log(`‚ùå ${nome}: ${error.message}`, 'error');
            this.state.relatorio.push({ nome, status: 'ERROR', detalhes: error.message });
            this._registrarErro(nome, error.message);
        }
    },

    _log(mensagem, tipo = 'info') {
        if (!this.config.logDetalhado) return;
        
        const cor = {
            'success': 'color: #10b981',
            'error': 'color: #ef4444',
            'info': 'color: #3b82f6',
            'warning': 'color: #f59e0b'
        }[tipo] || 'color: #6b7280';
        
        console.log(`%c${mensagem}`, cor);
    },

    _registrarErro(teste, erro) {
        this.state.erros.push({ teste, erro, timestamp: new Date().toISOString() });
    },

    _delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    },

    _resetarContadores() {
        this.state.testesExecutados = 0;
        this.state.testesPassaram = 0;
        this.state.testesFalharam = 0;
        this.state.erros = [];
        this.state.relatorio = [];
    },

    _obterResultado() {
        return {
            total: this.state.testesExecutados,
            passaram: this.state.testesPassaram,
            falharam: this.state.testesFalharam,
            sucessoPercentual: Math.round((this.state.testesPassaram / this.state.testesExecutados) * 100),
            erros: this.state.erros,
            relatorio: this.state.relatorio
        };
    },

    _gerarRelatorioFinal() {
        const resultado = this._obterResultado();
        
        console.log('\nüß™ ===== RELAT√ìRIO FINAL DOS TESTES =====');
        console.log(`üìä Total de testes: ${resultado.total}`);
        console.log(`‚úÖ Passaram: ${resultado.passaram}`);
        console.log(`‚ùå Falharam: ${resultado.falharam}`);
        console.log(`üìà Taxa de sucesso: ${resultado.sucessoPercentual}%`);
        
        if (resultado.erros.length > 0) {
            console.log('\n‚ùå ERROS ENCONTRADOS:');
            resultado.erros.forEach(erro => {
                console.log(`   ‚Ä¢ ${erro.teste}: ${erro.erro}`);
            });
        }
        
        console.log('\nüìã RESUMO POR CATEGORIA:');
        const categorias = {};
        resultado.relatorio.forEach(item => {
            const categoria = item.nome.split(' ')[0];
            if (!categorias[categoria]) {
                categorias[categoria] = { pass: 0, fail: 0, error: 0 };
            }
            categorias[categoria][item.status.toLowerCase()]++;
        });
        
        Object.entries(categorias).forEach(([cat, stats]) => {
            console.log(`   ${cat}: ‚úÖ${stats.pass} ‚ùå${stats.fail} ‚ö†Ô∏è${stats.error}`);
        });
        
        const statusGeral = resultado.sucessoPercentual >= 90 ? 'üéâ EXCELENTE' :
                           resultado.sucessoPercentual >= 75 ? '‚úÖ BOM' :
                           resultado.sucessoPercentual >= 50 ? '‚ö†Ô∏è REGULAR' : '‚ùå CR√çTICO';
        
        console.log(`\n${statusGeral} - Sistema ${resultado.sucessoPercentual >= 75 ? 'pronto para uso' : 'precisa de ajustes'}`);
        console.log('üß™ ===== FIM DO RELAT√ìRIO =====\n');
        
        return resultado;
    },

    // ‚úÖ TESTES R√ÅPIDOS INDIVIDUAIS
    testeRapido: {
        agenda: () => {
            console.log('üß™ Teste r√°pido: PersonalAgenda');
            return typeof PersonalAgenda !== 'undefined' && 
                   typeof PersonalAgenda.abrirMinhaAgenda === 'function';
        },
        
        dashboard: () => {
            console.log('üß™ Teste r√°pido: PersonalDashboard');
            return typeof PersonalDashboard !== 'undefined' && 
                   typeof PersonalDashboard.renderizarGraficoProgresso === 'function';
        },
        
        helpers: () => {
            console.log('üß™ Teste r√°pido: AgendaHelpers');
            return typeof AgendaHelpers !== 'undefined' && 
                   typeof AgendaHelpers.validarDados === 'function';
        },
        
        integracao: () => {
            console.log('üß™ Teste r√°pido: Integra√ß√£o');
            return typeof PersonalAgenda._formatarSemana === 'function' &&
                   typeof Tasks.abrirMinhaAgenda === 'function';
        }
    },

    // ‚úÖ DIAGN√ìSTICO DO SISTEMA
    async diagnosticar() {
        console.log('üîç Executando diagn√≥stico do sistema...');
        
        const diagnostico = {
            timestamp: new Date().toISOString(),
            modulos: {
                App: typeof App !== 'undefined' && !!App.dados,
                Tasks: typeof Tasks !== 'undefined',
                Calendar: typeof Calendar !== 'undefined',
                PersonalAgenda: typeof PersonalAgenda !== 'undefined',
                PersonalDashboard: typeof PersonalDashboard !== 'undefined',
                AgendaHelpers: typeof AgendaHelpers !== 'undefined',
                Notifications: typeof Notifications !== 'undefined'
            },
            dados: {
                estruturaValida: !!(App.dados && Array.isArray(App.dados.tarefas)),
                totalTarefas: App.dados?.tarefas?.length || 0,
                totalEventos: App.dados?.eventos?.length || 0,
                areas: App.dados?.areas ? Object.keys(App.dados.areas).length : 0
            },
            integracao: {
                agendaExtendida: typeof PersonalAgenda._formatarSemana === 'function',
                tasksExtendido: typeof Tasks.abrirMinhaAgenda === 'function',
                debugDisponivel: typeof PersonalAgenda_Debug !== 'undefined'
            },
            interface: {
                botaoAdicionado: !!document.getElementById('btnMinhaAgenda'),
                estilosCarregados: !!document.getElementById('personalAgendaStyles')
            }
        };
        
        console.table(diagnostico.modulos);
        console.table(diagnostico.dados);
        console.table(diagnostico.integracao);
        console.table(diagnostico.interface);
        
        const problemas = [];
        if (!diagnostico.modulos.PersonalAgenda) problemas.push('PersonalAgenda n√£o carregado');
        if (!diagnostico.dados.estruturaValida) problemas.push('Estrutura de dados inv√°lida');
        if (!diagnostico.integracao.agendaExtendida) problemas.push('Integra√ß√£o incompleta');
        
        if (problemas.length === 0) {
            console.log('‚úÖ Sistema funcionando corretamente!');
        } else {
            console.log('‚ö†Ô∏è Problemas encontrados:', problemas);
        }
        
        return diagnostico;
    }
};

// ‚úÖ FUN√á√ïES GLOBAIS PARA TESTES
window.AgendaTests = AgendaTests;

window.testarAgendaCompleta = () => AgendaTests.executarTodos();
window.diagnosticarAgenda = () => AgendaTests.diagnosticar();
window.testeRapidoAgenda = () => {
    console.log('üß™ ===== TESTE R√ÅPIDO =====');
    const resultados = Object.entries(AgendaTests.testeRapido).map(([nome, teste]) => {
        const passou = teste();
        console.log(passou ? `‚úÖ ${nome}` : `‚ùå ${nome}`);
        return passou;
    });
    
    const sucessos = resultados.filter(r => r).length;
    const total = resultados.length;
    const percentual = Math.round((sucessos / total) * 100);
    
    console.log(`üìä Resultado: ${sucessos}/${total} (${percentual}%)`);
    return { sucessos, total, percentual };
};

// ‚úÖ EXECUTAR TESTE B√ÅSICO NA INICIALIZA√á√ÉO
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        console.log('üß™ Executando teste b√°sico de inicializa√ß√£o...');
        
        const basicTest = {
            personalAgenda: typeof PersonalAgenda !== 'undefined',
            personalDashboard: typeof PersonalDashboard !== 'undefined',
            agendaHelpers: typeof AgendaHelpers !== 'undefined',
            integracaoCompleta: typeof PersonalAgenda._formatarSemana === 'function'
        };
        
        const sucessos = Object.values(basicTest).filter(v => v).length;
        const total = Object.keys(basicTest).length;
        
        if (sucessos === total) {
            console.log('‚úÖ Sistema h√≠brido inicializado com sucesso!');
            console.log('üéØ Para testes completos: testarAgendaCompleta()');
            console.log('üîç Para diagn√≥stico: diagnosticarAgenda()');
        } else {
            console.log('‚ö†Ô∏è Sistema parcialmente carregado');
            console.log('üß™ Execute: diagnosticarAgenda() para detalhes');
        }
    }, 3000);
});

console.log('üß™ Sistema de Testes v6.5.0 carregado!');
console.log('üéØ Comandos dispon√≠veis:');
console.log('   ‚Ä¢ testarAgendaCompleta() - Bateria completa de testes');
console.log('   ‚Ä¢ testeRapidoAgenda() - Teste r√°pido dos m√≥dulos');
console.log('   ‚Ä¢ diagnosticarAgenda() - Diagn√≥stico detalhado');
console.log('   ‚Ä¢ AgendaTests.testarInterface() - Testes de interface');
