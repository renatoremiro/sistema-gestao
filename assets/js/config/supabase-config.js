/**
 * üîê CONFIGURA√á√ÉO SUPABASE SEGURA v2.1
 * 
 * ‚úÖ CREDENCIAIS PROTEGIDAS:
 * - Nunca hardcoded no c√≥digo
 * - Carregamento din√¢mico e seguro
 * - M√∫ltiplas fontes de configura√ß√£o
 * - Valida√ß√£o autom√°tica
 */

// üîê CONFIGURA√á√ÉO SUPABASE SEGURA
class SupabaseConfigSegura {
    constructor() {
        this.config = null;
        this.carregado = false;
        this.fonteConfigura√ß√£o = null;
    }

    // üöÄ M√âTODO PRINCIPAL DE CONFIGURA√á√ÉO
    async configurar() {
        try {
            console.log('üîê Iniciando configura√ß√£o Supabase segura...');
            
            // Tentar m√∫ltiplas fontes em ordem de prioridade
            const fontes = [
                () => this._carregarDoArquivoEnv(),
                () => this._carregarDoMetaTags(),
                () => this._carregarDoPrompt(),
                () => this._mostrarConfiguracaoInterativa()
            ];
            
            for (const fonte of fontes) {
                try {
                    const config = await fonte();
                    if (config && this._validarConfig(config)) {
                        this.config = config;
                        this.carregado = true;
                        console.log(`‚úÖ Configura√ß√£o carregada via: ${this.fonteConfigura√ß√£o}`);
                        return config;
                    }
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Fonte falhou: ${error.message}`);
                }
            }
            
            throw new Error('Nenhuma configura√ß√£o v√°lida encontrada');
            
        } catch (error) {
            console.error('‚ùå Erro na configura√ß√£o segura:', error);
            throw error;
        }
    }

    // üìÅ M√âTODO 1: Arquivo .env ou .env.local
    async _carregarDoArquivoEnv() {
        this.fonteConfigura√ß√£o = 'arquivo .env';
        
        try {
            // Tentar carregar .env.local primeiro (desenvolvimento)
            let response = await fetch('./.env.local');
            if (!response.ok) {
                // Fallback para .env
                response = await fetch('./.env');
            }
            
            if (response.ok) {
                const envText = await response.text();
                const config = this._parseEnvFile(envText);
                
                if (config.url && config.key) {
                    return config;
                }
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Arquivo .env n√£o encontrado ou inacess√≠vel');
        }
        
        return null;
    }

    // üè∑Ô∏è M√âTODO 2: Meta tags no HTML
    async _carregarDoMetaTags() {
        this.fonteConfigura√ß√£o = 'meta tags HTML';
        
        const urlMeta = document.querySelector('meta[name="supabase-url"]');
        const keyMeta = document.querySelector('meta[name="supabase-key"]');
        
        if (urlMeta && keyMeta && urlMeta.content && keyMeta.content) {
            return {
                url: urlMeta.content,
                key: keyMeta.content
            };
        }
        
        return null;
    }

    // üí¨ M√âTODO 3: Prompt interativo (desenvolvimento)
    async _carregarDoPrompt() {
        this.fonteConfigura√ß√£o = 'prompt interativo';
        
        // Apenas em desenvolvimento
        if (location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            return null;
        }
        
        const savedConfig = localStorage.getItem('supabase_dev_config');
        if (savedConfig) {
            try {
                const config = JSON.parse(savedConfig);
                if (this._validarConfig(config)) {
                    console.log('üîß Configura√ß√£o de desenvolvimento recuperada');
                    return config;
                }
            } catch (error) {
                localStorage.removeItem('supabase_dev_config');
            }
        }
        
        return null;
    }

    // üéØ M√âTODO 4: Configura√ß√£o interativa
    async _mostrarConfiguracaoInterativa() {
        this.fonteConfigura√ß√£o = 'configura√ß√£o interativa';
        
        return new Promise((resolve) => {
            // Criar modal de configura√ß√£o
            const modal = this._criarModalConfiguracao((config) => {
                if (this._validarConfig(config)) {
                    // Salvar para desenvolvimento
                    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                        localStorage.setItem('supabase_dev_config', JSON.stringify(config));
                    }
                    resolve(config);
                } else {
                    alert('Configura√ß√£o inv√°lida. Verifique URL e KEY.');
                }
            });
            
            document.body.appendChild(modal);
        });
    }

    // üìù PARSER DE ARQUIVO .env
    _parseEnvFile(envText) {
        const lines = envText.split('\n');
        const config = {};
        
        for (const line of lines) {
            if (line.trim() && !line.startsWith('#')) {
                const [key, ...valueParts] = line.split('=');
                const value = valueParts.join('=').trim().replace(/^["']|["']$/g, '');
                
                if (key === 'SUPABASE_URL') {
                    config.url = value;
                } else if (key === 'SUPABASE_ANON_KEY') {
                    config.key = value;
                }
            }
        }
        
        return config;
    }

    // ‚úÖ VALIDA√á√ÉO DE CONFIGURA√á√ÉO
    _validarConfig(config) {
        if (!config || typeof config !== 'object') {
            return false;
        }
        
        if (!config.url || !config.key) {
            return false;
        }
        
        // Validar formato URL
        if (!config.url.includes('supabase.co') && !config.url.includes('localhost')) {
            console.warn('‚ö†Ô∏è URL do Supabase parece inv√°lida');
            return false;
        }
        
        // Validar formato da key (JWT)
        if (!config.key.startsWith('eyJ') || config.key.length < 100) {
            console.warn('‚ö†Ô∏è Key do Supabase parece inv√°lida');
            return false;
        }
        
        return true;
    }

    // üé® CRIAR MODAL DE CONFIGURA√á√ÉO
    _criarModalConfiguracao(onSalvar) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        
        modal.innerHTML = `
            <div style="
                background: white;
                padding: 30px;
                border-radius: 12px;
                width: 90%;
                max-width: 500px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            ">
                <h2 style="margin: 0 0 20px 0; color: #333;">üîê Configura√ß√£o Supabase</h2>
                <p style="margin: 0 0 20px 0; color: #666;">
                    Para continuar, configure suas credenciais Supabase:
                </p>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                        üåê URL do Projeto:
                    </label>
                    <input type="url" id="supabase-url" placeholder="https://seu-projeto.supabase.co" 
                           style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; box-sizing: border-box;" />
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                        üîë API Key (anon, public):
                    </label>
                    <textarea id="supabase-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." 
                              style="width: 100%; height: 80px; padding: 10px; border: 2px solid #ddd; border-radius: 6px; box-sizing: border-box; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 6px; border-left: 4px solid #0ea5e9;">
                    <h4 style="margin: 0 0 10px 0; color: #0369a1;">üìã Como obter as credenciais:</h4>
                    <ol style="margin: 0; padding-left: 20px; color: #075985;">
                        <li>Acesse <a href="https://supabase.com/dashboard" target="_blank">supabase.com/dashboard</a></li>
                        <li>Selecione seu projeto</li>
                        <li>V√° em <strong>Settings ‚Üí API</strong></li>
                        <li>Copie a <strong>URL</strong> e <strong>anon public key</strong></li>
                    </ol>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="window.location.reload()" style="
                        padding: 10px 20px;
                        border: 2px solid #ddd;
                        background: white;
                        border-radius: 6px;
                        cursor: pointer;
                    ">‚ùå Cancelar</button>
                    <button id="salvar-config" style="
                        padding: 10px 20px;
                        border: none;
                        background: #10b981;
                        color: white;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 600;
                    ">‚úÖ Salvar e Continuar</button>
                </div>
            </div>
        `;
        
        // Event listener para salvar
        modal.querySelector('#salvar-config').addEventListener('click', () => {
            const url = modal.querySelector('#supabase-url').value.trim();
            const key = modal.querySelector('#supabase-key').value.trim();
            
            if (url && key) {
                modal.remove();
                onSalvar({ url, key });
            } else {
                alert('Preencha todos os campos!');
            }
        });
        
        // Foco no primeiro campo
        setTimeout(() => {
            modal.querySelector('#supabase-url').focus();
        }, 100);
        
        return modal;
    }

    // üìä OBTER STATUS
    obterStatus() {
        return {
            carregado: this.carregado,
            fonte: this.fonteConfigura√ß√£o,
            urlConfigurada: !!this.config?.url,
            keyConfigurada: !!this.config?.key,
            seguro: this.carregado && !document.documentElement.innerHTML.includes('eyJ')
        };
    }
}

// üöÄ INST√ÇNCIA GLOBAL
window.supabaseConfigSegura = new SupabaseConfigSegura();

// üîß FUN√á√ÉO GLOBAL DE CONFIGURA√á√ÉO
window.configurarSupabaseSeguro = async () => {
    try {
        const config = await window.supabaseConfigSegura.configurar();
        
        // Definir configura√ß√£o global de forma segura
        window.SUPABASE_CONFIG = config;
        
        console.log('‚úÖ Supabase configurado com seguran√ßa!');
        console.log('üîê Credenciais protegidas e n√£o expostas');
        
        return config;
    } catch (error) {
        console.error('‚ùå Erro na configura√ß√£o segura:', error);
        throw error;
    }
};

console.log('üîê Sistema de Configura√ß√£o Supabase Segura v2.1 carregado!');
console.log('üöÄ Execute: configurarSupabaseSeguro()');

/*
üîê CONFIGURA√á√ÉO SUPABASE SEGURA v2.1

‚úÖ CARACTER√çSTICAS:
- üõ°Ô∏è Credenciais NUNCA hardcoded
- üìÅ M√∫ltiplas fontes (.env, meta tags, prompt)
- ‚úÖ Valida√ß√£o autom√°tica
- üéØ Interface interativa de configura√ß√£o
- üíæ Cache inteligente para desenvolvimento

üöÄ FONTES DE CONFIGURA√á√ÉO (ordem de prioridade):
1. Arquivo .env.local ou .env
2. Meta tags no HTML
3. Prompt interativo (localhost)
4. Modal de configura√ß√£o

üõ°Ô∏è SEGURAN√áA:
- Zero credenciais no c√≥digo fonte
- Valida√ß√£o de formatos
- Cache seguro apenas em localhost
- Interface user-friendly

üéØ USO:
1. Chame configurarSupabaseSeguro()
2. Sistema tentar√° carregar automaticamente
3. Se n√£o encontrar, mostrar√° interface
4. Credenciais ser√£o validadas
5. Sistema ficar√° 100% seguro
*/