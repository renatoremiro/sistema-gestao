// auth.js v8.4.1 - CORRE√á√ÉO PERSIST√äNCIA DEPARTAMENTOS
// M√≥dulo de autentica√ß√£o com carregamento completo do Firebase

const Auth = {
    // Estado do sistema de autentica√ß√£o
    state: {
        usuarioAtual: null,
        isLoggedIn: false,
        equipeCarregadaDoFirebase: false,
        fonteEquipeAtual: 'hardcoded', // 'firebase' | 'hardcoded'
        fonteDepartamentosAtual: 'hardcoded', // 'firebase' | 'hardcoded'
        departamentosCarregadosDoFirebase: false
    },

    // Configura√ß√£o dos paths do Firebase
    config: {
        pathsFirebase: {
            usuarios: 'dados/auth_equipe',
            departamentos: 'dados/departamentos' // ‚Üê NOVO PATH para departamentos
        }
    },

    // ===== CORRE√á√ÉO v8.4.1: DEPARTAMENTOS PERSISTENTES =====
    
    // Departamentos hardcoded como fallback
    departamentosHardcoded: [
        "Gest√£o Geral",
        "Suprimentos", 
        "Qualidade & Produ√ß√£o",
        "Documenta√ß√£o & Arquivo",
        "Planejamento & Controle",
        "Recursos Humanos"
    ],

    // Departamentos em mem√≥ria (carregados do Firebase ou fallback)
    departamentos: [],

    // ===== FUN√á√ÉO NOVA: CARREGAR DEPARTAMENTOS DO FIREBASE =====
    async _carregarDepartamentosDoFirebase() {
        console.log('üè¢ Auth: Carregando departamentos do Firebase...');
        
        try {
            if (!window.database) {
                console.log('‚ùå Firebase n√£o dispon√≠vel - usando departamentos hardcoded');
                this.departamentos = [...this.departamentosHardcoded];
                this.state.fonteDepartamentosAtual = 'hardcoded';
                return false;
            }

            const snapshot = await database.ref(this.config.pathsFirebase.departamentos).once('value');
            const departamentosFirebase = snapshot.val();

            if (departamentosFirebase && Object.keys(departamentosFirebase).length > 0) {
                // Carregar departamentos do Firebase
                this.departamentos = Object.keys(departamentosFirebase);
                this.state.departamentosCarregadosDoFirebase = true;
                this.state.fonteDepartamentosAtual = 'firebase';
                
                console.log(`‚úÖ Auth: ${this.departamentos.length} departamentos carregados do Firebase`);
                console.log('üìã Departamentos:', this.departamentos);
                return true;
                
            } else {
                console.log('‚ö†Ô∏è Nenhum departamento no Firebase - usando hardcoded');
                this.departamentos = [...this.departamentosHardcoded];
                this.state.fonteDepartamentosAtual = 'hardcoded';
                return false;
            }

        } catch (error) {
            console.error('‚ùå Erro ao carregar departamentos do Firebase:', error);
            this.departamentos = [...this.departamentosHardcoded];
            this.state.fonteDepartamentosAtual = 'hardcoded';
            return false;
        }
    },

    // ===== FUN√á√ÉO NOVA: SALVAR DEPARTAMENTOS NO FIREBASE =====
    async salvarDepartamentosNoFirebase(listaDepartamentos) {
        console.log('üíæ Auth: Salvando departamentos no Firebase...');
        
        try {
            if (!window.database) {
                console.log('‚ùå Firebase n√£o dispon√≠vel - n√£o √© poss√≠vel salvar departamentos');
                return false;
            }

            // Converter array de departamentos para objeto Firebase
            const departamentosParaFirebase = {};
            listaDepartamentos.forEach(dept => {
                departamentosParaFirebase[dept] = {
                    nome: dept,
                    ativo: true,
                    criadoEm: new Date().toISOString()
                };
            });

            await database.ref(this.config.pathsFirebase.departamentos).set(departamentosParaFirebase);
            
            // Atualizar estado local
            this.departamentos = [...listaDepartamentos];
            this.state.departamentosCarregadosDoFirebase = true;
            this.state.fonteDepartamentosAtual = 'firebase';
            
            console.log(`‚úÖ ${listaDepartamentos.length} departamentos salvos no Firebase`);
            console.log('üìã Salvos:', listaDepartamentos);
            return true;

        } catch (error) {
            console.error('‚ùå Erro ao salvar departamentos no Firebase:', error);
            return false;
        }
    },

    // ===== MODIFICA√á√ÉO v8.4.1: CARREGAR USU√ÅRIOS + DEPARTAMENTOS =====
    async _carregarEquipeDoFirebase() {
        console.log('üë• Auth: Carregando equipe do Firebase...');
        
        try {
            if (!window.database) {
                console.log('‚ùå Firebase n√£o dispon√≠vel - usando dados hardcoded');
                this._aplicarDadosHardcoded();
                return false;
            }

            const snapshot = await database.ref(this.config.pathsFirebase.usuarios).once('value');
            const usuariosFirebase = snapshot.val();

            if (usuariosFirebase && Object.keys(usuariosFirebase).length > 0) {
                // Carregar usu√°rios do Firebase
                this.equipe = usuariosFirebase;
                this.state.equipeCarregadaDoFirebase = true;
                this.state.fonteEquipeAtual = 'firebase';
                
                console.log(`‚úÖ Auth: ${Object.keys(usuariosFirebase).length} usu√°rios carregados do Firebase`);
                
                // ===== NOVO v8.4.1: CARREGAR DEPARTAMENTOS TAMB√âM =====
                await this._carregarDepartamentosDoFirebase();
                
                return true;
                
            } else {
                console.log('‚ö†Ô∏è Nenhum usu√°rio no Firebase - aplicando dados hardcoded');
                this._aplicarDadosHardcoded();
                return false;
            }

        } catch (error) {
            console.error('‚ùå Erro ao carregar equipe do Firebase:', error);
            this._aplicarDadosHardcoded();
            return false;
        }
    },

    // Aplicar dados hardcoded como fallback
    _aplicarDadosHardcoded() {
        this.equipe = { ...this.equipeHardcoded };
        this.departamentos = [...this.departamentosHardcoded];
        this.state.equipeCarregadaDoFirebase = false;
        this.state.departamentosCarregadosDoFirebase = false;
        this.state.fonteEquipeAtual = 'hardcoded';
        this.state.fonteDepartamentosAtual = 'hardcoded';
        console.log('üì¶ Dados hardcoded aplicados como fallback');
    },

    // ===== RESTO DO C√ìDIGO MANTIDO =====
    
    // Equipe BIAPO hardcoded (fallback)
    equipeHardcoded: {
        renato: {
            id: 'renato',
            nome: 'Renato Remiro',
            email: 'renatoremiro@biapo.com.br',
            cargo: 'Coordenador Geral',
            departamento: 'Gest√£o Geral',
            permissoes: 'admin',
            telefone: '',
            ativo: true
        },
        alex: {
            id: 'alex',
            nome: 'Alex',
            email: 'alex@biapo.com.br',
            cargo: 'Comprador',
            departamento: 'Suprimentos',
            permissoes: 'editor',
            telefone: '',
            ativo: true
        },
        carlos: {
            id: 'carlos',
            nome: 'Carlos Mendon√ßa (Beto)',
            email: 'carlosmendonca@biapo.com.br',
            cargo: 'Coordenador',
            departamento: 'Qualidade & Produ√ß√£o',
            permissoes: 'editor',
            telefone: '',
            ativo: true
        },
        bruna: {
            id: 'bruna',
            nome: 'Bruna Britto',
            email: 'brunabritto@biapo.com.br',
            cargo: 'Arquiteta',
            departamento: 'Documenta√ß√£o & Arquivo',
            permissoes: 'editor',
            telefone: '',
            ativo: true
        },
        eduardo: {
            id: 'eduardo',
            nome: 'Eduardo Santos',
            email: 'eduardosantos@biapo.com.br',
            cargo: 'Coordenador',
            departamento: 'Suprimentos',
            permissoes: 'editor',
            telefone: '',
            ativo: true
        },
        isabella: {
            id: 'isabella',
            nome: 'Isabella',
            email: 'isabella@biapo.com.br',
            cargo: 'Coordenadora Geral',
            departamento: 'Planejamento & Controle',
            permissoes: 'editor',
            telefone: '',
            ativo: true
        },
        jean: {
            id: 'jean',
            nome: 'Jean (Estagi√°rio)',
            email: 'estagio292@biapo.com.br',
            cargo: 'Estagi√°rio de engenharia',
            departamento: 'Qualidade & Produ√ß√£o',
            permissoes: 'editor',
            telefone: '',
            ativo: true
        },
        juliana: {
            id: 'juliana',
            nome: 'Juliana (Rede Interna)',
            email: 'redeinterna.obra3@gmail.com',
            cargo: 'Estagi√°ria de arquitetura',
            departamento: 'Documenta√ß√£o & Arquivo',
            permissoes: 'editor',
            telefone: '',
            ativo: true
        },
        lara: {
            id: 'lara',
            nome: 'Lara Coutinho',
            email: 'laracoutinho@biapo.com.br',
            cargo: 'Arquiteta',
            departamento: 'Planejamento & Controle',
            permissoes: 'editor',
            telefone: '',
            ativo: true
        },
        nayara: {
            id: 'nayara',
            nome: 'Nayara Alencar',
            email: 'nayaraalencar@biapo.com.br',
            cargo: 'Chefe administrativo',
            departamento: 'Recursos Humanos',
            permissoes: 'editor',
            telefone: '',
            ativo: true
        },
        nominato: {
            id: 'nominato',
            nome: 'Nominato Pires',
            email: 'nominatopires@biapo.com.br',
            cargo: 'Almoxarifado',
            departamento: 'Suprimentos',
            permissoes: 'editor',
            telefone: '',
            ativo: true
        }
    },

    // Equipe em mem√≥ria (carregada do Firebase ou hardcoded)
    equipe: {},

    // Inicializa√ß√£o do m√≥dulo auth
    async inicializar() {
        console.log('üöÄ Auth: Inicializando sistema...');
        
        // Carregar dados do Firebase (usu√°rios + departamentos)
        await this._carregarEquipeDoFirebase();
        
        // Verificar se h√° usu√°rio salvo no localStorage
        const usuarioSalvo = localStorage.getItem('usuario_biapo');
        if (usuarioSalvo) {
            const dadosUsuario = JSON.parse(usuarioSalvo);
            this.state.usuarioAtual = dadosUsuario;
            this.state.isLoggedIn = true;
            console.log(`üë§ Auto-login: ${dadosUsuario.nome}`);
        }
        
        console.log('‚úÖ Auth: Sistema inicializado');
        this._exibirStatusCarregamento();
    },

    // Exibir status do carregamento
    _exibirStatusCarregamento() {
        console.log('\nüìä STATUS AUTH v8.4.1:');
        console.log(`   üë• Usu√°rios: ${Object.keys(this.equipe).length} (fonte: ${this.state.fonteEquipeAtual})`);
        console.log(`   üè¢ Departamentos: ${this.departamentos.length} (fonte: ${this.state.fonteDepartamentosAtual})`);
        console.log(`   üîë Logado: ${this.state.isLoggedIn ? this.state.usuarioAtual?.nome : 'N√£o'}`);
        console.log(`   üî• Firebase Usu√°rios: ${this.state.equipeCarregadaDoFirebase ? 'SIM' : 'N√ÉO'}`);
        console.log(`   üî• Firebase Departamentos: ${this.state.departamentosCarregadosDoFirebase ? 'SIM' : 'N√ÉO'}`);
    },

    // Fun√ß√£o de login
    login(nomeUsuario) {
        const usuario = this.equipe[nomeUsuario.toLowerCase()];
        
        if (!usuario) {
            console.log(`‚ùå Usu√°rio '${nomeUsuario}' n√£o encontrado`);
            return false;
        }
        
        if (!usuario.ativo) {
            console.log(`‚ùå Usu√°rio '${nomeUsuario}' est√° inativo`);
            return false;
        }
        
        this.state.usuarioAtual = usuario;
        this.state.isLoggedIn = true;
        
        // Salvar no localStorage
        localStorage.setItem('usuario_biapo', JSON.stringify(usuario));
        
        console.log(`‚úÖ Login realizado: ${usuario.nome}`);
        return true;
    },

    // Fun√ß√£o de logout
    logout() {
        this.state.usuarioAtual = null;
        this.state.isLoggedIn = false;
        localStorage.removeItem('usuario_biapo');
        console.log('üëã Logout realizado');
    },

    // Verificar se usu√°rio pode editar
    podeEditar() {
        return this.state.isLoggedIn && 
               ['admin', 'editor'].includes(this.state.usuarioAtual?.permissoes);
    },

    // Verificar se usu√°rio √© admin
    isAdmin() {
        return this.state.isLoggedIn && 
               this.state.usuarioAtual?.permissoes === 'admin';
    },

    // Obter usu√°rio atual
    getUsuarioAtual() {
        return this.state.usuarioAtual;
    },

    // Verificar se est√° logado
    isLoggedIn() {
        return this.state.isLoggedIn;
    }
};

// ===== FUN√á√ïES GLOBAIS DE DEBUG v8.4.1 =====

// Status completo do sistema auth
function statusAuth() {
    console.log('\nüîç STATUS AUTH v8.4.1 - COMPLETO:');
    console.log('=' .repeat(50));
    console.log(`üîë Logado: ${Auth.state.isLoggedIn ? Auth.state.usuarioAtual.nome : 'N√ÉO'}`);
    console.log(`üë• Usu√°rios: ${Object.keys(Auth.equipe).length}`);
    console.log(`üè¢ Departamentos: ${Auth.departamentos.length}`);
    console.log(`üìä Fonte Usu√°rios: ${Auth.state.fonteEquipeAtual}`);
    console.log(`üìä Fonte Departamentos: ${Auth.state.fonteDepartamentosAtual}`);
    console.log(`üî• Firebase Usu√°rios: ${Auth.state.equipeCarregadaDoFirebase ? 'SIM' : 'N√ÉO'}`);
    console.log(`üî• Firebase Departamentos: ${Auth.state.departamentosCarregadosDoFirebase ? 'SIM' : 'N√ÉO'}`);
    console.log(`‚úÖ Persist√™ncia Usu√°rios: ${Auth.state.fonteEquipeAtual === 'firebase' ? 'FUNCIONANDO' : 'USANDO FALLBACK'}`);
    console.log(`‚úÖ Persist√™ncia Departamentos: ${Auth.state.fonteDepartamentosAtual === 'firebase' ? 'FUNCIONANDO' : 'USANDO FALLBACK'}`);
    
    if (Auth.departamentos.length > 6) {
        console.log('üéØ DEPARTAMENTOS CUSTOMIZADOS DETECTADOS:');
        Auth.departamentos.forEach((dept, i) => {
            if (i >= 6) console.log(`   + ${dept}`);
        });
    }
}

// Recarregar departamentos do Firebase
async function recarregarDepartamentosFirebase() {
    console.log('üîÑ Recarregando departamentos do Firebase...');
    const sucesso = await Auth._carregarDepartamentosDoFirebase();
    if (sucesso) {
        console.log('‚úÖ Departamentos recarregados com sucesso');
    } else {
        console.log('‚ö†Ô∏è Usando departamentos hardcoded');
    }
    return sucesso;
}

// Listar departamentos atuais
function departamentosAtuais() {
    console.log('\nüè¢ DEPARTAMENTOS ATUAIS:');
    console.log(`üìä Fonte: ${Auth.state.fonteDepartamentosAtual}`);
    console.log(`üìã Total: ${Auth.departamentos.length}`);
    Auth.departamentos.forEach((dept, i) => {
        console.log(`   ${i + 1}. ${dept}`);
    });
}

// Teste completo de persist√™ncia v8.4.1
async function testarPersistenciaDepartamentos() {
    console.log('\nüß™ TESTE PERSIST√äNCIA DEPARTAMENTOS v8.4.1');
    console.log('=' .repeat(60));
    
    // 1. Salvar departamentos de teste
    const deptsTeste = [
        ...Auth.departamentosHardcoded,
        'Departamento Teste 1',
        'Departamento Teste 2'
    ];
    
    console.log('1Ô∏è‚É£ Salvando departamentos de teste...');
    const salvoSucesso = await Auth.salvarDepartamentosNoFirebase(deptsTeste);
    console.log(`   ${salvoSucesso ? '‚úÖ' : '‚ùå'} Salvamento: ${salvoSucesso ? 'SUCESSO' : 'FALHOU'}`);
    
    // 2. Recarregar do Firebase
    console.log('2Ô∏è‚É£ Recarregando do Firebase...');
    const carregadoSucesso = await Auth._carregarDepartamentosDoFirebase();
    console.log(`   ${carregadoSucesso ? '‚úÖ' : '‚ùå'} Carregamento: ${carregadoSucesso ? 'SUCESSO' : 'FALHOU'}`);
    
    // 3. Verificar persist√™ncia
    console.log('3Ô∏è‚É£ Verificando persist√™ncia...');
    const temDeptsTeste = Auth.departamentos.includes('Departamento Teste 1');
    console.log(`   ${temDeptsTeste ? '‚úÖ' : '‚ùå'} Departamentos persistiram: ${temDeptsTeste ? 'SIM' : 'N√ÉO'}`);
    
    console.log('\nüìä RESULTADO FINAL:');
    console.log(`   Departamentos: ${Auth.departamentos.length}`);
    console.log(`   Fonte: ${Auth.state.fonteDepartamentosAtual}`);
    console.log(`   Status: ${salvoSucesso && carregadoSucesso && temDeptsTeste ? '‚úÖ FUNCIONANDO' : '‚ùå PROBLEMA'}`);
}

// Inicializar quando DOM estiver pronto
if (typeof document !== 'undefined') {
    document.addEventListener('DOMContentLoaded', () => {
        Auth.inicializar();
    });
}

// ===== COMENT√ÅRIOS v8.4.1 =====
/*
CORRE√á√ïES APLICADAS v8.4.1:

1. ‚úÖ NOVO PATH: dados/departamentos para salvar departamentos
2. ‚úÖ NOVA FUN√á√ÉO: _carregarDepartamentosDoFirebase()
3. ‚úÖ NOVA FUN√á√ÉO: salvarDepartamentosNoFirebase()
4. ‚úÖ MODIFICADA: _carregarEquipeDoFirebase() agora carrega departamentos tamb√©m
5. ‚úÖ NOVO ESTADO: departamentosCarregadosDoFirebase e fonteDepartamentosAtual
6. ‚úÖ NOVOS COMANDOS: departamentosAtuais(), testarPersistenciaDepartamentos()

FLUXO CORRIGIDO:
AdminUsersManager ‚Üí salva usu√°rios em dados/auth_equipe
AdminUsersManager ‚Üí salva departamentos em dados/departamentos (NOVO)
auth.js ‚Üí carrega usu√°rios de dados/auth_equipe
auth.js ‚Üí carrega departamentos de dados/departamentos (NOVO)

RESULTADO: Usu√°rios E departamentos persistem ap√≥s F5! ‚úÖ
*/
