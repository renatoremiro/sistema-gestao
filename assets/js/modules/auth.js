/* ========== üîê AUTH SIMPLES BIAPO v8.1 - INTEGRA√á√ÉO APP v8.0 ========== */

const Auth = {
    // ‚úÖ VERS√ÉO SIMPLES INTEGRADA COM APP v8.0
    config: {
        versao: '8.1.0',
        autoLogin: true,
        lembrarUsuario: true,
        integracaoApp: true // NOVA: Integra√ß√£o com App v8.0
    },

    // üë• EQUIPE BIAPO - LOGIN POR PRIMEIRO NOME
    equipeBiapo: {
        "renato": {
            nomeCompleto: "Renato Remiro",
            email: "renatoremiro@biapo.com.br",
            admin: true,
            ativo: true
        },
        "bruna": {
            nomeCompleto: "Bruna Britto",
            email: "brunabritto@biapo.com.br", 
            admin: false,
            ativo: true
        },
        "lara": {
            nomeCompleto: "Lara Coutinho",
            email: "laracoutinho@biapo.com.br",
            admin: false,
            ativo: true
        },
        "isabella": {
            nomeCompleto: "Isabella",
            email: "isabella@biapo.com.br",
            admin: false,
            ativo: true
        },
        "eduardo": {
            nomeCompleto: "Eduardo Santos",
            email: "eduardosantos@biapo.com.br",
            admin: false,
            ativo: true
        },
        "carlos": {
            nomeCompleto: "Carlos Mendon√ßa (Beto)",
            email: "carlosmendonca@biapo.com.br",
            admin: false,
            ativo: true
        },
        "beto": { // Alternativa para Carlos
            nomeCompleto: "Carlos Mendon√ßa (Beto)",
            email: "carlosmendonca@biapo.com.br",
            admin: false,
            ativo: true
        },
        "alex": {
            nomeCompleto: "Alex",
            email: "alex@biapo.com.br",
            admin: false,
            ativo: true
        },
        "nominato": {
            nomeCompleto: "Nominato Pires",
            email: "nominatopires@biapo.com.br",
            admin: false,
            ativo: true
        },
        "nayara": {
            nomeCompleto: "Nayara Alencar",
            email: "nayaraalencar@biapo.com.br",
            admin: false,
            ativo: true
        },
        "jean": {
            nomeCompleto: "Jean (Estagi√°rio)",
            email: "estagio292@biapo.com.br",
            admin: false,
            ativo: true
        },
        "juliana": {
            nomeCompleto: "Juliana (Rede Interna)",
            email: "redeinterna.obra3@gmail.com",
            admin: false,
            ativo: true
        }
    },

    // ‚úÖ ESTADO ATUAL
    state: {
        usuarioAtual: null,
        logado: false
    },

    // ‚úÖ PROPRIEDADE COMPAT√çVEL COM SISTEMA ATUAL
    get usuario() {
        return this.state.usuarioAtual;
    },

    set usuario(valor) {
        this.state.usuarioAtual = valor;
        this.state.logado = !!valor;
    },

    // üîê LOGIN SIMPLES COM INTEGRA√á√ÉO APP v8.0
    login(nomeUsuario) {
        try {
            const nome = nomeUsuario.toLowerCase().trim();
            
            if (!nome) {
                this._mostrarMensagem('Digite seu nome', 'warning');
                return false;
            }

            const dadosUsuario = this.equipeBiapo[nome];
            
            if (!dadosUsuario) {
                this._mostrarMensagem(`"${nomeUsuario}" n√£o encontrado na equipe BIAPO`, 'error');
                return false;
            }

            if (!dadosUsuario.ativo) {
                this._mostrarMensagem('Usu√°rio inativo', 'error');
                return false;
            }

            // Criar objeto de usu√°rio compat√≠vel com App v8.0
            this.usuario = {
                email: dadosUsuario.email,
                displayName: dadosUsuario.nomeCompleto,
                uid: `biapo_${nome}`,
                nome: dadosUsuario.nomeCompleto,
                primeiroNome: nome,
                admin: dadosUsuario.admin,
                ativo: dadosUsuario.ativo
            };

            // üî• INTEGRA√á√ÉO COM APP v8.0
            this._integrarComApp();

            // Salvar prefer√™ncia
            if (this.config.lembrarUsuario) {
                localStorage.setItem('ultimoUsuarioBiapo', nome);
            }

            this._mostrarMensagem(`Bem-vindo, ${dadosUsuario.nomeCompleto}! üëã`, 'success');
            
            // Esconder tela de login
            setTimeout(() => {
                this._esconderTelaLogin();
                this._executarCallbacksLogin();
            }, 1000);

            return true;

        } catch (error) {
            console.error('‚ùå Erro no login:', error);
            this._mostrarMensagem('Erro no login', 'error');
            return false;
        }
    },

    // üî• NOVA: INTEGRA√á√ÉO COM APP v8.0
    _integrarComApp() {
        if (typeof App !== 'undefined') {
            // Atualizar App global
            App.usuarioAtual = this.usuario;
            App.estadoSistema = App.estadoSistema || {};
            App.estadoSistema.usuarioAutenticado = true;
            App.estadoSistema.usuarioEmail = this.usuario.email;
            App.estadoSistema.usuarioNome = this.usuario.displayName;
            
            console.log(`üîó Usu√°rio integrado com App v8.0: ${this.usuario.displayName}`);
        }
    },

    // üö™ LOGOUT SIMPLES COM INTEGRA√á√ÉO APP v8.0
    logout() {
        try {
            const nomeAnterior = this.usuario?.displayName;
            
            this.usuario = null;
            
            // üî• LIMPAR APP v8.0
            if (typeof App !== 'undefined') {
                App.usuarioAtual = null;
                App.estadoSistema = App.estadoSistema || {};
                App.estadoSistema.usuarioAutenticado = false;
                App.estadoSistema.usuarioEmail = null;
                App.estadoSistema.usuarioNome = null;
            }

            this._mostrarMensagem(`At√© logo, ${nomeAnterior}! üëã`, 'info');
            
            // Mostrar tela de login
            setTimeout(() => {
                this._mostrarTelaLogin();
            }, 1000);

            return true;

        } catch (error) {
            console.error('‚ùå Erro no logout:', error);
            return false;
        }
    },

    // üîÑ AUTO-LOGIN COM INTEGRA√á√ÉO
    autoLogin() {
        try {
            if (!this.config.autoLogin || this.state.logado) {
                return false;
            }

            const ultimoUsuario = localStorage.getItem('ultimoUsuarioBiapo');
            
            if (ultimoUsuario && this.equipeBiapo[ultimoUsuario]) {
                console.log(`üîÑ Auto-login: ${ultimoUsuario}`);
                return this.login(ultimoUsuario);
            }

            return false;

        } catch (error) {
            console.error('‚ùå Erro no auto-login:', error);
            return false;
        }
    },

    // üìã LISTAR EQUIPE DISPON√çVEL
    listarEquipe() {
        const equipe = Object.entries(this.equipeBiapo)
            .filter(([_, dados]) => dados.ativo)
            .map(([nome, dados]) => ({
                login: nome,
                nome: dados.nomeCompleto,
                email: dados.email,
                admin: dados.admin
            }));

        console.log('üë• Equipe BIAPO dispon√≠vel:');
        console.table(equipe);
        
        return equipe;
    },

    // ‚úÖ VERIFICA√á√ïES
    estaLogado() {
        return this.state.logado && !!this.usuario;
    },

    ehAdmin() {
        return this.usuario?.admin || false;
    },

    // üîß CRIAR INTERFACE DE LOGIN SIMPLES
    criarInterfaceLogin() {
        // Remover interface existente
        const loginExistente = document.getElementById('loginSimplesBiapo');
        if (loginExistente) {
            loginExistente.remove();
        }

        const loginDiv = document.createElement('div');
        loginDiv.id = 'loginSimplesBiapo';
        loginDiv.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999999;
        `;

        loginDiv.innerHTML = `
            <div style="
                background: white;
                padding: 48px;
                border-radius: 16px;
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
                text-align: center;
                max-width: 400px;
                width: 90%;
            ">
                <div style="margin-bottom: 32px;">
                    <h2 style="
                        color: #1f2937;
                        margin: 0 0 8px 0;
                        font-size: 28px;
                        font-weight: 700;
                    ">üèóÔ∏è Sistema BIAPO</h2>
                    <p style="
                        color: #6b7280;
                        margin: 0;
                        font-size: 16px;
                    ">Gest√£o de Eventos - Obra 292</p>
                </div>

                <div style="margin-bottom: 24px;">
                    <label style="
                        display: block;
                        margin-bottom: 8px;
                        color: #374151;
                        font-weight: 600;
                        text-align: left;
                    ">üë§ Digite seu primeiro nome:</label>
                    
                    <input 
                        type="text" 
                        id="inputNomeUsuario" 
                        placeholder="Ex: renato, bruna, lara..."
                        style="
                            width: 100%;
                            padding: 16px;
                            border: 2px solid #e5e7eb;
                            border-radius: 8px;
                            font-size: 16px;
                            text-align: center;
                            box-sizing: border-box;
                            transition: border-color 0.2s;
                        "
                        onkeydown="if(event.key==='Enter') Auth.tentarLogin()"
                        onfocus="this.style.borderColor='#C53030'"
                        onblur="this.style.borderColor='#e5e7eb'"
                    >
                </div>

                <button 
                    onclick="Auth.tentarLogin()" 
                    style="
                        width: 100%;
                        background: linear-gradient(135deg, #C53030 0%, #9B2C2C 100%);
                        color: white;
                        border: none;
                        padding: 16px;
                        border-radius: 8px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: transform 0.2s;
                    "
                    onmouseover="this.style.transform='translateY(-2px)'"
                    onmouseout="this.style.transform='translateY(0)'"
                >
                    üîê Entrar
                </button>

                <div style="margin-top: 24px;">
                    <p style="
                        color: #6b7280;
                        font-size: 14px;
                        margin: 0 0 12px 0;
                    ">Equipe dispon√≠vel:</p>
                    
                    <div style="
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 8px;
                        font-size: 12px;
                        color: #374151;
                    ">
                        <span onclick="Auth.preencherNome('renato')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">renato</span>
                        <span onclick="Auth.preencherNome('bruna')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">bruna</span>
                        <span onclick="Auth.preencherNome('lara')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">lara</span>
                        <span onclick="Auth.preencherNome('isabella')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">isabella</span>
                        <span onclick="Auth.preencherNome('eduardo')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">eduardo</span>
                        <span onclick="Auth.preencherNome('carlos')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">carlos</span>
                        <span onclick="Auth.preencherNome('alex')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">alex</span>
                        <span onclick="Auth.preencherNome('nominato')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">nominato</span>
                        <span onclick="Auth.preencherNome('nayara')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">nayara</span>
                        <span onclick="Auth.preencherNome('jean')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">jean</span>
                        <span onclick="Auth.preencherNome('juliana')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">juliana</span>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(loginDiv);
        
        // Focar no input
        setTimeout(() => {
            const input = document.getElementById('inputNomeUsuario');
            if (input) input.focus();
        }, 100);

        return loginDiv;
    },

    // üîß M√âTODO AUXILIAR PARA INTERFACE
    tentarLogin() {
        const input = document.getElementById('inputNomeUsuario');
        if (input) {
            const nome = input.value.trim();
            if (nome) {
                this.login(nome);
            } else {
                this._mostrarMensagem('Digite seu nome', 'warning');
            }
        }
    },

    preencherNome(nome) {
        const input = document.getElementById('inputNomeUsuario');
        if (input) {
            input.value = nome;
            input.focus();
        }
    },

    // üéØ M√âTODOS AUXILIARES COM INTEGRA√á√ÉO APP v8.0
    _mostrarTelaLogin() {
        // Esconder sistema principal
        const mainContainer = document.getElementById('mainContainer');
        if (mainContainer) {
            mainContainer.classList.add('hidden');
            mainContainer.style.display = 'none';
            console.log("‚úÖ Sistema principal escondido");
        }
        
        // Mostrar interface de login
        this.criarInterfaceLogin();
        console.log("‚úÖ Tela de login exibida");
    },

    _esconderTelaLogin() {
        // Remover interface de login
        const loginDiv = document.getElementById('loginSimplesBiapo');
        if (loginDiv) {
            loginDiv.remove();
        }
        
        // Mostrar sistema principal - CORRE√á√ÉO DEFINITIVA COM APP v8.0
        const mainContainer = document.getElementById('mainContainer');
        if (mainContainer) {
            mainContainer.classList.remove('hidden');
            mainContainer.style.display = 'block';
            console.log("‚úÖ Sistema principal exibido");
        }
        
        // üî• INICIALIZAR APP SE NECESS√ÅRIO
        setTimeout(() => {
            if (typeof App !== 'undefined') {
                try {
                    // Verificar se App precisa ser inicializado
                    if (!App.estadoSistema.inicializado) {
                        console.log("üöÄ Inicializando App ap√≥s login...");
                        App.inicializar();
                    }
                    
                    // Atualizar interface com usu√°rio
                    if (document.getElementById('usuarioLogado')) {
                        document.getElementById('usuarioLogado').textContent = `üë§ ${this.usuario.displayName}`;
                    }
                    
                    console.log("‚úÖ Sistema totalmente inicializado ap√≥s login");
                } catch (error) {
                    console.warn("‚ö†Ô∏è Erro na inicializa√ß√£o p√≥s-login:", error);
                }
            }
        }, 200);
    },

    _executarCallbacksLogin() {
        // Executar callbacks adicionais se necess√°rio
        setTimeout(() => {
            // Atualizar calend√°rio se existir
            if (typeof Calendar !== 'undefined' && Calendar.atualizarEventos) {
                Calendar.atualizarEventos();
            }
            
            // Disparar evento customizado de login
            if (typeof window !== 'undefined') {
                window.dispatchEvent(new CustomEvent('biapo-login', {
                    detail: { usuario: this.usuario }
                }));
            }
        }, 500);
    },

    _mostrarMensagem(mensagem, tipo = 'info') {
        // Usar Notifications se dispon√≠vel
        if (typeof Notifications !== 'undefined') {
            switch (tipo) {
                case 'success': 
                    if (Notifications.success) Notifications.success(mensagem);
                    break;
                case 'error': 
                    if (Notifications.error) Notifications.error(mensagem);
                    break;
                case 'warning': 
                    if (Notifications.warning) Notifications.warning(mensagem);
                    break;
                default: 
                    if (Notifications.info) Notifications.info(mensagem);
            }
        } else {
            // Fallback para console
            console.log(`${tipo.toUpperCase()}: ${mensagem}`);
            
            // Fallback para alert se for erro
            if (tipo === 'error') {
                alert(`‚ùå ${mensagem}`);
            }
        }
    },

    // üìä STATUS E DEBUG
    obterStatus() {
        return {
            versao: this.config.versao,
            logado: this.state.logado,
            usuario: this.usuario?.displayName || null,
            email: this.usuario?.email || null,
            primeiroNome: this.usuario?.primeiroNome || null,
            admin: this.ehAdmin(),
            totalEquipe: Object.keys(this.equipeBiapo).length,
            equipeBiapoCarregada: true,
            integracaoApp: this.config.integracaoApp,
            appDisponivel: typeof App !== 'undefined'
        };
    },

    debug() {
        const info = this.obterStatus();
        console.log('üîê Auth Simples BIAPO - Status:', info);
        console.log('üë• Equipe:', this.listarEquipe());
        
        // Debug adicional da interface
        console.log('üñ•Ô∏è Interface:', {
            loginDiv: !!document.getElementById('loginSimplesBiapo'),
            mainContainer: !!document.getElementById('mainContainer'),
            mainContainerVisible: document.getElementById('mainContainer')?.style.display !== 'none'
        });
        
        return info;
    },

    // üîß FUN√á√ÉO DE CORRE√á√ÉO MANUAL
    corrigirInterface() {
        console.log('üîß Corrigindo interface manualmente...');
        
        if (this.state.logado) {
            this._esconderTelaLogin();
        } else {
            this._mostrarTelaLogin();
        }
        
        console.log('‚úÖ Interface corrigida');
    },

    // üÜò FUN√á√ÉO DE EMERG√äNCIA PARA JANELA AN√îNIMA
    emergencia() {
        console.log('üÜò Modo emerg√™ncia ativado!');
        
        // Limpar qualquer estado confuso
        this.state.logado = false;
        this.state.usuarioAtual = null;
        
        // For√ßar exibi√ß√£o do login
        this._mostrarTelaLogin();
        
        // Esconder sistema principal
        const mainContainer = document.getElementById('mainContainer');
        if (mainContainer) {
            mainContainer.style.display = 'none';
            mainContainer.classList.add('hidden');
        }
        
        console.log('‚úÖ Modo emerg√™ncia aplicado - tela de login deve aparecer');
    },

    // üöÄ INICIALIZA√á√ÉO ROBUSTA PARA JANELA AN√îNIMA
    init() {
        console.log('üîê Inicializando Auth Simples BIAPO v8.1...');
        
        // üî• ESCONDER SISTEMA DE LOGIN ANTIGO
        this._esconderLoginAntigo();
        
        // üî• VERIFICAR SE √â INICIALIZA√á√ÉO FRIA (janela an√¥nima)
        const inicializacaoFria = !localStorage.getItem('ultimoUsuarioBiapo');
        
        if (inicializacaoFria) {
            console.log('‚ùÑÔ∏è Inicializa√ß√£o fria detectada - for√ßando login');
            // Para janela an√¥nima, sempre mostrar login
            setTimeout(() => {
                this._mostrarTelaLogin();
            }, 100);
        } else {
            // Tentar auto-login para usu√°rios conhecidos
            const autoLoginSucesso = this.autoLogin();
            
            if (!autoLoginSucesso) {
                // Se n√£o conseguiu auto-login, mostrar tela de login
                setTimeout(() => {
                    this._mostrarTelaLogin();
                }, 100);
            } else {
                console.log('‚úÖ Auto-login realizado com sucesso');
            }
        }
        
        console.log('‚úÖ Auth Simples BIAPO v8.1 inicializado');
    },

    // üî• ESCONDER SISTEMA DE LOGIN ANTIGO
    _esconderLoginAntigo() {
        // Esconder poss√≠veis telas de login antigas
        const loginScreens = [
            '#loginScreen',
            '.login-screen', 
            '.auth-screen',
            '#authContainer',
            '.modal-login'
        ];
        
        loginScreens.forEach(selector => {
            const elemento = document.querySelector(selector);
            if (elemento) {
                elemento.style.display = 'none';
                console.log(`üö´ Escondido login antigo: ${selector}`);
            }
        });
        
        // For√ßar esconder qualquer modal de auth ativo
        const modals = document.querySelectorAll('.modal, [id*="login"], [id*="auth"]');
        modals.forEach(modal => {
            if (modal.id !== 'loginSimplesBiapo') {
                modal.style.display = 'none';
            }
        });
    }
};

// ‚úÖ EXPOSI√á√ÉO GLOBAL
window.Auth = Auth;

// üöÄ AUTO-INICIALIZA√á√ÉO ROBUSTA PARA JANELA AN√îNIMA
document.addEventListener('DOMContentLoaded', () => {
    console.log('üìÑ DOM carregado - iniciando Auth...');
    
    // M√∫ltiplas tentativas de inicializa√ß√£o para garantir
    const tentarInicializar = () => {
        try {
            if (typeof Auth !== 'undefined') {
                Auth.init();
                return true;
            }
            return false;
        } catch (error) {
            console.warn('‚ö†Ô∏è Erro na inicializa√ß√£o Auth:', error);
            return false;
        }
    };
    
    // Primeira tentativa imediata
    if (!tentarInicializar()) {
        // Segunda tentativa ap√≥s 300ms
        setTimeout(() => {
            if (!tentarInicializar()) {
                // Terceira tentativa ap√≥s 600ms  
                setTimeout(() => {
                    if (!tentarInicializar()) {
                        // Quarta tentativa for√ßada ap√≥s 1000ms
                        setTimeout(() => {
                            console.warn('‚ö†Ô∏è Auth n√£o inicializou - for√ßando manualmente');
                            if (typeof Auth !== 'undefined') {
                                Auth._mostrarTelaLogin();
                            } else {
                                console.error('‚ùå Auth.js n√£o carregou corretamente');
                            }
                        }, 1000);
                    }
                }, 600);
            }
        }, 300);
    }
});

// üîß FALLBACK PARA WINDOW LOAD (garante que tudo carregou)
window.addEventListener('load', () => {
    setTimeout(() => {
        // Verificar se login est√° vis√≠vel
        const loginDiv = document.getElementById('loginSimplesBiapo');
        const mainContainer = document.getElementById('mainContainer');
        
        if (!loginDiv && (!Auth?.state?.logado)) {
            console.log('üîß Fallback: for√ßando login na window.load');
            if (typeof Auth !== 'undefined') {
                Auth._mostrarTelaLogin();
            }
        }
        
        // Garantir que main container est√° configurado corretamente
        if (mainContainer && !Auth?.state?.logado) {
            mainContainer.style.display = 'none';
            mainContainer.classList.add('hidden');
        }
    }, 500);
});

// üìä COMANDOS √öTEIS NO CONSOLE
window.loginBiapo = (nome) => Auth.login(nome);
window.logoutBiapo = () => Auth.logout();
window.statusAuth = () => Auth.debug();
window.equipeBiapo = () => Auth.listarEquipe();
window.corrigirInterface = () => Auth.corrigirInterface();
window.emergenciaAuth = () => Auth.emergencia(); // NOVO: Para janela an√¥nima

console.log('üîê Auth Simples BIAPO v8.1 - INTEGRA√á√ÉO APP v8.0 + CORRE√á√ÉO JANELA AN√îNIMA carregado!');

/*
‚úÖ SISTEMA AUTH SIMPLES v8.1 - INTEGRA√á√ÉO COMPLETA COM APP v8.0:

üéØ FUNCIONALIDADES:
- ‚úÖ Login apenas com primeiro nome (sem senha)
- ‚úÖ Equipe BIAPO completa (11 pessoas) 
- ‚úÖ Interface visual simples e bonita
- ‚úÖ Auto-login (lembra √∫ltimo usu√°rio)
- ‚úÖ INTEGRA√á√ÉO TOTAL com App v8.0
- ‚úÖ Admin para Renato Remiro
- ‚úÖ Compatibilidade com sistema atual

üîó INTEGRA√á√ÉO APP v8.0:
- ‚úÖ App.usuarioAtual sincronizado
- ‚úÖ App.estadoSistema atualizado
- ‚úÖ Inicializa√ß√£o autom√°tica do App ap√≥s login
- ‚úÖ Interface de usu√°rio atualizada
- ‚úÖ Callbacks e eventos customizados

üë• EQUIPE DISPON√çVEL:
renato, bruna, lara, isabella, eduardo, carlos/beto, 
alex, nominato, nayara, jean, juliana

üîß COMANDOS √öTEIS:
loginBiapo('renato')  - Fazer login
logoutBiapo()         - Fazer logout  
statusAuth()          - Ver status
equipeBiapo()         - Listar equipe
corrigirInterface()   - Corrigir interface manualmente
emergenciaAuth()      - EMERG√äNCIA: for√ßar login (janela an√¥nima)

üöÄ RESULTADO:
- Sistema pronto para usar ‚úÖ
- Login super simples ‚úÖ
- Integra√ß√£o total com App v8.0 ‚úÖ
- Funciona em janela an√¥nima ‚úÖ
- M√∫ltiplas tentativas de inicializa√ß√£o ‚úÖ
- Fun√ß√£o de emerg√™ncia inclu√≠da ‚úÖ
- Zero complexidade ‚úÖ
- Totalmente funcional ‚úÖ
*/

    // üë• EQUIPE BIAPO - LOGIN POR PRIMEIRO NOME
    equipeBiapo: {
        "renato": {
            nomeCompleto: "Renato Remiro",
            admin: true,
            ativo: true
        },
        "bruna": {
            nomeCompleto: "Bruna Britto",
            admin: false,
            ativo: true
        },
        "lara": {
            nomeCompleto: "Lara Coutinho",
            admin: false,
            ativo: true
        },
        "isabella": {
            nomeCompleto: "Isabella",
            admin: false,
            ativo: true
        },
        "eduardo": {
            nomeCompleto: "Eduardo Santos",
            admin: false,
            ativo: true
        },
        "carlos": {
            nomeCompleto: "Carlos Mendon√ßa (Beto)",
            admin: false,
            ativo: true
        },
        "beto": { // Alternativa para Carlos
            nomeCompleto: "Carlos Mendon√ßa (Beto)",
            admin: false,
            ativo: true
        },
        "alex": {
            nomeCompleto: "Alex",
            admin: false,
            ativo: true
        },
        "nominato": {
            nomeCompleto: "Nominato Pires",
            admin: false,
            ativo: true
        },
        "nayara": {
            nomeCompleto: "Nayara Alencar",
            admin: false,
            ativo: true
        },
        "jean": {
            nomeCompleto: "Jean (Estagi√°rio)",
            admin: false,
            ativo: true
        },
        "juliana": {
            nomeCompleto: "Juliana (Rede Interna)",
            admin: false,
            ativo: true
        }
    },

    // ‚úÖ ESTADO ATUAL
    state: {
        usuarioAtual: null,
        logado: false
    },

    // ‚úÖ PROPRIEDADE COMPAT√çVEL COM SISTEMA ATUAL
    get usuario() {
        return this.state.usuarioAtual;
    },

    set usuario(valor) {
        this.state.usuarioAtual = valor;
        this.state.logado = !!valor;
    },

    // üîê LOGIN SIMPLES
    login(nomeUsuario) {
        try {
            const nome = nomeUsuario.toLowerCase().trim();
            
            if (!nome) {
                this._mostrarMensagem('Digite seu nome', 'warning');
                return false;
            }

            const dadosUsuario = this.equipeBiapo[nome];
            
            if (!dadosUsuario) {
                this._mostrarMensagem(`"${nomeUsuario}" n√£o encontrado na equipe BIAPO`, 'error');
                return false;
            }

            if (!dadosUsuario.ativo) {
                this._mostrarMensagem('Usu√°rio inativo', 'error');
                return false;
            }

            // Criar objeto de usu√°rio compat√≠vel
            this.usuario = {
                email: `${nome}@biapo.com.br`,
                displayName: dadosUsuario.nomeCompleto,
                uid: `biapo_${nome}`,
                nome: dadosUsuario.nomeCompleto,
                primeiroNome: nome,
                admin: dadosUsuario.admin,
                ativo: dadosUsuario.ativo
            };

            // Salvar prefer√™ncia
            if (this.config.lembrarUsuario) {
                localStorage.setItem('ultimoUsuarioBiapo', nome);
            }

            // Atualizar App global
            if (typeof App !== 'undefined') {
                App.usuarioAtual = this.usuario;
                App.estadoSistema = App.estadoSistema || {};
                App.estadoSistema.usuarioEmail = this.usuario.email;
                App.estadoSistema.usuarioNome = this.usuario.displayName;
            }

            this._mostrarMensagem(`Bem-vindo, ${dadosUsuario.nomeCompleto}! üëã`, 'success');
            
            // Esconder tela de login se existir
            setTimeout(() => {
                this._esconderTelaLogin();
                this._executarCallbacksLogin();
            }, 1000);

            return true;

        } catch (error) {
            console.error('‚ùå Erro no login:', error);
            this._mostrarMensagem('Erro no login', 'error');
            return false;
        }
    },

    // üö™ LOGOUT SIMPLES
    logout() {
        try {
            const nomeAnterior = this.usuario?.displayName;
            
            this.usuario = null;
            
            // Limpar App global
            if (typeof App !== 'undefined') {
                App.usuarioAtual = null;
                App.estadoSistema = App.estadoSistema || {};
                App.estadoSistema.usuarioEmail = null;
                App.estadoSistema.usuarioNome = null;
            }

            this._mostrarMensagem(`At√© logo, ${nomeAnterior}! üëã`, 'info');
            
            // Mostrar tela de login se existir
            setTimeout(() => {
                this._mostrarTelaLogin();
            }, 1000);

            return true;

        } catch (error) {
            console.error('‚ùå Erro no logout:', error);
            return false;
        }
    },

    // üîÑ AUTO-LOGIN (se lembrar usu√°rio)
    autoLogin() {
        try {
            if (!this.config.autoLogin || this.state.logado) {
                return false;
            }

            const ultimoUsuario = localStorage.getItem('ultimoUsuarioBiapo');
            
            if (ultimoUsuario && this.equipeBiapo[ultimoUsuario]) {
                console.log(`üîÑ Auto-login: ${ultimoUsuario}`);
                return this.login(ultimoUsuario);
            }

            return false;

        } catch (error) {
            console.error('‚ùå Erro no auto-login:', error);
            return false;
        }
    },

    // üìã LISTAR EQUIPE DISPON√çVEL
    listarEquipe() {
        const equipe = Object.entries(this.equipeBiapo)
            .filter(([_, dados]) => dados.ativo)
            .map(([nome, dados]) => ({
                login: nome,
                nome: dados.nomeCompleto,
                admin: dados.admin
            }));

        console.log('üë• Equipe BIAPO dispon√≠vel:');
        console.table(equipe);
        
        return equipe;
    },

    // ‚úÖ VERIFICA√á√ïES
    estaLogado() {
        return this.state.logado && !!this.usuario;
    },

    ehAdmin() {
        return this.usuario?.admin || false;
    },

    // üîß CRIAR INTERFACE DE LOGIN SIMPLES
    criarInterfaceLogin() {
        // Remover interface existente
        const loginExistente = document.getElementById('loginSimplesBiapo');
        if (loginExistente) {
            loginExistente.remove();
        }

        const loginDiv = document.createElement('div');
        loginDiv.id = 'loginSimplesBiapo';
        loginDiv.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999999;
        `;

        loginDiv.innerHTML = `
            <div style="
                background: white;
                padding: 48px;
                border-radius: 16px;
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
                text-align: center;
                max-width: 400px;
                width: 90%;
            ">
                <div style="margin-bottom: 32px;">
                    <h2 style="
                        color: #1f2937;
                        margin: 0 0 8px 0;
                        font-size: 28px;
                        font-weight: 700;
                    ">üèóÔ∏è Sistema BIAPO</h2>
                    <p style="
                        color: #6b7280;
                        margin: 0;
                        font-size: 16px;
                    ">Gest√£o de Eventos - Obra 292</p>
                </div>

                <div style="margin-bottom: 24px;">
                    <label style="
                        display: block;
                        margin-bottom: 8px;
                        color: #374151;
                        font-weight: 600;
                        text-align: left;
                    ">üë§ Digite seu primeiro nome:</label>
                    
                    <input 
                        type="text" 
                        id="inputNomeUsuario" 
                        placeholder="Ex: renato, bruna, lara..."
                        style="
                            width: 100%;
                            padding: 16px;
                            border: 2px solid #e5e7eb;
                            border-radius: 8px;
                            font-size: 16px;
                            text-align: center;
                            box-sizing: border-box;
                            transition: border-color 0.2s;
                        "
                        onkeydown="if(event.key==='Enter') Auth.tentarLogin()"
                        onfocus="this.style.borderColor='#C53030'"
                        onblur="this.style.borderColor='#e5e7eb'"
                    >
                </div>

                <button 
                    onclick="Auth.tentarLogin()" 
                    style="
                        width: 100%;
                        background: linear-gradient(135deg, #C53030 0%, #9B2C2C 100%);
                        color: white;
                        border: none;
                        padding: 16px;
                        border-radius: 8px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: transform 0.2s;
                    "
                    onmouseover="this.style.transform='translateY(-2px)'"
                    onmouseout="this.style.transform='translateY(0)'"
                >
                    üîê Entrar
                </button>

                <div style="margin-top: 24px;">
                    <p style="
                        color: #6b7280;
                        font-size: 14px;
                        margin: 0 0 12px 0;
                    ">Equipe dispon√≠vel:</p>
                    
                    <div style="
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 8px;
                        font-size: 12px;
                        color: #374151;
                    ">
                        <span onclick="Auth.preencherNome('renato')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">renato</span>
                        <span onclick="Auth.preencherNome('bruna')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">bruna</span>
                        <span onclick="Auth.preencherNome('lara')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">lara</span>
                        <span onclick="Auth.preencherNome('isabella')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">isabella</span>
                        <span onclick="Auth.preencherNome('eduardo')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">eduardo</span>
                        <span onclick="Auth.preencherNome('carlos')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">carlos</span>
                        <span onclick="Auth.preencherNome('alex')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">alex</span>
                        <span onclick="Auth.preencherNome('nominato')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">nominato</span>
                        <span onclick="Auth.preencherNome('nayara')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">nayara</span>
                        <span onclick="Auth.preencherNome('jean')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">jean</span>
                        <span onclick="Auth.preencherNome('juliana')" style="cursor:pointer; padding: 4px; background: #f3f4f6; border-radius: 4px;">juliana</span>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(loginDiv);
        
        // Focar no input
        setTimeout(() => {
            const input = document.getElementById('inputNomeUsuario');
            if (input) input.focus();
        }, 100);

        return loginDiv;
    },

    // üîß M√âTODO AUXILIAR PARA INTERFACE
    tentarLogin() {
        const input = document.getElementById('inputNomeUsuario');
        if (input) {
            const nome = input.value.trim();
            if (nome) {
                this.login(nome);
            } else {
                this._mostrarMensagem('Digite seu nome', 'warning');
            }
        }
    },

    preencherNome(nome) {
        const input = document.getElementById('inputNomeUsuario');
        if (input) {
            input.value = nome;
            input.focus();
        }
    },

    // üéØ M√âTODOS AUXILIARES
    _mostrarTelaLogin() {
        // Esconder sistema principal - CORRE√á√ÉO DEFINITIVA
        const mainContainer = document.getElementById('mainContainer');
        if (mainContainer) {
            mainContainer.classList.add('hidden');
            mainContainer.style.display = 'none';
            console.log("‚úÖ Sistema principal escondido");
        }
        
        // Mostrar interface de login
        this.criarInterfaceLogin();
        console.log("‚úÖ Tela de login exibida");
    },

    _esconderTelaLogin() {
        // Remover interface de login
        const loginDiv = document.getElementById('loginSimplesBiapo');
        if (loginDiv) {
            loginDiv.remove();
        }
        
        // Mostrar sistema principal - CORRE√á√ÉO DEFINITIVA
        const mainContainer = document.getElementById('mainContainer');
        if (mainContainer) {
            mainContainer.classList.remove('hidden');
            mainContainer.style.display = 'block';
            console.log("‚úÖ Sistema principal exibido");
        }
        
        // Inicializar App se necess√°rio
        setTimeout(() => {
            if (typeof App !== 'undefined' && App.inicializar) {
                try {
                    App.inicializar();
                    console.log("‚úÖ App inicializado");
                } catch (error) {
                    console.warn("‚ö†Ô∏è Erro ao inicializar App:", error);
                }
            }
        }, 100);
    },

    _executarCallbacksLogin() {
        // Inicializar sistema se necess√°rio - CORRE√á√ÉO AMPLIADA
        setTimeout(() => {
            if (typeof App !== 'undefined') {
                try {
                    if (App.inicializar) {
                        App.inicializar();
                    } else if (App.inicializarSistema) {
                        App.inicializarSistema();
                    }
                    
                    // Atualizar header com usu√°rio
                    if (document.getElementById('usuarioLogado')) {
                        document.getElementById('usuarioLogado').textContent = `üë§ ${this.usuario.displayName}`;
                    }
                    
                    console.log("‚úÖ Sistema totalmente inicializado ap√≥s login");
                } catch (error) {
                    console.warn("‚ö†Ô∏è Erro na inicializa√ß√£o p√≥s-login:", error);
                }
            }
        }, 200);
    },

    _mostrarMensagem(mensagem, tipo = 'info') {
        // Usar Notifications se dispon√≠vel
        if (typeof Notifications !== 'undefined') {
            switch (tipo) {
                case 'success': 
                    if (Notifications.success) Notifications.success(mensagem);
                    break;
                case 'error': 
                    if (Notifications.error) Notifications.error(mensagem);
                    break;
                case 'warning': 
                    if (Notifications.warning) Notifications.warning(mensagem);
                    break;
                default: 
                    if (Notifications.info) Notifications.info(mensagem);
            }
        } else {
            // Fallback para console
            console.log(`${tipo.toUpperCase()}: ${mensagem}`);
            
            // Fallback para alert se for erro
            if (tipo === 'error') {
                alert(`‚ùå ${mensagem}`);
            }
        }
    },

    // üìä STATUS E DEBUG
    obterStatus() {
        return {
            versao: this.config.versao,
            logado: this.state.logado,
            usuario: this.usuario?.displayName || null,
            primeiroNome: this.usuario?.primeiroNome || null,
            admin: this.ehAdmin(),
            totalEquipe: Object.keys(this.equipeBiapo).length,
            equipeBiapoCarregada: true
        };
    },

    debug() {
        const info = this.obterStatus();
        console.log('üîê Auth Simples BIAPO - Status:', info);
        console.log('üë• Equipe:', this.listarEquipe());
        
        // Debug adicional da interface
        console.log('üñ•Ô∏è Interface:', {
            loginDiv: !!document.getElementById('loginSimplesBiapo'),
            mainContainer: !!document.getElementById('mainContainer'),
            mainContainerVisible: document.getElementById('mainContainer')?.style.display !== 'none'
        });
        
        return info;
    },

    // üîß FUN√á√ÉO DE CORRE√á√ÉO MANUAL
    corrigirInterface() {
        console.log('üîß Corrigindo interface manualmente...');
        
        if (this.state.logado) {
            this._esconderTelaLogin();
        } else {
            this._mostrarTelaLogin();
        }
        
        console.log('‚úÖ Interface corrigida');
    },

    // üöÄ INICIALIZA√á√ÉO
    init() {
        console.log('üîê Inicializando Auth Simples BIAPO v8.1...');
        
        // üî• ESCONDER SISTEMA DE LOGIN ANTIGO
        this._esconderLoginAntigo();
        
        // Tentar auto-login primeiro
        const autoLoginSucesso = this.autoLogin();
        
        if (!autoLoginSucesso) {
            // Se n√£o conseguiu auto-login, mostrar tela de login
            this._mostrarTelaLogin();
        } else {
            console.log('‚úÖ Auto-login realizado com sucesso');
        }
        
        console.log('‚úÖ Auth Simples BIAPO v8.1 inicializado');
    },

    // üî• ESCONDER SISTEMA DE LOGIN ANTIGO
    _esconderLoginAntigo() {
        // Esconder poss√≠veis telas de login antigas
        const loginScreens = [
            '#loginScreen',
            '.login-screen', 
            '.auth-screen',
            '#authContainer',
            '.modal-login'
        ];
        
        loginScreens.forEach(selector => {
            const elemento = document.querySelector(selector);
            if (elemento) {
                elemento.style.display = 'none';
                console.log(`üö´ Escondido login antigo: ${selector}`);
            }
        });
        
        // For√ßar esconder qualquer modal de auth ativo
        const modals = document.querySelectorAll('.modal, [id*="login"], [id*="auth"]');
        modals.forEach(modal => {
            if (modal.id !== 'loginSimplesBiapo') {
                modal.style.display = 'none';
            }
        });
    }
};

// ‚úÖ EXPOSI√á√ÉO GLOBAL
window.Auth = Auth;

// üöÄ AUTO-INICIALIZA√á√ÉO
document.addEventListener('DOMContentLoaded', () => {
    // Aguardar um pouco para outros scripts carregarem
    setTimeout(() => {
        Auth.init();
    }, 500);
});

// üìä COMANDOS √öTEIS NO CONSOLE
window.loginBiapo = (nome) => Auth.login(nome);
window.logoutBiapo = () => Auth.logout();
window.statusAuth = () => Auth.debug();
window.equipeBiapo = () => Auth.listarEquipe();
window.corrigirInterface = () => Auth.corrigirInterface(); // NOVO: Corre√ß√£o manual

console.log('üîê Auth Simples BIAPO v8.1 carregado!');

/*
‚úÖ SISTEMA AUTH SIMPLES v8.1:

üéØ FUNCIONALIDADES:
- ‚úÖ Login apenas com primeiro nome (sem senha)
- ‚úÖ Equipe BIAPO completa (11 pessoas) 
- ‚úÖ Interface visual simples e bonita
- ‚úÖ Auto-login (lembra √∫ltimo usu√°rio)
- ‚úÖ Compatibilidade total com sistema atual
- ‚úÖ Admin para Renato Remiro

üë• EQUIPE DISPON√çVEL:
renato, bruna, lara, isabella, eduardo, carlos/beto, 
alex, nominato, nayara, jean, juliana

üîß COMANDOS √öTEIS:
loginBiapo('renato')  - Fazer login
logoutBiapo()         - Fazer logout  
statusAuth()          - Ver status
equipeBiapo()         - Listar equipe

üöÄ RESULTADO:
- Sistema pronto para usar ‚úÖ
- Login super simples ‚úÖ
- Zero complexidade ‚úÖ
- Totalmente funcional ‚úÖ
*/
