<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Agenda - Sistema BIAPO v8.12.2</title>
    
    <!-- ‚úÖ CSS DO SISTEMA -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/calendar.css">
    
    <!-- ‚úÖ FIREBASE SCRIPTS -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- üî• SISTEMA UNIFICADO CORRIGIDO v8.12.2 -->
    <script src="assets/js/config/firebase.js"></script>
    <script src="assets/js/utils/helpers.js"></script>
    <script src="assets/js/utils/validation.js"></script>
    <script src="assets/js/utils/notifications.js"></script>
    <script src="assets/js/core/data.js"></script>
    <script src="assets/js/core/app.js"></script>
    <script src="assets/js/modules/persistence.js"></script>
    <script src="assets/js/modules/auth.js"></script>
    <script src="assets/js/modules/events.js"></script>
    <script src="assets/js/modules/calendar.js"></script>
    <script src="assets/js/utils/inicializador_sistema.js"></script>

    <style>
        /* üî¥ CORES BIAPO */
        :root {
            --biapo-red: #C53030;
            --biapo-red-light: #E53E3E;
            --biapo-red-dark: #9B2C2C;
            --biapo-orange: #DD6B20;
            --biapo-gray: #2D3748;
            --biapo-gray-light: #4A5568;
            --biapo-gray-lighter: #718096;
            --accent-green: #38A169;
            --accent-yellow: #D69E2E;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        .page-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* üî¥ HEADER DA P√ÅGINA v8.12.2 */
        .page-header {
            background: linear-gradient(135deg, var(--biapo-red) 0%, var(--biapo-red-dark) 100%);
            color: white;
            padding: 24px 32px;
            border-radius: 16px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(197, 48, 48, 0.3);
            position: relative;
        }

        .fase4-badge {
            position: absolute;
            top: -8px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-biapo {
            height: 60px;
            width: auto;
            background: white;
            padding: 8px;
            border-radius: 8px;
        }

        .header-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info-badge {
            background: rgba(255,255,255,0.1);
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            text-align: center;
        }

        .user-name {
            font-weight: 600;
            font-size: 16px;
        }

        .user-email {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 2px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn-header {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-header:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        /* üéõÔ∏è CONTROLES PRINCIPAIS v8.12.2 */
        .main-controls {
            background: white;
            padding: 24px 32px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f0fdf4;
            border-radius: 6px;
            border: 1px solid #bbf7d0;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .actions-section {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--biapo-red) 0%, var(--biapo-red-light) 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--biapo-red-dark) 0%, var(--biapo-red) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(197, 48, 48, 0.3);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: var(--biapo-gray);
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        /* üìÖ GRID DA AGENDA PRINCIPAL v8.12.2 */
        .agenda-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            overflow: hidden;
            min-height: 500px;
        }

        .agenda-header {
            background: #f8fafc;
            padding: 20px 32px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .nav-btn {
            background: white;
            border: 1px solid #e2e8f0;
            color: var(--biapo-gray);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .nav-btn:hover {
            border-color: var(--biapo-red);
            color: var(--biapo-red);
        }

        .current-week {
            font-size: 18px;
            font-weight: 700;
            color: var(--biapo-gray);
        }

        /* üìã GRID DE CONTE√öDO v8.12.2 */
        .agenda-content {
            padding: 20px 32px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading-state {
            text-align: center;
            color: var(--biapo-gray-lighter);
            padding: 60px 20px;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f1f5f9;
            border-top: 3px solid var(--biapo-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--biapo-gray-lighter);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--biapo-gray);
        }

        .empty-description {
            margin-bottom: 24px;
            line-height: 1.6;
        }

        /* üîî NOTIFICA√á√ïES */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: none;
            background: #10b981;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .notification.show {
            display: block;
            opacity: 1;
        }

        .notification.error {
            background: #ef4444;
        }

        .notification.warning {
            background: #f59e0b;
        }

        .notification.info {
            background: #3b82f6;
        }

        /* üì± RESPONSIVIDADE */
        @media (max-width: 768px) {
            .page-container {
                padding: 12px;
            }
            
            .page-header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
                padding: 20px;
            }
            
            .main-controls {
                flex-direction: column;
                align-items: stretch;
                padding: 20px;
            }
            
            .actions-section {
                justify-content: center;
                flex-wrap: wrap;
            }
        }

        /* üéØ STATUS SYSTEM v8.12.2 */
        .system-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 12px;
            color: #6b7280;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .system-status.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- üîî NOTIFICA√á√ïES -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>

    <div class="page-container">
        <!-- üî¥ HEADER DA P√ÅGINA v8.12.2 -->
        <div class="page-header">
            <div class="header-left">
                <img src="assets/img/Logo-biapo.jpg" alt="Logo BIAPO" class="logo-biapo">
                <div>
                    <div class="header-title">üìÖ Minha Agenda <span class="nome-usuario" style="font-size:18px; font-weight:400; margin-left:10px; color:#fff;"></span></div>
                    <div class="header-subtitle">Sistema de Gest√£o BIAPO v8.12.2 - Obra 292</div>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info-badge">
                    <div class="user-name nome-usuario">Carregando...</div>
                    <div class="user-email" id="user-email-agenda">-</div>
                </div>
                <div class="header-actions">
                    <button class="btn-header" onclick="sincronizarAgenda()">
                        üîÑ Sincronizar
                    </button>
                    <button class="btn-header" onclick="abrirCalendarioPrincipal()">
                        üìÖ Ver Calend√°rio
                    </button>
                    <button class="btn-header" onclick="voltarParaSistema()">
                        üè† Voltar ao Sistema
                    </button>
                </div>
            </div>
            <div class="fase4-badge">‚úÖ v8.12.2 CORRIGIDA</div>
        </div>

        <!-- üéõÔ∏è CONTROLES PRINCIPAIS v8.12.2 -->
        <div class="main-controls">
            <div class="sync-status">
                <div class="sync-indicator"></div>
                <span style="font-size: 12px; font-weight: 600; color: #065f46;">
                    Sistema v8.12.2 Ativo
                </span>
            </div>

            <div class="actions-section">
                <button class="btn btn-secondary" onclick="exportarAgenda()">
                    üìÑ Exportar
                </button>
                <button class="btn btn-primary" onclick="criarNovaTarefa()">
                    ‚ûï Nova Tarefa
                </button>
                <button class="btn btn-primary" onclick="recarregarAgenda()">
                    üîÑ Recarregar
                </button>
            </div>
        </div>

        <!-- üìÖ CONTAINER DA AGENDA v8.12.2 -->
        <div class="agenda-container">
            <div class="agenda-header">
                <button class="nav-btn" onclick="navegarSemana(-1)">‚Üê Semana Anterior</button>
                <span class="current-week" id="currentWeekDisplay">Carregando semana...</span>
                <button class="nav-btn" onclick="navegarSemana(1)">Pr√≥xima Semana ‚Üí</button>
                <button class="nav-btn" onclick="irParaHoje()">üè† Hoje</button>
            </div>

            <div class="agenda-content" id="agendaContent">
                <!-- Estado inicial de carregamento -->
                <div class="loading-state" id="loadingState">
                    <div class="loading-spinner"></div>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Carregando sua agenda...</div>
                    <div style="font-size: 14px; opacity: 0.8;">
                        Conectando com o sistema v8.12.2
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- üéØ STATUS DO SISTEMA -->
    <div class="system-status" id="systemStatus">
        <div style="font-weight: 600; color: #374151;">Sistema BIAPO v8.12.2</div>
        <div id="systemStatusText">Inicializando...</div>
    </div>

    <script>
        // üöÄ SISTEMA DE AGENDA SIMPLIFICADO E CORRIGIDO v8.12.2
        class AgendaSimplificada {
            constructor() {
                this.versao = '8.12.2';
                this.carregado = false;
                this.usuarioAtual = null;
                this.semanaAtual = new Date();
                this.dados = {
                    tarefas: [],
                    eventos: []
                };
                this.tentativasInit = 0;
                this.maxTentativas = 20;
                
                console.log('üìÖ Inicializando Agenda Simplificada v8.12.2...');
                this.inicializar();
            }

            async inicializar() {
                try {
                    console.log(`üìÖ Tentativa ${this.tentativasInit + 1}/${this.maxTentativas} - Inicializando agenda...`);
                    
                    // 1. Aguardar App.js
                    const appDisponivel = await this.aguardarApp();
                    if (!appDisponivel) {
                        this.tentativasInit++;
                        if (this.tentativasInit < this.maxTentativas) {
                            console.log('‚è≥ App.js ainda n√£o dispon√≠vel, tentando novamente em 1s...');
                            setTimeout(() => this.inicializar(), 1000);
                            return;
                        } else {
                            throw new Error('App.js n√£o dispon√≠vel ap√≥s ' + this.maxTentativas + ' tentativas');
                        }
                    }
                    
                    // 2. Verificar usu√°rio
                    this.verificarUsuario();
                    
                    // 3. Carregar dados
                    await this.carregarDados();
                    
                    // 4. Renderizar interface
                    this.renderizarAgenda();
                    
                    // 5. Configurar listeners
                    this.configurarListeners();
                    
                    this.carregado = true;
                    this.atualizarStatus('‚úÖ Agenda carregada com sucesso!');
                    
                    console.log('‚úÖ Agenda Simplificada v8.12.2 inicializada com sucesso!');
                    console.log(`üìä ${this.dados.tarefas.length} tarefas | ${this.dados.eventos.length} eventos`);
                    
                } catch (error) {
                    console.error('‚ùå Erro ao inicializar agenda:', error);
                    this.mostrarErro('Erro ao carregar agenda: ' + error.message);
                    this.atualizarStatus('‚ùå Erro na inicializa√ß√£o');
                }
            }

            async aguardarApp() {
                // Verificar se App.js est√° dispon√≠vel e inicializado
                if (typeof App !== 'undefined' && 
                    App.estadoSistema && 
                    App.estadoSistema.inicializado &&
                    typeof App.obterItensParaUsuario === 'function') {
                    console.log('‚úÖ App.js v' + (App.config?.versao || '8.12.x') + ' detectado e dispon√≠vel');
                    return true;
                }
                
                console.log('‚è≥ Aguardando App.js...');
                return false;
            }

            verificarUsuario() {
                try {
                    console.log('üë§ Verificando usu√°rio - in√≠cio');
                    
                    // üî• 1. PRIORIDADE: Auth.js (usu√°rio logado real)
                    if (typeof Auth !== 'undefined' && Auth.obterUsuario) {
                        const usuarioAuth = Auth.obterUsuario();
                        if (usuarioAuth && usuarioAuth.email) {
                            this.usuarioAtual = {
                                nome: usuarioAuth.displayName || usuarioAuth.nome || this.extrairNomeDoEmail(usuarioAuth.email),
                                email: usuarioAuth.email
                            };
                            console.log('‚úÖ Usu√°rio do Auth.js:', this.usuarioAtual);
                        }
                    }
                    
                    // üî• 2. BACKUP: App.js
                    if (!this.usuarioAtual && App.usuarioAtual) {
                        this.usuarioAtual = {
                            nome: App.usuarioAtual.displayName || App.usuarioAtual.nome || this.extrairNomeDoEmail(App.usuarioAtual.email),
                            email: App.usuarioAtual.email
                        };
                        console.log('‚úÖ Usu√°rio do App.js:', this.usuarioAtual);
                    }
                    
                    // üî• 3. FALLBACK: Usu√°rio demo
                    if (!this.usuarioAtual) {
                        this.usuarioAtual = {
                            nome: 'Usu√°rio Demo',
                            email: 'demo@biapo.com.br'
                        };
                        console.log('‚ö†Ô∏è Usando usu√°rio demo:', this.usuarioAtual);
                    }
                    
                    // Atualizar interface
                    document.querySelectorAll('.nome-usuario').forEach(el => {
                        el.textContent = this.usuarioAtual.nome;
                    });
                    
                    const emailEl = document.getElementById('user-email-agenda');
                    if (emailEl) emailEl.textContent = this.usuarioAtual.email;
                    
                    console.log('üë§ Usu√°rio final verificado:', this.usuarioAtual);
                    
                } catch (error) {
                    console.error('‚ùå Erro ao verificar usu√°rio:', error);
                    this.usuarioAtual = { nome: 'Usu√°rio', email: 'usuario@biapo.com.br' };
                }
            }

            extrairNomeDoEmail(email) {
                if (!email) return 'Usu√°rio';
                const parteLocal = email.split('@')[0];
                return parteLocal.charAt(0).toUpperCase() + parteLocal.slice(1);
            }

            async carregarDados() {
                try {
                    console.log('üì• Carregando dados da agenda para:', this.usuarioAtual.email);
                    
                    if (!App.obterItensParaUsuario) {
                        throw new Error('Fun√ß√£o obterItensParaUsuario n√£o dispon√≠vel no App.js');
                    }
                    
                    // üî• CORRE√á√ÉO: Usar email correto do usu√°rio
                    const { eventos, tarefas } = App.obterItensParaUsuario(this.usuarioAtual.email);
                    
                    console.log('üìä Dados brutos recebidos:', { 
                        eventos: eventos.length, 
                        tarefas: tarefas.length,
                        usuario: this.usuarioAtual.email
                    });
                    
                    // üî• FILTRO AMPLIADO: Incluir tarefas pessoais e que o usu√°rio participa
                    this.dados.tarefas = tarefas.filter(tarefa => {
                        const emailMatch = tarefa.responsavel === this.usuarioAtual.email || 
                                         tarefa.criadoPor === this.usuarioAtual.email;
                        const nomeMatch = tarefa.participantes?.includes(this.usuarioAtual.nome) ||
                                        tarefa.participantes?.includes(this.usuarioAtual.email);
                        const scopeMatch = tarefa.escopo === 'pessoal';
                        
                        return emailMatch || nomeMatch || scopeMatch;
                    });
                    
                    // üî• FILTRO AMPLIADO: Incluir todos os eventos relevantes
                    this.dados.eventos = eventos.filter(evento => {
                        const emailMatch = evento.responsavel === this.usuarioAtual.email || 
                                         evento.criadoPor === this.usuarioAtual.email;
                        const participanteMatch = evento.participantes?.includes(this.usuarioAtual.nome) ||
                                                 evento.participantes?.includes(this.usuarioAtual.email) ||
                                                 evento.pessoas?.includes(this.usuarioAtual.nome) ||
                                                 evento.pessoas?.includes(this.usuarioAtual.email);
                        const publicoMatch = evento.visibilidade === 'publica' || evento.escopo === 'publico';
                        
                        return emailMatch || participanteMatch || publicoMatch;
                    });
                    
                    console.log(`‚úÖ Dados filtrados: ${this.dados.tarefas.length} tarefas + ${this.dados.eventos.length} eventos`);
                    console.log('üìã Tarefas:', this.dados.tarefas.map(t => ({ titulo: t.titulo, responsavel: t.responsavel, escopo: t.escopo })));
                    console.log('üìÖ Eventos:', this.dados.eventos.map(e => ({ titulo: e.titulo, responsavel: e.responsavel, participantes: e.participantes })));
                    
                } catch (error) {
                    console.error('‚ùå Erro ao carregar dados:', error);
                    this.dados = { tarefas: [], eventos: [] };
                }
            }

            renderizarAgenda() {
                try {
                    console.log('üé® Renderizando agenda...');
                    
                    const container = document.getElementById('agendaContent');
                    if (!container) {
                        throw new Error('Container agendaContent n√£o encontrado');
                    }
                    
                    // Remover loading
                    const loading = document.getElementById('loadingState');
                    if (loading) loading.remove();
                    
                    // Verificar se h√° dados
                    const totalItens = this.dados.tarefas.length + this.dados.eventos.length;
                    
                    if (totalItens === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">üìÖ</div>
                                <div class="empty-title">Sua agenda est√° vazia</div>
                                <div class="empty-description">
                                    Voc√™ n√£o tem tarefas pessoais ou eventos relevantes no momento.
                                    <br><br>
                                    <strong>Sistema v8.12.2 funcionando corretamente!</strong>
                                    <br>
                                    Conectado com App.js v${App.config?.versao || '8.12.x'}
                                </div>
                                <button class="btn btn-primary" onclick="criarNovaTarefa()">
                                    ‚ûï Criar Primeira Tarefa
                                </button>
                            </div>
                        `;
                    } else {
                        // Renderizar grid simplificado
                        this.renderizarGridSimplificado(container);
                    }
                    
                    // Atualizar semana atual
                    this.atualizarSemanaDisplay();
                    
                    console.log('‚úÖ Agenda renderizada com sucesso!');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao renderizar agenda:', error);
                    this.mostrarErro('Erro ao renderizar agenda: ' + error.message);
                }
            }

            renderizarGridSimplificado(container) {
                const hoje = new Date();
                const inicioSemana = new Date(this.semanaAtual);
                inicioSemana.setDate(this.semanaAtual.getDate() - this.semanaAtual.getDay());
                
                const diasSemana = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'S√ÅB'];
                
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e5e7eb; border-radius: 8px; overflow: hidden; margin-bottom: 16px;">
                        ${diasSemana.map(dia => `
                            <div style="background: #374151; color: white; padding: 12px 8px; text-align: center; font-weight: 600; font-size: 12px;">${dia}</div>
                        `).join('')}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e5e7eb; border-radius: 8px; overflow: hidden; min-height: 300px;">
                `;
                
                // Gerar dias da semana
                for (let i = 0; i < 7; i++) {
                    const dia = new Date(inicioSemana);
                    dia.setDate(inicioSemana.getDate() + i);
                    
                    const ehHoje = dia.toDateString() === hoje.toDateString();
                    const dataISO = dia.toISOString().split('T')[0];
                    
                    // Obter itens do dia
                    const itensDia = this.obterItensDoDia(dataISO);
                    
                    html += this.criarCelulaDia(dia, ehHoje, itensDia);
                }
                
                html += `</div>`;
                
                // Adicionar estat√≠sticas
                html += `
                    <div style="margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e5e7eb; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; text-align: center;">
                        <div>
                            <div style="font-size: 20px; font-weight: 700; color: #8b5cf6;">${this.dados.tarefas.length}</div>
                            <div style="font-size: 12px; color: #6b7280;">Tarefas Pessoais</div>
                        </div>
                        <div>
                            <div style="font-size: 20px; font-weight: 700; color: #3b82f6;">${this.dados.eventos.length}</div>
                            <div style="font-size: 12px; color: #6b7280;">Eventos Relevantes</div>
                        </div>
                        <div>
                            <div style="font-size: 20px; font-weight: 700; color: #10b981;">${this.dados.tarefas.filter(t => t.status === 'concluida').length}</div>
                            <div style="font-size: 12px; color: #6b7280;">Conclu√≠das</div>
                        </div>
                        <div>
                            <div style="font-size: 20px; font-weight: 700; color: #f59e0b;">${this.dados.tarefas.filter(t => t.horarioInicio).length}</div>
                            <div style="font-size: 12px; color: #6b7280;">Com Hor√°rio</div>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
            }

            obterItensDoDia(dataISO) {
                const eventos = this.dados.eventos.filter(evento => 
                    evento.data === dataISO || evento.dataInicio === dataISO
                );
                
                const tarefas = this.dados.tarefas.filter(tarefa => 
                    tarefa.dataInicio === dataISO || tarefa.data === dataISO
                );
                
                return { eventos, tarefas, total: eventos.length + tarefas.length };
            }

            criarCelulaDia(dia, ehHoje, itensDia) {
                const { eventos, tarefas, total } = itensDia;
                
                let backgroundColor = '#ffffff';
                if (ehHoje) backgroundColor = '#dbeafe';
                
                return `
                    <div style="
                        background: ${backgroundColor};
                        min-height: 80px;
                        padding: 8px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        border: 1px solid #e5e7eb;
                    " 
                    onclick="abrirDia('${dia.toISOString().split('T')[0]}')"
                    onmouseenter="this.style.backgroundColor='#f3f4f6'"
                    onmouseleave="this.style.backgroundColor='${backgroundColor}'">
                        
                        <div style="
                            font-weight: ${ehHoje ? '700' : '500'};
                            font-size: 14px;
                            margin-bottom: 8px;
                            color: ${ehHoje ? '#1e40af' : '#374151'};
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <span>${dia.getDate()}</span>
                            ${total > 0 ? `<span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 600;">${total}</span>` : ''}
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 2px;">
                            ${eventos.slice(0, 2).map(evento => `
                                <div style="
                                    background: #3b82f6; 
                                    color: white; 
                                    padding: 2px 4px; 
                                    border-radius: 3px; 
                                    font-size: 8px; 
                                    font-weight: 600;
                                    overflow: hidden;
                                    text-overflow: ellipsis;
                                    white-space: nowrap;
                                " title="${evento.titulo}">
                                    üìÖ ${evento.titulo}
                                </div>
                            `).join('')}
                            
                            ${tarefas.slice(0, 2).map(tarefa => `
                                <div style="
                                    background: #8b5cf6; 
                                    color: white; 
                                    padding: 2px 4px; 
                                    border-radius: 3px; 
                                    font-size: 8px; 
                                    font-weight: 600;
                                    overflow: hidden;
                                    text-overflow: ellipsis;
                                    white-space: nowrap;
                                " title="${tarefa.titulo}">
                                    üìã ${tarefa.titulo}
                                </div>
                            `).join('')}
                            
                            ${total > 4 ? `
                                <div style="
                                    background: #6b7280; 
                                    color: white; 
                                    padding: 2px 4px; 
                                    border-radius: 3px; 
                                    font-size: 8px; 
                                    font-weight: 600;
                                    text-align: center;
                                ">
                                    +${total - 4} mais
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            atualizarSemanaDisplay() {
                const inicioSemana = new Date(this.semanaAtual);
                inicioSemana.setDate(this.semanaAtual.getDate() - this.semanaAtual.getDay());
                
                const fimSemana = new Date(inicioSemana);
                fimSemana.setDate(inicioSemana.getDate() + 6);

                const display = `${inicioSemana.getDate()} - ${fimSemana.getDate()} ${fimSemana.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}`;
                
                const elemento = document.getElementById('currentWeekDisplay');
                if (elemento) elemento.textContent = display;
            }

            configurarListeners() {
                // Listener para mudan√ßas do App.js
                document.addEventListener('app-tarefa-criada', () => {
                    console.log('üìã Tarefa criada detectada, recarregando agenda...');
                    this.recarregar();
                });
                
                document.addEventListener('app-tarefa-editada', () => {
                    console.log('üìã Tarefa editada detectada, recarregando agenda...');
                    this.recarregar();
                });
                
                document.addEventListener('dados-sincronizados', () => {
                    console.log('üîÑ Dados sincronizados detectados, recarregando agenda...');
                    this.recarregar();
                });
                
                // üî• NOVO: Listener para login/logout
                document.addEventListener('biapo-login', (e) => {
                    console.log('üîÑ Login detectado na agenda, recarregando usu√°rio...', e.detail);
                    this.verificarUsuario();
                    this.recarregar();
                });
                
                document.addEventListener('biapo-logout', () => {
                    console.log('üîÑ Logout detectado na agenda');
                    this.usuarioAtual = null;
                    this.dados = { tarefas: [], eventos: [] };
                    this.renderizarAgenda();
                });
                
                console.log('‚úÖ Listeners configurados (incluindo auth)');
            }

            async recarregar() {
                try {
                    console.log('üîÑ Recarregando agenda...');
                    this.atualizarStatus('üîÑ Recarregando...');
                    
                    // üî• CORRE√á√ÉO: Verificar usu√°rio antes de carregar dados
                    this.verificarUsuario();
                    await this.carregarDados();
                    this.renderizarAgenda();
                    
                    this.atualizarStatus('‚úÖ Agenda atualizada!');
                    this.notificar('‚úÖ Agenda recarregada com sucesso!', 'success');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao recarregar agenda:', error);
                    this.atualizarStatus('‚ùå Erro ao recarregar');
                    this.notificar('‚ùå Erro ao recarregar agenda', 'error');
                }
            }
            
            // üî• NOVA FUN√á√ÉO: For√ßar sincroniza√ß√£o de usu√°rio
            forcarSincronizacaoUsuario() {
                try {
                    console.log('üîß For√ßando sincroniza√ß√£o de usu√°rio...');
                    
                    this.verificarUsuario();
                    this.recarregar();
                    
                    console.log('‚úÖ Sincroniza√ß√£o for√ßada conclu√≠da');
                    
                } catch (error) {
                    console.error('‚ùå Erro na sincroniza√ß√£o for√ßada:', error);
                }
            }

            navegarSemana(direcao) {
                this.semanaAtual.setDate(this.semanaAtual.getDate() + (direcao * 7));
                this.atualizarSemanaDisplay();
                this.renderizarAgenda();
                console.log(`üìÖ Navegou ${direcao > 0 ? 'pr√≥xima' : 'anterior'} semana`);
            }

            irParaHoje() {
                this.semanaAtual = new Date();
                this.atualizarSemanaDisplay();
                this.renderizarAgenda();
                console.log('üìÖ Voltou para semana atual');
            }

            mostrarErro(mensagem) {
                const container = document.getElementById('agendaContent');
                if (container) {
                    container.innerHTML = `
                        <div style="
                            text-align: center; 
                            padding: 60px 20px; 
                            color: #dc2626;
                            background: #fee2e2;
                            border: 2px solid #fca5a5;
                            border-radius: 8px;
                            margin: 20px;
                        ">
                            <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
                            <h3 style="margin: 0 0 8px 0; color: #991b1b;">Erro na Agenda</h3>
                            <p style="margin: 0 0 16px 0; font-size: 14px;">${mensagem}</p>
                            <button class="btn btn-primary" onclick="location.reload()">
                                üîÑ Recarregar P√°gina
                            </button>
                        </div>
                    `;
                }
            }

            atualizarStatus(texto) {
                const statusEl = document.getElementById('systemStatusText');
                if (statusEl) statusEl.textContent = texto;
            }

            notificar(mensagem, tipo = 'info') {
                const notificacao = document.getElementById('notification');
                const texto = document.getElementById('notificationText');
                
                if (notificacao && texto) {
                    texto.textContent = mensagem;
                    notificacao.className = `notification show ${tipo}`;
                    
                    setTimeout(() => {
                        notificacao.classList.remove('show');
                    }, 3000);
                }
                
                console.log(`${tipo.toUpperCase()}: ${mensagem}`);
            }
        }

        // üöÄ FUN√á√ïES GLOBAIS SIMPLIFICADAS
        let agendaGlobal = null;

        function sincronizarAgenda() {
            if (agendaGlobal) {
                // üî• CORRE√á√ÉO: For√ßar sincroniza√ß√£o de usu√°rio tamb√©m
                agendaGlobal.forcarSincronizacaoUsuario();
            } else {
                console.warn('‚ö†Ô∏è Agenda n√£o inicializada');
            }
        }
        
        // üî• NOVA FUN√á√ÉO GLOBAL: For√ßar sincroniza√ß√£o de usu√°rio
        function forcarSincronizacaoUsuario() {
            if (agendaGlobal) {
                agendaGlobal.forcarSincronizacaoUsuario();
            } else {
                console.warn('‚ö†Ô∏è Agenda n√£o inicializada');
            }
        }

        function abrirCalendarioPrincipal() {
            window.location.href = 'index.html';
        }

        function voltarParaSistema() {
            window.location.href = 'index.html';
        }

        function exportarAgenda() {
            alert('üìÑ Funcionalidade de exporta√ß√£o ser√° implementada em breve.');
        }

        function criarNovaTarefa() {
            if (typeof App !== 'undefined' && App.criarTarefa) {
                const titulo = prompt('üìã Digite o t√≠tulo da nova tarefa:');
                if (titulo) {
                    const dadosTarefa = {
                        titulo: titulo,
                        escopo: 'pessoal',
                        status: 'pendente',
                        dataInicio: new Date().toISOString().split('T')[0]
                    };
                    
                    App.criarTarefa(dadosTarefa).then(() => {
                        agendaGlobal?.recarregar();
                    }).catch(error => {
                        alert('‚ùå Erro ao criar tarefa: ' + error.message);
                    });
                }
            } else {
                alert('‚ö†Ô∏è Sistema de tarefas n√£o dispon√≠vel no momento.');
            }
        }

        function recarregarAgenda() {
            if (agendaGlobal) {
                agendaGlobal.recarregar();
            } else {
                location.reload();
            }
        }

        function navegarSemana(direcao) {
            if (agendaGlobal) {
                agendaGlobal.navegarSemana(direcao);
            }
        }

        function irParaHoje() {
            if (agendaGlobal) {
                agendaGlobal.irParaHoje();
            }
        }

        function abrirDia(data) {
            const dataObj = new Date(data + 'T00:00:00');
            const dataFormatada = dataObj.toLocaleDateString('pt-BR', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            alert(`üìÖ DIA SELECIONADO\n\n${dataFormatada}\n\nüí° Detalhes do dia ser√£o implementados em breve.\nPor enquanto, use o calend√°rio principal para mais funcionalidades.`);
        }

        // üöÄ INICIALIZA√á√ÉO AUTOM√ÅTICA
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM carregado - iniciando Agenda Simplificada v8.12.2...');
            
            // Aguardar um pouco para garantir que outros scripts carreguem
            setTimeout(() => {
                agendaGlobal = new AgendaSimplificada();
            }, 500);
        });

        // üöÄ FALLBACK PARA CARREGAMENTO TARDIO
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(() => {
                if (!agendaGlobal) {
                    console.log('‚ö° Inicializa√ß√£o tardia da agenda...');
                    agendaGlobal = new AgendaSimplificada();
                }
            }, 1000);
        }

        console.log('üìÖ Agenda v8.12.2 CORRIGIDA carregada!');
    </script>
</body>
</html>