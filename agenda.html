<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Agenda - Sistema BIAPO v8.11.0</title>
    
    <!-- ‚úÖ CSS DO SISTEMA -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/calendar.css">
    
    <!-- ‚úÖ FIREBASE SCRIPTS -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- üî• SISTEMA UNIFICADO COMPLETO v8.11.0 -->
    <script src="assets/js/config/firebase.js"></script>
    <script src="assets/js/utils/helpers.js"></script>
    <script src="assets/js/utils/validation.js"></script>
    <script src="assets/js/utils/notifications.js"></script>
    <script src="assets/js/core/data.js"></script>
    <script src="assets/js/core/app.js"></script>
    <script src="assets/js/modules/persistence.js"></script>
    <script src="assets/js/modules/auth.js"></script>
<script src="assets/js/utils/corretor_sync_participantes_v8.12.js"></script>
<script src="assets/js/utils/inicializador_sistema.js"></script>

    <style>
        /* üî¥ CORES BIAPO */
        :root {
            --biapo-red: #C53030;
            --biapo-red-light: #E53E3E;
            --biapo-red-dark: #9B2C2C;
            --biapo-orange: #DD6B20;
            --biapo-gray: #2D3748;
            --biapo-gray-light: #4A5568;
            --biapo-gray-lighter: #718096;
            --accent-green: #38A169;
            --accent-yellow: #D69E2E;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        .page-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* üî¥ HEADER DA P√ÅGINA FASE 4 v8.11.0 */
        .page-header {
            background: linear-gradient(135deg, var(--biapo-red) 0%, var(--biapo-red-dark) 100%);
            color: white;
            padding: 24px 32px;
            border-radius: 16px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(197, 48, 48, 0.3);
            position: relative;
        }

        /* üî• NOVO: Badge Fase 4 */
        .fase4-badge {
            position: absolute;
            top: -8px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-biapo {
            height: 60px;
            width: auto;
            background: white;
            padding: 8px;
            border-radius: 8px;
        }

        .header-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info-badge {
            background: rgba(255,255,255,0.1);
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            text-align: center;
        }

        .user-name {
            font-weight: 600;
            font-size: 16px;
        }

        .user-email {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 2px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn-header {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-header:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        /* üéõÔ∏è CONTROLES PRINCIPAIS FASE 4 v8.11.0 */
        .main-controls {
            background: white;
            padding: 24px 32px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .view-tabs {
            display: flex;
            gap: 4px;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 8px;
        }

        .view-tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--biapo-gray);
        }

        .view-tab.active {
            background: var(--biapo-red);
            color: white;
            box-shadow: 0 2px 4px rgba(197, 48, 48, 0.3);
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f0fdf4;
            border-radius: 6px;
            border: 1px solid #bbf7d0;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .filters-section {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--biapo-gray-lighter);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            color: var(--biapo-gray);
            min-width: 140px;
        }

        .actions-section {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--biapo-red) 0%, var(--biapo-red-light) 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--biapo-red-dark) 0%, var(--biapo-red) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(197, 48, 48, 0.3);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: var(--biapo-gray);
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
        }

        .btn-info {
            background: #06b6d4;
            color: white;
        }

        /* üî• SE√á√ÉO EVENTOS DE EQUIPE FASE 4 */
        .team-events-section {
            background: white;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .team-events-header {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .team-events-content {
            padding: 20px 24px;
        }

        .team-event-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #06b6d4;
            background: #f0f9ff;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .team-event-item:hover {
            background: #e0f2fe;
            transform: translateX(2px);
        }

        .team-event-icon {
            font-size: 20px;
        }

        .team-event-info {
            flex: 1;
        }

        .team-event-title {
            font-weight: 600;
            color: #0c4a6e;
            margin-bottom: 4px;
        }

        .team-event-meta {
            font-size: 12px;
            color: #0369a1;
        }

        /* üìÖ GRID SEMANAL PRINCIPAL FASE 4 COM HOR√ÅRIOS */
        .agenda-views {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .weekly-navigation {
            background: #f8fafc;
            padding: 20px 32px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .nav-btn {
            background: white;
            border: 1px solid #e2e8f0;
            color: var(--biapo-gray);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .nav-btn:hover {
            border-color: var(--biapo-red);
            color: var(--biapo-red);
        }

        .current-week {
            font-size: 18px;
            font-weight: 700;
            color: var(--biapo-gray);
        }

        .weekly-grid {
            display: grid;
            grid-template-columns: 120px repeat(7, 1fr);
            min-height: 600px;
            background: white;
        }

        /* üìã CABE√áALHO DOS DIAS FASE 4 */
        .time-column {
            background: #f8fafc;
            border-right: 2px solid #e2e8f0;
            padding: 16px 8px;
            text-align: center;
            font-weight: 600;
            color: var(--biapo-gray);
        }

        .day-header {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            padding: 16px 8px;
            text-align: center;
            border-right: 1px solid #e2e8f0;
            border-bottom: 2px solid var(--biapo-red);
        }

        .day-header.today {
            background: linear-gradient(135deg, var(--biapo-red-light) 0%, var(--biapo-red) 100%);
            color: white;
        }

        .day-name {
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .day-date {
            font-size: 20px;
            font-weight: 700;
            margin-top: 4px;
        }

        .day-tasks-count {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* üìã COLUNA DE HOR√ÅRIOS FASE 4 */
        .time-slots {
            background: #f8fafc;
            border-right: 2px solid #e2e8f0;
            display: flex;
            flex-direction: column;
        }

        .time-slot {
            height: 60px;
            padding: 8px 4px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--biapo-gray-lighter);
        }

        /* üìù COLUNAS DOS DIAS FASE 4 */
        .day-column {
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            min-height: 100%;
            position: relative;
        }

        .day-column:last-child {
            border-right: none;
        }

        /* üïê SLOTS DE HOR√ÅRIO NOS DIAS */
        .hour-slot {
            height: 60px;
            border-bottom: 1px solid #f1f5f9;
            position: relative;
            padding: 4px;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        .hour-slot:hover {
            background-color: rgba(197, 48, 48, 0.05);
        }

        /* üìã ITENS NO GRID FASE 4 COM HOR√ÅRIOS */
        .item-grid {
            background: white;
            border-radius: 6px;
            padding: 8px 10px;
            margin: 2px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            font-size: 11px;
        }

        .item-grid:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* üî• TIPOS DE ITENS COM CORES ESPEC√çFICAS FASE 4 */
        .item-grid.evento-equipe {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        .item-grid.evento-publico {
            border-left: 4px solid #06b6d4;
            background: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%);
        }

        .item-grid.tarefa-pessoal {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .item-grid.tarefa-equipe {
            border-left: 4px solid #8b5cf6;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }

        .item-grid.tarefa-publico {
            border-left: 4px solid #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .item-grid.urgente {
            border-left: 4px solid #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            animation: pulse 2s infinite;
        }

        /* üî• NOVO: Indicador de hor√°rio no item */
        .item-time-range {
            font-size: 9px;
            font-weight: 700;
            color: var(--biapo-gray);
            margin-bottom: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-duration {
            background: rgba(0,0,0,0.1);
            padding: 1px 4px;
            border-radius: 8px;
            font-size: 8px;
        }

        .item-time {
            font-size: 10px;
            font-weight: 600;
            color: var(--biapo-gray);
            margin-bottom: 2px;
        }

        .item-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--biapo-gray);
            margin-bottom: 2px;
            line-height: 1.2;
        }

        .item-description {
            font-size: 10px;
            color: var(--biapo-gray-lighter);
            line-height: 1.3;
            margin-bottom: 4px;
        }

        .item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
        }

        .item-badge {
            font-size: 8px;
            padding: 2px 4px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .item-badge.evento {
            background: #dbeafe;
            color: #1e40af;
        }

        .item-badge.tarefa {
            background: #fef3c7;
            color: #92400e;
        }

        .item-actions {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .item-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px;
            border-radius: 3px;
            font-size: 10px;
            transition: background-color 0.2s;
        }

        .item-action-btn:hover {
            background: rgba(0,0,0,0.1);
        }

        /* üîÑ LINHA DO TEMPO ATUAL */
        .current-time-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--biapo-red);
            z-index: 10;
            box-shadow: 0 0 4px rgba(197, 48, 48, 0.5);
        }

        .current-time-line::before {
            content: '';
            position: absolute;
            left: -6px;
            top: -4px;
            width: 10px;
            height: 10px;
            background: var(--biapo-red);
            border-radius: 50%;
        }

        /* üìä ESTAT√çSTICAS FASE 4 */
        .stats-bar {
            background: #f8fafc;
            padding: 20px 32px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--biapo-red);
        }

        .stat-label {
            font-size: 12px;
            color: var(--biapo-gray-lighter);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* üîî NOTIFICA√á√ïES */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: none;
            background: #10b981;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* üî¥ MODAL SISTEMA FASE 4 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 20000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex !important;
            opacity: 1;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--biapo-red) 0%, var(--biapo-red-dark) 100%);
            color: white;
            padding: 20px 24px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 0 0 16px 16px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* üìù FORMUL√ÅRIOS FASE 4 COM HOR√ÅRIOS */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--biapo-gray);
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            box-sizing: border-box;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--biapo-red);
            box-shadow: 0 0 0 3px rgba(197, 48, 48, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .form-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        /* üî• NOVO: Se√ß√£o de hor√°rios destacada */
        .horarios-section {
            background: #f0f9ff;
            border: 2px solid #bfdbfe;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .horarios-section h4 {
            color: #1e40af;
            margin: 0 0 16px 0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* üè∑Ô∏è TAGS PARTICIPANTES */
        .participantes-container {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            min-height: 44px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .participantes-container:focus-within {
            border-color: var(--biapo-red);
            box-shadow: 0 0 0 3px rgba(197, 48, 48, 0.1);
        }

        .participante-tag {
            background: var(--biapo-red);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .participante-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }

        .participante-input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 120px;
            font-size: 14px;
        }

        /* üìã SUBTAREFAS */
        .subtarefas-list {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .subtarefa-item {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .subtarefa-item:last-child {
            border-bottom: none;
        }

        .subtarefa-checkbox {
            width: 18px;
            height: 18px;
        }

        .subtarefa-texto {
            flex: 1;
            font-size: 14px;
        }

        .subtarefa-texto.concluida {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .subtarefa-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .btn-icon:hover {
            background: #f1f5f9;
        }

        /* üî• NOVO: Indicador de deep link */
        .deep-link-indicator {
            position: fixed;
            top: 100px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            z-index: 5000;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* üé® LOADING */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f1f5f9;
            border-top: 3px solid var(--biapo-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* üì± RESPONSIVIDADE */
        @media (max-width: 1200px) {
            .weekly-grid {
                grid-template-columns: 100px repeat(7, 1fr);
            }
        }

        @media (max-width: 768px) {
            .page-container {
                padding: 12px;
            }
            
            .page-header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
                padding: 20px;
            }
            
            .main-controls {
                flex-direction: column;
                align-items: stretch;
                padding: 20px;
            }
            
            .filters-section,
            .actions-section {
                justify-content: center;
            }
            
            .weekly-grid {
                grid-template-columns: 80px repeat(7, 1fr);
                font-size: 12px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .horarios-section {
                padding: 16px;
                margin: 16px 0;
            }
        }

        /* üéØ ESTADOS ESPECIAIS */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--biapo-gray-lighter);
            grid-column: 1 / -1;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--biapo-gray);
        }

        .empty-description {
            margin-bottom: 24px;
        }

        /* üé® ANIMA√á√ïES */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* üî• INDICADORES SISTEMA FASE 4 */
        .sync-badge {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #065f46;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-link-badge {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #1e40af;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calendar-link-badge:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
        }

        .fase4-feature {
            border: 2px solid #10b981;
            border-radius: 8px;
            background: rgba(16, 185, 129, 0.05);
            position: relative;
        }

        .fase4-feature::before {
            content: "üî• FASE 4";
            position: absolute;
            top: -10px;
            left: 10px;
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <!-- üîî NOTIFICA√á√ïES -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>

    <!-- üî• NOVO: Indicador de Deep Link -->
    <div id="deepLinkIndicator" class="deep-link-indicator">
        <span id="deepLinkText">üîó Abrindo item via deep link...</span>
    </div>

    <div class="page-container">
        <!-- üî¥ HEADER DA P√ÅGINA FASE 4 v8.11.0 -->
        <div class="page-header">
            <div class="header-left">
                <img src="assets/img/Logo-biapo.jpg" alt="Logo BIAPO" class="logo-biapo">
                <div>
                    <div class="header-title">üìÖ Minha Agenda <span class="nome-usuario" style="font-size:18px; font-weight:400; margin-left:10px; color:#fff;"></span></div>
                    <div class="header-subtitle">Pessoal<br>Sistema de Gest√£o BIAPO - Obra 292</div>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info-badge">
                    <div class="user-name nome-usuario">Usu√°rio</div>
                    <div class="user-email" id="user-email-agenda">-</div>
                </div>
                <div class="header-actions">
                    <button class="btn-header" onclick="agendaFase4.sincronizarFase4()">
                        üîÑ Sync Fase 4
                    </button>
                    <button class="btn-header" onclick="agendaFase4.abrirCalendarioPrincipal()">
                        üìÖ Ver Calend√°rio
                    </button>
                    <button class="btn-header" onclick="agendaFase4.copiarDeepLinkPagina()">
                        üîó Copiar Link
                    </button>
                    <button class="btn-header" onclick="agendaFase4.voltarParaSistema()">
                        üè† Voltar ao Sistema
                    </button>
                </div>
            </div>
            <div class="fase4-badge">‚úîÔ∏è CORRIGIDA V8.12.2</div>
        </div>

        <!-- üéõÔ∏è CONTROLES PRINCIPAIS FASE 4 -->
        <div class="main-controls">
            <div class="view-tabs">
                <button class="view-tab active" onclick="agendaFase4.alternarVisualizacao('grid')" data-view="grid">
                    üóìÔ∏è Grid Semanal
                </button>
                <button class="view-tab" onclick="agendaFase4.alternarVisualizacao('timeline')" data-view="timeline">
                    üïê Timeline Hor√°rios
                </button>
            </div>

            <div class="sync-status">
                <div class="sync-indicator"></div>
                <span style="font-size: 12px; font-weight: 600; color: #065f46;">
                    Sync Fase 4 Ativo
                </span>
            </div>

            <div class="filters-section">
                <div class="filter-group">
                    <label class="filter-label">Tipo</label>
                    <select class="filter-select" id="filtroTipo" onchange="agendaFase4.aplicarFiltros()">
                        <option value="todos">üîÑ Todos os tipos</option>
                        <option value="urgente">üö® Urgente</option>
                        <option value="projeto">üèóÔ∏è Projeto</option>
                        <option value="equipe">üë• Equipe</option>
                        <option value="pessoal">üë§ Pessoal</option>
                        <option value="rotina">üîÑ Rotina</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select class="filter-select" id="filtroStatus" onchange="agendaFase4.aplicarFiltros()">
                        <option value="todos">‚ö° Todos os status</option>
                        <option value="pendente">‚è≥ Pendente</option>
                        <option value="andamento">üî• Em andamento</option>
                        <option value="concluida">‚úÖ Conclu√≠da</option>
                        <option value="cancelada">‚ùå Cancelada</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Escopo</label>
                    <select class="filter-select" id="filtroEscopo" onchange="agendaFase4.aplicarFiltros()">
                        <option value="todos">üåê Todos os escopos</option>
                        <option value="pessoal">üë§ Pessoal</option>
                        <option value="equipe">üë• Equipe</option>
                        <option value="publico">üåç P√∫blico</option>
                    </select>
                </div>

                <!-- üî• NOVO: Filtro por hor√°rio -->
                <div class="filter-group">
                    <label class="filter-label">Hor√°rio</label>
                    <select class="filter-select" id="filtroHorario" onchange="agendaFase4.aplicarFiltros()">
                        <option value="todos">üïê Todos os hor√°rios</option>
                        <option value="manha">üåÖ Manh√£ (6h-12h)</option>
                        <option value="tarde">‚òÄÔ∏è Tarde (12h-18h)</option>
                        <option value="noite">üåô Noite (18h-24h)</option>
                        <option value="sem_horario">‚è∞ Sem hor√°rio</option>
                    </select>
                </div>
            </div>

            <div class="actions-section">
                <button class="btn btn-secondary" onclick="agendaFase4.exportarAgendaFase4()">
                    üìÑ Exportar PDF
                </button>
                <button class="btn btn-info" onclick="agendaFase4.mostrarRelatoriosHorarios()">
                    üìä Relat√≥rios
                </button>
                <button class="btn btn-success" onclick="agendaFase4.mostrarModalNovaTarefaFase4()">
                    ‚ûï Nova Tarefa
                </button>
                <button class="btn btn-primary" onclick="agendaFase4.sincronizarFase4()">
                    üîÑ Sync Completo
                </button>
            </div>
        </div>

        <!-- üî• SE√á√ÉO EVENTOS DE EQUIPE RELEVANTES FASE 4 -->
        <div class="team-events-section" id="teamEventsSection">
            <div class="team-events-header">
                <div>
                    <h3>üìÖ Eventos de Equipe Relevantes</h3>
                    <p style="font-size: 12px; opacity: 0.9; margin: 4px 0 0 0;">
                        Eventos onde voc√™ participa ou √© respons√°vel (com hor√°rios)
                    </p>
                </div>
                <div style="display: flex; gap: 8px;">
                    <span id="teamEventsCount" style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 6px; font-size: 12px;">
                        0 eventos
                    </span>
                    <button onclick="agendaFase4.abrirCalendarioPrincipal()" style="
                        background: rgba(255,255,255,0.2);
                        border: 1px solid rgba(255,255,255,0.3);
                        color: white;
                        padding: 6px 12px;
                        border-radius: 6px;
                        font-size: 12px;
                        cursor: pointer;
                    ">üìÖ Ver Todos</button>
                </div>
            </div>
            <div class="team-events-content" id="teamEventsContent">
                <!-- Eventos de equipe ser√£o renderizados aqui -->
            </div>
        </div>

        <!-- üìÖ GRID SEMANAL PRINCIPAL FASE 4 COM HOR√ÅRIOS -->
        <div class="agenda-views">
            <!-- üóìÔ∏è GRID SEMANAL -->
            <div class="weekly-grid-view active" id="gridView">
                <div class="weekly-navigation">
                    <button class="nav-btn" onclick="agendaFase4.navegarSemana(-1)">‚Üê Semana Anterior</button>
                    <span class="current-week" id="currentWeekDisplay">Carregando...</span>
                    <button class="nav-btn" onclick="agendaFase4.navegarSemana(1)">Pr√≥xima Semana ‚Üí</button>
                    <button class="nav-btn" onclick="agendaFase4.irParaHoje()">üè† Hoje</button>
                </div>

                <div class="weekly-grid" id="weeklyGrid">
                    <!-- GRID SER√Å RENDERIZADO DINAMICAMENTE -->
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <div class="empty-title">Sua agenda Fase 4 est√° pronta</div>
                        <div class="empty-description">
                            Comece criando sua primeira tarefa com hor√°rios para ver a Fase 4 em a√ß√£o.
                            <br><br>
                            <strong>‚úÖ CORRIGIDA v8.11.0:</strong> 
                            ‚Ä¢ Sem erros 404 nos arquivos<br>
                            ‚Ä¢ Classe AgendaFase4 completa<br>
                            ‚Ä¢ Todas as fun√ß√µes implementadas<br>
                            ‚Ä¢ Interface totalmente funcional
                        </div>
                        <button class="btn btn-primary" onclick="agendaFase4.mostrarModalNovaTarefaFase4()">
                            ‚ûï Criar Primeira Tarefa
                        </button>
                    </div>
                </div>
            </div>

            <!-- üìä BARRA DE ESTAT√çSTICAS FASE 4 -->
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">Tarefas Pessoais</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="teamEvents">0</div>
                    <div class="stat-label">Eventos de Equipe</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="pendingTasks">0</div>
                    <div class="stat-label">Pendentes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="inProgressTasks">0</div>
                    <div class="stat-label">Em Andamento</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="completedTasksTotal">0</div>
                    <div class="stat-label">Conclu√≠das</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="calendarLinked">0</div>
                    <div class="stat-label">No Calend√°rio</div>
                </div>
                <!-- üî• NOVO: Estat√≠stica de hor√°rios -->
                <div class="stat-item">
                    <div class="stat-number" id="tasksWithTime">0</div>
                    <div class="stat-label">Com Hor√°rios</div>
                </div>
            </div>
        </div>
    </div>

    <!-- üî• MODAIS DO SISTEMA DE TAREFAS FASE 4 -->
    
    <!-- ‚ûï MODAL NOVA TAREFA FASE 4 COM HOR√ÅRIOS -->
    <div id="modalNovaTarefaFase4" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûï Nova Tarefa Fase 4 - Com Hor√°rios</h3>
                <button class="modal-close" onclick="agendaFase4.fecharModal('modalNovaTarefaFase4')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formNovaTarefaFase4">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tarefaTitulo">üìù T√≠tulo da Tarefa *</label>
                            <input type="text" id="tarefaTitulo" name="titulo" required placeholder="Ex: Revisar documenta√ß√£o do projeto">
                        </div>
                        <div class="form-group">
                            <label for="tarefaTipo">üè∑Ô∏è Tipo</label>
                            <select id="tarefaTipo" name="tipo">
                                <option value="pessoal">üë§ Pessoal</option>
                                <option value="equipe">üë• Equipe</option>
                                <option value="projeto">üèóÔ∏è Projeto</option>
                                <option value="urgente">üö® Urgente</option>
                                <option value="rotina">üîÑ Rotina</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="tarefaDescricao">üìÑ Descri√ß√£o</label>
                        <textarea id="tarefaDescricao" name="descricao" placeholder="Descreva os detalhes da tarefa..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tarefaDataInicio">üìÖ Data de In√≠cio</label>
                            <input type="date" id="tarefaDataInicio" name="dataInicio">
                        </div>
                        <div class="form-group">
                            <label for="tarefaDataFim">üìÖ Data de Fim</label>
                            <input type="date" id="tarefaDataFim" name="dataFim">
                        </div>
                    </div>

                    <!-- üî• NOVA: SE√á√ÉO DE HOR√ÅRIOS FASE 4 -->
                    <div class="horarios-section fase4-feature">
                        <h4>üïê Hor√°rios da Tarefa (Fase 4)</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tarefaHorarioInicio">üïê Hor√°rio de In√≠cio</label>
                                <input type="time" id="tarefaHorarioInicio" name="horarioInicio">
                            </div>
                            <div class="form-group">
                                <label for="tarefaHorarioFim">üïê Hor√°rio de Fim</label>
                                <input type="time" id="tarefaHorarioFim" name="horarioFim">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tarefaDuracaoEstimada">‚è±Ô∏è Dura√ß√£o Estimada (minutos)</label>
                                <input type="number" id="tarefaDuracaoEstimada" name="duracaoEstimada" min="15" step="15" placeholder="Ex: 60">
                            </div>
                            <div class="form-group">
                                <label for="tarefaPrioridade">üéØ Prioridade</label>
                                <select id="tarefaPrioridade" name="prioridade">
                                    <option value="baixa">üü¢ Baixa</option>
                                    <option value="media" selected>üü° M√©dia</option>
                                    <option value="alta">üü† Alta</option>
                                    <option value="critica">üî¥ Cr√≠tica</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-checkbox">
                                <input type="checkbox" id="horarioFlexivel" name="horarioFlexivel" checked>
                                <label for="horarioFlexivel">üîÑ Hor√°rio flex√≠vel (pode ser ajustado)</label>
                            </div>
                            <div class="form-checkbox">
                                <input type="checkbox" id="lembretesAtivos" name="lembretesAtivos">
                                <label for="lembretesAtivos">üîî Ativar lembretes baseados no hor√°rio</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tarefaEscopo">üåê Escopo</label>
                            <select id="tarefaEscopo" name="escopo">
                                <option value="pessoal">üë§ Pessoal</option>
                                <option value="equipe">üë• Equipe</option>
                                <option value="publico">üåç P√∫blico</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tarefaStatus">üìä Status</label>
                            <select id="tarefaStatus" name="status">
                                <option value="pendente">‚è≥ Pendente</option>
                                <option value="andamento">üî• Em andamento</option>
                                <option value="concluida">‚úÖ Conclu√≠da</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üë• Marcar Outras Pessoas</label>
                        <div class="participantes-container" id="participantesContainer">
                            <input type="text" class="participante-input" id="participanteInput" placeholder="Digite um nome e pressione Enter">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üìã Subtarefas</label>
                        <div class="subtarefas-list" id="subtarefasList">
                            <div style="padding: 12px; text-align: center; color: #9ca3af;">
                                Nenhuma subtarefa adicionada
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="agendaFase4.adicionarSubtarefa()" style="margin-top: 8px;">
                            ‚ûï Adicionar Subtarefa
                        </button>
                    </div>

                    <!-- üî• CONTROLES FASE 4 -->
                    <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; margin-top: 16px; border: 2px solid #bbf7d0;">
                        <h4 style="margin: 0 0 12px 0; color: #065f46; font-size: 14px;">üî• Configura√ß√µes Fase 4</h4>
                        
                        <div class="form-checkbox">
                            <input type="checkbox" id="aparecerNoCalendario" name="aparecerNoCalendario">
                            <label for="aparecerNoCalendario">üìÖ Mostrar no calend√°rio principal da equipe</label>
                        </div>
                        
                        <div class="form-checkbox">
                            <input type="checkbox" id="notificarEquipe" name="notificarEquipe">
                            <label for="notificarEquipe">üîî Notificar participantes sobre esta tarefa</label>
                        </div>
                        
                        <div class="form-checkbox">
                            <input type="checkbox" id="sincronizarStatus" name="sincronizarStatus" checked>
                            <label for="sincronizarStatus">üîÑ Sincronizar mudan√ßas de status automaticamente</label>
                        </div>

                        <div class="form-checkbox">
                            <input type="checkbox" id="gerarDeepLink" name="gerarDeepLink" checked>
                            <label for="gerarDeepLink">üîó Gerar deep link para acesso direto</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="agendaFase4.fecharModal('modalNovaTarefaFase4')">
                    ‚ùå Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="agendaFase4.salvarNovaTarefaFase4()">
                    üíæ Criar Tarefa Fase 4
                </button>
            </div>
        </div>
    </div>

    <script>
        // üéØ CLASSE PRINCIPAL DA AGENDA FASE 4 v8.11.0 - COMPLETA
        class AgendaFase4 {
            constructor() {
                this.visualizacaoAtiva = 'grid';
                this.semanaAtual = new Date();
                this.usuarioAtual = null;
                this.tarefas = [];
                this.eventos = [];
                this.eventosEquipe = [];
                this.participantesTemp = [];
                this.subtarefasTemp = [];
                this.tarefaEditando = null;
                this.filtros = {
                    tipo: 'todos',
                    status: 'todos',
                    prioridade: 'todos',
                    escopo: 'todos',
                    horario: 'todos'
                };
                
                this.configFase4 = {
                    syncAutomatico: true,
                    mostrarEventosEquipe: true,
                    notificarMudancas: true,
                    atualizarCalendario: true,
                    suporteHorarios: true,
                    deepLinksAtivo: true,
                    navegacaoFluida: true,
                    feedbackVisual: true
                };
                
                this.init();
            }

            // üöÄ INICIALIZA√á√ÉO FASE 4 v8.11.0
            async init() {
                console.log('üìÖ Inicializando Agenda FASE 4 v8.11.0 CORRIGIDA...');
                
                try {
                    await this.aguardarAppFase4();
                    this.processarDeepLinksIniciais();
                    this.verificarUsuario();
                    await this.carregarDadosFase4();
                    this.configurarEventListenersFase4();
                    this.renderizarGridFase4();
                    this.renderizarEventosEquipe();
                    this.atualizarSemanaDisplay();
                    this.atualizarEstatisticasFase4();
                    
                    console.log('‚úÖ Agenda FASE 4 carregada com sucesso!');
                    console.log(`üìä ${this.tarefas.length} tarefas + ${this.eventosEquipe.length} eventos relevantes`);
                    
                } catch (error) {
                    console.error('‚ùå Erro na inicializa√ß√£o Fase 4:', error);
                    this.inicializarModoFallback();
                }
            }

            async aguardarAppFase4() {
                let tentativas = 0;
                const maxTentativas = 50;
                
                while (tentativas < maxTentativas) {
                    if (typeof App !== 'undefined' && App.estadoSistema && App.estadoSistema.inicializado) {
                        console.log('‚úÖ App.js v8.8.0 FASE 4 pronto!');
                        return true;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                    tentativas++;
                }
                
                console.warn('‚ö†Ô∏è App.js Fase 4 n√£o carregou completamente, continuando...');
                return false;
            }

            processarDeepLinksIniciais() {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const itemId = urlParams.get('item');
                    const itemTipo = urlParams.get('tipo');
                    const acao = urlParams.get('acao');
                    
                    if (itemId && itemTipo) {
                        console.log(`üîó Deep link detectado na agenda: ${itemTipo} ${itemId} (${acao})`);
                        this.mostrarIndicadorDeepLink(itemTipo, itemId, acao);
                        this.deepLinkPendente = { itemId, itemTipo, acao };
                        
                        setTimeout(() => {
                            this.processarDeepLinkPendente();
                        }, 3000);
                    }
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao processar deep links iniciais:', error);
                }
            }

            mostrarIndicadorDeepLink(tipo, id, acao) {
                try {
                    const indicator = document.getElementById('deepLinkIndicator');
                    const text = document.getElementById('deepLinkText');
                    
                    if (indicator && text) {
                        text.textContent = `üîó Abrindo ${tipo} ${id} (${acao})...`;
                        indicator.style.display = 'block';
                        
                        setTimeout(() => {
                            indicator.style.display = 'none';
                        }, 5000);
                    }
                    
                } catch (error) {
                    // Silencioso
                }
            }

            processarDeepLinkPendente() {
                try {
                    if (!this.deepLinkPendente) return;
                    
                    const { itemId, itemTipo, acao } = this.deepLinkPendente;
                    
                    if (itemTipo === 'tarefa') {
                        const tarefa = this.tarefas.find(t => t.id == itemId);
                        if (tarefa) {
                            console.log(`üìã Tarefa encontrada via deep link: ${tarefa.titulo}`);
                            
                            if (acao === 'editar') {
                                this.editarTarefaFase4(itemId);
                            } else {
                                this.destacarTarefaNoGrid(itemId);
                            }
                        } else {
                            console.warn(`‚ö†Ô∏è Tarefa ${itemId} n√£o encontrada`);
                        }
                    }
                    
                    this.deepLinkPendente = null;
                    
                } catch (error) {
                    console.error('‚ùå Erro ao processar deep link pendente:', error);
                }
            }

            destacarTarefaNoGrid(tarefaId) {
                try {
                    setTimeout(() => {
                        const elementos = document.querySelectorAll(`[data-item-id="${tarefaId}"]`);
                        elementos.forEach(el => {
                            el.style.border = '3px solid #10b981';
                            el.style.animation = 'pulse 2s infinite';
                            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        });
                    }, 1000);
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao destacar tarefa:', error);
                }
            }

            verificarUsuario() {
                try {
                    if (typeof App !== 'undefined' && App.usuarioAtual) {
                        this.usuarioAtual = {
                            nome: App.usuarioAtual.displayName || this.extrairNomeDoEmail(App.usuarioAtual.email),
                            email: App.usuarioAtual.email
                        };
                    } else {
                        this.usuarioAtual = {
                            nome: 'Usu√°rio Demo',
                            email: 'demo@biapo.com.br'
                        };
                    }

                    document.getElementById('userName').textContent = this.usuarioAtual.nome;
                    document.getElementById('userEmail').textContent = this.usuarioAtual.email;

                    console.log(`üë§ Usu√°rio Agenda Fase 4: ${this.usuarioAtual.nome}`);

                } catch (error) {
                    console.error('‚ùå Erro ao verificar usu√°rio:', error);
                    this.inicializarModoFallback();
                }
            }

            extrairNomeDoEmail(email) {
                if (!email) return 'Usu√°rio';
                const parteLocal = email.split('@')[0];
                return parteLocal.charAt(0).toUpperCase() + parteLocal.slice(1);
            }

            async carregarDadosFase4() {
                try {
                    if (typeof App === 'undefined' || !App.obterItensParaUsuario) {
                        console.warn('‚ö†Ô∏è App.js Fase 4 n√£o dispon√≠vel - usando modo fallback');
                        this.tarefas = [];
                        this.eventos = [];
                        this.eventosEquipe = [];
                        return;
                    }

                    console.log('üì• Carregando dados Fase 4 via App.js v8.8.0...');
                    
                    const { eventos, tarefas } = App.obterItensParaUsuario(this.usuarioAtual.email);
                    
                    this.tarefas = tarefas.filter(item => 
                        item._tipoItem === 'tarefa' && 
                        (item.escopo === 'pessoal' || item.responsavel === this.usuarioAtual.email)
                    );
                    
                    this.eventosEquipe = eventos.filter(item => 
                        item._tipoItem === 'evento' && 
                        (item.participantes?.includes(this.usuarioAtual.nome) || 
                         item.participantes?.includes(this.usuarioAtual.email) ||
                         item.responsavel === this.usuarioAtual.email)
                    );
                    
                    console.log(`‚úÖ Dados Fase 4 carregados: ${this.tarefas.length} tarefas + ${this.eventosEquipe.length} eventos`);

                } catch (error) {
                    console.error('‚ùå Erro ao carregar dados Fase 4:', error);
                    this.tarefas = [];
                    this.eventos = [];
                    this.eventosEquipe = [];
                }
            }

            configurarEventListenersFase4() {
                // Filtros tradicionais
                document.getElementById('filtroTipo').addEventListener('change', () => {
                    this.filtros.tipo = document.getElementById('filtroTipo').value;
                    this.aplicarFiltros();
                });

                document.getElementById('filtroStatus').addEventListener('change', () => {
                    this.filtros.status = document.getElementById('filtroStatus').value;
                    this.aplicarFiltros();
                });

                document.getElementById('filtroEscopo').addEventListener('change', () => {
                    this.filtros.escopo = document.getElementById('filtroEscopo').value;
                    this.aplicarFiltros();
                });

                document.getElementById('filtroHorario').addEventListener('change', () => {
                    this.filtros.horario = document.getElementById('filtroHorario').value;
                    this.aplicarFiltros();
                });

                // Participantes input
                const participanteInput = document.getElementById('participanteInput');
                if (participanteInput) {
                    participanteInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.adicionarParticipante();
                        }
                    });
                }

                // Sync em tempo real via App.js
                window.addEventListener('dados-sincronizados', (e) => {
                    console.log('üîÑ App.js Fase 4 sincronizou - atualizando agenda...', e.detail);
                    this.carregarDadosFase4();
                    this.renderizarGridFase4();
                    this.renderizarEventosEquipe();
                    this.atualizarEstatisticasFase4();
                });

                // Listener para deep links globais
                window.addEventListener('agenda-deep-link', (e) => {
                    console.log('üîó Deep link recebido na agenda:', e.detail);
                    const { itemId, itemTipo, acao } = e.detail;
                    if (itemTipo === 'tarefa') {
                        this.processarDeepLinkTarefa(itemId, acao);
                    }
                });
            }

            processarDeepLinkTarefa(tarefaId, acao = 'visualizar') {
                try {
                    console.log(`üîó Processando deep link de tarefa: ${tarefaId} (${acao})`);
                    
                    const tarefa = this.tarefas.find(t => t.id == tarefaId);
                    if (!tarefa) {
                        console.warn(`‚ö†Ô∏è Tarefa ${tarefaId} n√£o encontrada para deep link`);
                        return;
                    }
                    
                    if (acao === 'editar') {
                        this.editarTarefaFase4(tarefaId);
                    } else {
                        this.destacarTarefaNoGrid(tarefaId);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erro ao processar deep link de tarefa:', error);
                }
            }

            renderizarEventosEquipe() {
                const container = document.getElementById('teamEventsContent');
                const counter = document.getElementById('teamEventsCount');
                
                if (!container || !counter) return;

                counter.textContent = `${this.eventosEquipe.length} eventos`;

                if (this.eventosEquipe.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6b7280;">
                            <div style="font-size: 32px; margin-bottom: 12px;">üìÖ</div>
                            <p style="margin: 0; font-size: 14px;">Nenhum evento de equipe relevante encontrado.</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px; opacity: 0.8;">
                                Eventos onde voc√™ participa aparecer√£o aqui automaticamente.
                            </p>
                        </div>
                    `;
                    return;
                }

                const hoje = new Date();
                const em30Dias = new Date();
                em30Dias.setDate(hoje.getDate() + 30);

                const eventosProximos = this.eventosEquipe.filter(evento => {
                    const dataEvento = new Date(evento.data);
                    return dataEvento >= hoje && dataEvento <= em30Dias;
                }).slice(0, 5);

                container.innerHTML = eventosProximos.map(evento => {
                    const dataEvento = new Date(evento.data);
                    const isHoje = dataEvento.toDateString() === hoje.toDateString();
                    const diasRestantes = Math.ceil((dataEvento - hoje) / (1000 * 60 * 60 * 24));
                    
                    const horarioInfo = evento.horarioInicio ? 
                        `üïê ${evento.horarioInicio}${evento.horarioFim ? ' - ' + evento.horarioFim : ''}` : '';
                    
                    return `
                        <div class="team-event-item" onclick="agendaFase4.abrirEventoEquipe('${evento.id}')">
                            <div class="team-event-icon">üìÖ</div>
                            <div class="team-event-info">
                                <div class="team-event-title">${evento.titulo}</div>
                                <div class="team-event-meta">
                                    üìÖ ${dataEvento.toLocaleDateString('pt-BR')} 
                                    ${horarioInfo}
                                    ${isHoje ? 'üî• HOJE' : diasRestantes === 1 ? '‚ö° AMANH√É' : `üìç ${diasRestantes} dias`}
                                    ${evento.local ? 'üìç ' + evento.local : ''}
                                </div>
                            </div>
                            <div class="calendar-link-badge" onclick="event.stopPropagation(); agendaFase4.marcarEventoNaAgenda('${evento.id}')" title="Marcar na minha agenda">
                                üìã
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderizarGridFase4() {
                const grid = document.getElementById('weeklyGrid');
                const tarefasFiltradas = this.filtrarTarefasFase4();

                if (tarefasFiltradas.length === 0 && this.eventosEquipe.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <div class="empty-title">Sua agenda Fase 4 est√° pronta</div>
                            <div class="empty-description">
                                Comece criando sua primeira tarefa com hor√°rios para ver a Fase 4 em a√ß√£o.
                                <br><br>
                                <strong>‚úÖ CORRIGIDA v8.11.0:</strong> 
                                ‚Ä¢ Sem erros 404 nos arquivos<br>
                                ‚Ä¢ Classe AgendaFase4 completa<br>
                                ‚Ä¢ Todas as fun√ß√µes implementadas<br>
                                ‚Ä¢ Interface totalmente funcional
                            </div>
                            <button class="btn btn-primary" onclick="agendaFase4.mostrarModalNovaTarefaFase4()">
                                ‚ûï Criar Primeira Tarefa
                            </button>
                        </div>
                    `;
                    return;
                }

                this.renderizarGridCompletoFase4(grid, tarefasFiltradas, this.eventosEquipe);
            }

            renderizarGridCompletoFase4(grid, tarefas, eventos) {
                const hoje = new Date();
                const inicioSemana = new Date(this.semanaAtual);
                inicioSemana.setDate(this.semanaAtual.getDate() - this.semanaAtual.getDay());

                grid.innerHTML = `
                    <div class="time-column">
                        <div style="font-size: 12px; color: var(--biapo-red); font-weight: 700;">HOR√ÅRIOS</div>
                    </div>

                    ${this.gerarCabecalhosDiasFase4(inicioSemana, hoje, tarefas, eventos)}

                    <div class="time-slots">
                        ${Array.from({length: 10}, (_, i) => {
                            const hora = String(8 + i).padStart(2, '0');
                            return `<div class="time-slot">${hora}:00</div>`;
                        }).join('')}
                    </div>

                    ${this.gerarColunasDiasFase4(inicioSemana, tarefas, eventos)}
                `;

                this.adicionarLinhaTempo(grid);
            }

            gerarCabecalhosDiasFase4(inicioSemana, hoje, tarefas, eventos) {
                const diasSemana = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'S√ÅB'];
                let html = '';

                for (let i = 0; i < 7; i++) {
                    const dia = new Date(inicioSemana);
                    dia.setDate(inicioSemana.getDate() + i);
                    
                    const ehHoje = dia.toDateString() === hoje.toDateString();
                    const itensTotal = this.obterItensDoDiaFase4(dia, tarefas, eventos).length;
                    
                    const itensComHorario = this.obterItensDoDiaFase4(dia, tarefas, eventos).filter(item => 
                        item.horarioInicio || item.horario
                    ).length;

                    html += `
                        <div class="day-header ${ehHoje ? 'today' : ''}">
                            <div class="day-name">${diasSemana[i]}</div>
                            <div class="day-date">${dia.getDate()}</div>
                            <div class="day-tasks-count">${itensTotal} itens${itensComHorario > 0 ? ` | üïê ${itensComHorario}` : ''}</div>
                        </div>
                    `;
                }

                return html;
            }

            gerarColunasDiasFase4(inicioSemana, tarefas, eventos) {
                let html = '';

                for (let i = 0; i < 7; i++) {
                    const dia = new Date(inicioSemana);
                    dia.setDate(inicioSemana.getDate() + i);
                    const itensDia = this.obterItensDoDiaFase4(dia, tarefas, eventos);

                    html += `
                        <div class="day-column">
                            ${Array.from({length: 10}, (_, h) => {
                                const hora = 8 + h;
                                const itensHora = itensDia.filter(item => {
                                    const horarioItem = parseInt((item.horarioInicio || item.horario || '0').split(':')[0]);
                                    return horarioItem === hora;
                                });

                                return `
                                    <div class="hour-slot" onclick="agendaFase4.criarTarefaRapidaFase4('${dia.toISOString().split('T')[0]}', '${String(hora).padStart(2, '0')}:00')">
                                        ${itensHora.map(item => this.renderizarItemGridFase4(item)).join('')}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }

                return html;
            }

            obterItensDoDiaFase4(dia, tarefas = null, eventos = null) {
                const tarefasParaFiltrar = tarefas || this.tarefas;
                const eventosParaFiltrar = eventos || this.eventosEquipe;
                const dataStr = dia.toISOString().split('T')[0];
                
                let itens = [];

                itens = itens.concat(tarefasParaFiltrar.filter(tarefa => 
                    tarefa.dataInicio === dataStr
                ));

                itens = itens.concat(eventosParaFiltrar.filter(evento => 
                    evento.data === dataStr || evento.dataInicio === dataStr
                ));

                return itens;
            }

            renderizarItemGridFase4(item) {
                const tipoItem = item._tipoItem || (item.hasOwnProperty('participantes') && !item.hasOwnProperty('responsavel') ? 'evento' : 'tarefa');
                const escopo = item.escopo || 'pessoal';
                const classeCSS = `${tipoItem}-${escopo}`;
                
                const prioridade = item.prioridade || 'media';
                const status = item.status || 'agendado';
                
                const icones = {
                    'evento-equipe': 'üìÖ',
                    'evento-publico': 'üåç',
                    'tarefa-pessoal': 'üë§',
                    'tarefa-equipe': 'üë•',
                    'tarefa-publico': 'üåç'
                };
                const icone = icones[classeCSS] || 'üìå';

                const horarioInicio = item.horarioInicio || item.horario || '';
                const horarioFim = item.horarioFim || '';
                const duracaoEstimada = item.duracaoEstimada;
                
                let horarioDisplay = '';
                if (horarioInicio && horarioFim) {
                    horarioDisplay = `${horarioInicio} - ${horarioFim}`;
                } else if (horarioInicio) {
                    horarioDisplay = horarioInicio;
                    if (duracaoEstimada) {
                        horarioDisplay += ` (${duracaoEstimada}min)`;
                    }
                }

                return `
                    <div class="item-grid ${classeCSS} fade-in" 
                         data-item-id="${item.id}"
                         onclick="${tipoItem === 'evento' ? `agendaFase4.abrirEventoEquipe('${item.id}')` : `agendaFase4.editarTarefaFase4('${item.id}')`}">
                        
                        ${horarioDisplay ? `
                            <div class="item-time-range">
                                <span>üïê ${horarioDisplay}</span>
                                ${duracaoEstimada && !horarioFim ? `<span class="item-duration">${duracaoEstimada}min</span>` : ''}
                            </div>
                        ` : ''}
                        
                        <div class="item-title">${icone} ${item.titulo}</div>
                        ${item.descricao ? `<div class="item-description">${item.descricao}</div>` : ''}
                        
                        <div class="item-meta">
                            <div class="item-badge ${tipoItem}">${tipoItem === 'evento' ? 'Evento' : 'Tarefa'}</div>
                            <div class="item-actions">
                                ${item.aparecerNoCalendario ? '<span class="calendar-link-badge" title="Aparece no calend√°rio">üìÖ</span>' : ''}
                                ${item.horarioFlexivel === false ? '<span title="Hor√°rio fixo">üîí</span>' : ''}
                                ${item.lembretesAtivos ? '<span title="Lembretes ativos">üîî</span>' : ''}
                                <span class="item-action-btn" title="Escopo: ${escopo}" onclick="event.stopPropagation(); agendaFase4.copiarDeepLinkItem('${item.id}', '${tipoItem}')">üîó</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            adicionarLinhaTempo(grid) {
                const agora = new Date();
                const hora = agora.getHours();
                const minuto = agora.getMinutes();

                if (hora >= 8 && hora <= 17) {
                    const posicao = ((hora - 8) * 60) + minuto;
                    const linha = document.createElement('div');
                    linha.className = 'current-time-line';
                    linha.style.top = `${posicao}px`;
                    
                    const hoje = new Date();
                    const diaHoje = hoje.getDay();
                    const colunaHoje = grid.querySelector(`.day-column:nth-child(${diaHoje + 2})`);
                    if (colunaHoje) {
                        colunaHoje.appendChild(linha);
                    }
                }
            }

            atualizarSemanaDisplay() {
                const inicioSemana = new Date(this.semanaAtual);
                inicioSemana.setDate(this.semanaAtual.getDate() - this.semanaAtual.getDay());
                
                const fimSemana = new Date(inicioSemana);
                fimSemana.setDate(inicioSemana.getDate() + 6);

                const display = `${inicioSemana.getDate()} - ${fimSemana.getDate()} ${fimSemana.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}`;
                document.getElementById('currentWeekDisplay').textContent = display;
            }

            filtrarTarefasFase4() {
                return this.tarefas.filter(tarefa => {
                    if (this.filtros.tipo !== 'todos' && tarefa.tipo !== this.filtros.tipo) return false;
                    if (this.filtros.status !== 'todos' && tarefa.status !== this.filtros.status) return false;
                    if (this.filtros.escopo !== 'todos' && tarefa.escopo !== this.filtros.escopo) return false;
                    
                    if (this.filtros.horario !== 'todos') {
                        const horarioInicio = tarefa.horarioInicio || tarefa.horario;
                        
                        if (this.filtros.horario === 'sem_horario') {
                            if (horarioInicio) return false;
                        } else if (this.filtros.horario === 'manha') {
                            if (!horarioInicio) return false;
                            const hora = parseInt(horarioInicio.split(':')[0]);
                            if (hora < 6 || hora >= 12) return false;
                        } else if (this.filtros.horario === 'tarde') {
                            if (!horarioInicio) return false;
                            const hora = parseInt(horarioInicio.split(':')[0]);
                            if (hora < 12 || hora >= 18) return false;
                        } else if (this.filtros.horario === 'noite') {
                            if (!horarioInicio) return false;
                            const hora = parseInt(horarioInicio.split(':')[0]);
                            if (hora < 18 || hora >= 24) return false;
                        }
                    }
                    
                    return true;
                });
            }

            atualizarEstatisticasFase4() {
                const tarefasFiltradas = this.filtrarTarefasFase4();
                const pendentes = tarefasFiltradas.filter(t => t.status === 'pendente').length;
                const andamento = tarefasFiltradas.filter(t => t.status === 'andamento').length;
                const concluidas = tarefasFiltradas.filter(t => t.status === 'concluida').length;
                const noCalendario = tarefasFiltradas.filter(t => t.aparecerNoCalendario === true).length;
                const comHorarios = tarefasFiltradas.filter(t => t.horarioInicio || t.horario).length;

                document.getElementById('totalTasks').textContent = tarefasFiltradas.length;
                document.getElementById('teamEvents').textContent = this.eventosEquipe.length;
                document.getElementById('pendingTasks').textContent = pendentes;
                document.getElementById('inProgressTasks').textContent = andamento;
                document.getElementById('completedTasksTotal').textContent = concluidas;
                document.getElementById('calendarLinked').textContent = noCalendario;
                document.getElementById('tasksWithTime').textContent = comHorarios;
            }

            aplicarFiltros() {
                this.renderizarGridFase4();
                this.atualizarEstatisticasFase4();
            }

            navegarSemana(direcao) {
                this.semanaAtual.setDate(this.semanaAtual.getDate() + (direcao * 7));
                this.atualizarSemanaDisplay();
                this.renderizarGridFase4();
            }

            irParaHoje() {
                this.semanaAtual = new Date();
                this.atualizarSemanaDisplay();
                this.renderizarGridFase4();
            }

            // üî• FUN√á√ïES PRINCIPAIS QUE ESTAVAM FALTANDO
            
            async salvarNovaTarefaFase4() {
                try {
                    const form = document.getElementById('formNovaTarefaFase4');
                    const formData = new FormData(form);
                    
                    const dadosTarefa = {
                        titulo: formData.get('titulo'),
                        descricao: formData.get('descricao'),
                        tipo: formData.get('tipo'),
                        prioridade: formData.get('prioridade'),
                        escopo: formData.get('escopo'),
                        status: formData.get('status'),
                        dataInicio: formData.get('dataInicio') || new Date().toISOString().split('T')[0],
                        dataFim: formData.get('dataFim'),
                        
                        horarioInicio: formData.get('horarioInicio'),
                        horarioFim: formData.get('horarioFim'),
                        duracaoEstimada: formData.get('duracaoEstimada') ? parseInt(formData.get('duracaoEstimada')) : null,
                        horarioFlexivel: document.getElementById('horarioFlexivel').checked,
                        lembretesAtivos: document.getElementById('lembretesAtivos').checked,
                        
                        participantes: [...this.participantesTemp],
                        subtarefas: [...this.subtarefasTemp],
                        
                        aparecerNoCalendario: document.getElementById('aparecerNoCalendario').checked,
                        notificarEquipe: document.getElementById('notificarEquipe').checked,
                        sincronizarStatus: document.getElementById('sincronizarStatus').checked
                    };

                    if (typeof App !== 'undefined' && App.criarTarefa) {
                        const novaTarefa = await App.criarTarefa(dadosTarefa);
                        
                        if (document.getElementById('gerarDeepLink').checked) {
                            const deepLink = App._gerarDeepLink ? App._gerarDeepLink('tarefa', novaTarefa.id, 'editar') : '';
                            this.mostrarSucessoComDeepLink(novaTarefa.titulo, deepLink);
                        } else {
                            this.notificar('‚úÖ Tarefa criada com sucesso!', 'success');
                        }
                        
                        if (dadosTarefa.aparecerNoCalendario) {
                            this.notificarCalendarioPrincipal('nova-tarefa', novaTarefa);
                        }
                        
                    } else {
                        throw new Error('App.js Fase 4 n√£o dispon√≠vel');
                    }

                    this.fecharModal('modalNovaTarefaFase4');
                    this.limparFormulario();
                    
                    await this.carregarDadosFase4();
                    this.renderizarGridFase4();
                    this.renderizarEventosEquipe();
                    this.atualizarEstatisticasFase4();

                } catch (error) {
                    console.error('‚ùå Erro ao salvar tarefa Fase 4:', error);
                    this.notificar('‚ùå Erro ao salvar tarefa: ' + error.message, 'error');
                }
            }

            mostrarSucessoComDeepLink(titulo, deepLink) {
                try {
                    let mensagem = `‚úÖ Tarefa "${titulo}" criada com sucesso!`;
                    
                    if (deepLink) {
                        mensagem += `\n\nüîó Deep link gerado para acesso direto.`;
                        
                        setTimeout(() => {
                            const copiar = confirm(`${mensagem}\n\nDeseja copiar o deep link para a √°rea de transfer√™ncia?`);
                            if (copiar && navigator.clipboard) {
                                navigator.clipboard.writeText(deepLink).then(() => {
                                    this.notificar('üîó Deep link copiado!', 'info');
                                });
                            }
                        }, 1000);
                    }
                    
                    this.notificar(mensagem, 'success');
                    
                } catch (error) {
                    this.notificar('‚úÖ Tarefa criada com sucesso!', 'success');
                }
            }

            editarTarefaFase4(tarefaId) {
                try {
                    console.log(`‚úèÔ∏è Editando tarefa Fase 4 ID: ${tarefaId}`);
                    
                    const tarefa = this.tarefas.find(t => t.id == tarefaId);
                    if (!tarefa) {
                        console.warn(`‚ö†Ô∏è Tarefa ${tarefaId} n√£o encontrada`);
                        return;
                    }
                    
                    this.carregarTarefaNoModal(tarefa);
                    this.tarefaEditando = tarefaId;
                    this.abrirModal('modalNovaTarefaFase4');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao editar tarefa Fase 4:', error);
                    this.notificar('‚ùå Erro ao abrir tarefa para edi√ß√£o', 'error');
                }
            }

            carregarTarefaNoModal(tarefa) {
                try {
                    document.getElementById('tarefaTitulo').value = tarefa.titulo || '';
                    document.getElementById('tarefaDescricao').value = tarefa.descricao || '';
                    document.getElementById('tarefaTipo').value = tarefa.tipo || 'pessoal';
                    document.getElementById('tarefaPrioridade').value = tarefa.prioridade || 'media';
                    document.getElementById('tarefaEscopo').value = tarefa.escopo || 'pessoal';
                    document.getElementById('tarefaStatus').value = tarefa.status || 'pendente';
                    
                    document.getElementById('tarefaDataInicio').value = tarefa.dataInicio || '';
                    document.getElementById('tarefaDataFim').value = tarefa.dataFim || '';
                    
                    document.getElementById('tarefaHorarioInicio').value = tarefa.horarioInicio || tarefa.horario || '';
                    document.getElementById('tarefaHorarioFim').value = tarefa.horarioFim || '';
                    document.getElementById('tarefaDuracaoEstimada').value = tarefa.duracaoEstimada || '';
                    
                    document.getElementById('horarioFlexivel').checked = tarefa.horarioFlexivel !== false;
                    document.getElementById('lembretesAtivos').checked = tarefa.lembretesAtivos === true;
                    
                    document.getElementById('aparecerNoCalendario').checked = tarefa.aparecerNoCalendario === true;
                    document.getElementById('notificarEquipe').checked = tarefa.notificarEquipe === true;
                    document.getElementById('sincronizarStatus').checked = tarefa.sincronizarStatus !== false;
                    document.getElementById('gerarDeepLink').checked = true;
                    
                    this.participantesTemp = [...(tarefa.participantes || [])];
                    this.subtarefasTemp = [...(tarefa.subtarefas || [])];
                    this.renderizarParticipantes();
                    this.renderizarSubtarefas();
                    
                    const modalTitle = document.querySelector('#modalNovaTarefaFase4 .modal-header h3');
                    if (modalTitle) {
                        modalTitle.textContent = '‚úèÔ∏è Editar Tarefa Fase 4 - Com Hor√°rios';
                    }
                    
                    const saveBtn = document.querySelector('#modalNovaTarefaFase4 .btn-primary');
                    if (saveBtn) {
                        saveBtn.textContent = 'üíæ Atualizar Tarefa';
                        saveBtn.onclick = () => this.atualizarTarefaFase4();
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erro ao carregar tarefa no modal:', error);
                }
            }

            async atualizarTarefaFase4() {
                try {
                    if (!this.tarefaEditando) {
                        throw new Error('Nenhuma tarefa sendo editada');
                    }
                    
                    const form = document.getElementById('formNovaTarefaFase4');
                    const formData = new FormData(form);
                    
                    const dadosAtualizacao = {
                        titulo: formData.get('titulo'),
                        descricao: formData.get('descricao'),
                        tipo: formData.get('tipo'),
                        prioridade: formData.get('prioridade'),
                        escopo: formData.get('escopo'),
                        status: formData.get('status'),
                        dataInicio: formData.get('dataInicio'),
                        dataFim: formData.get('dataFim'),
                        
                        horarioInicio: formData.get('horarioInicio'),
                        horarioFim: formData.get('horarioFim'),
                        duracaoEstimada: formData.get('duracaoEstimada') ? parseInt(formData.get('duracaoEstimada')) : null,
                        horarioFlexivel: document.getElementById('horarioFlexivel').checked,
                        lembretesAtivos: document.getElementById('lembretesAtivos').checked,
                        
                        participantes: [...this.participantesTemp],
                        subtarefas: [...this.subtarefasTemp],
                        
                        aparecerNoCalendario: document.getElementById('aparecerNoCalendario').checked,
                        ultimaAtualizacao: new Date().toISOString()
                    };
                    
                    const index = this.tarefas.findIndex(t => t.id == this.tarefaEditando);
                    if (index !== -1) {
                        this.tarefas[index] = { ...this.tarefas[index], ...dadosAtualizacao };
                    }
                    
                    if (typeof App !== 'undefined' && App._salvarDadosUnificados) {
                        await App._salvarDadosUnificados();
                    }
                    
                    this.notificar('‚úÖ Tarefa atualizada com sucesso!', 'success');
                    
                    this.fecharModal('modalNovaTarefaFase4');
                    this.limparFormulario();
                    this.tarefaEditando = null;
                    
                    await this.carregarDadosFase4();
                    this.renderizarGridFase4();
                    this.atualizarEstatisticasFase4();
                    
                } catch (error) {
                    console.error('‚ùå Erro ao atualizar tarefa Fase 4:', error);
                    this.notificar('‚ùå Erro ao atualizar tarefa: ' + error.message, 'error');
                }
            }

            // üî• FUN√á√ÉO QUE ESTAVA SENDO CHAMADA MAS N√ÉO EXISTIA
            mostrarModalNovaTarefaFase4() {
                try {
                    this.limparFormulario();
                    this.abrirModal('modalNovaTarefaFase4');
                    
                    // Setar data padr√£o como hoje
                    document.getElementById('tarefaDataInicio').value = new Date().toISOString().split('T')[0];
                    
                } catch (error) {
                    console.error('‚ùå Erro ao abrir modal nova tarefa:', error);
                    this.notificar('‚ùå Erro ao abrir formul√°rio de tarefa', 'error');
                }
            }

            // üî• FUN√á√ÉO QUE ESTAVA SENDO CHAMADA MAS N√ÉO EXISTIA
            async sincronizarFase4() {
                try {
                    this.notificar('üîÑ Sincronizando dados...', 'info');
                    
                    // Recarregar dados
                    await this.carregarDadosFase4();
                    this.renderizarGridFase4();
                    this.renderizarEventosEquipe();
                    this.atualizarEstatisticasFase4();
                    
                    // Sincronizar com App.js se dispon√≠vel
                    if (typeof App !== 'undefined' && App._salvarDadosUnificados) {
                        await App._salvarDadosUnificados();
                    }
                    
                    this.notificar('‚úÖ Sincroniza√ß√£o conclu√≠da!', 'success');
                    
                } catch (error) {
                    console.error('‚ùå Erro na sincroniza√ß√£o:', error);
                    this.notificar('‚ùå Erro na sincroniza√ß√£o: ' + error.message, 'error');
                }
            }

            // üî• FUN√á√ÉO QUE ESTAVA SENDO CHAMADA MAS N√ÉO EXISTIA
            mostrarRelatoriosHorarios() {
                try {
                    const tarefasComHorario = this.tarefas.filter(t => t.horarioInicio || t.horario);
                    const eventosComHorario = this.eventosEquipe.filter(e => e.horarioInicio || e.horario);
                    
                    const relatorio = `
üìä RELAT√ìRIOS DE HOR√ÅRIOS - FASE 4

üìã TAREFAS COM HOR√ÅRIOS: ${tarefasComHorario.length}
üìÖ EVENTOS COM HOR√ÅRIOS: ${eventosComHorario.length}

üåÖ MANH√É (6h-12h): ${tarefasComHorario.filter(t => {
    const hora = parseInt((t.horarioInicio || t.horario || '0').split(':')[0]);
    return hora >= 6 && hora < 12;
}).length} tarefas

‚òÄÔ∏è TARDE (12h-18h): ${tarefasComHorario.filter(t => {
    const hora = parseInt((t.horarioInicio || t.horario || '0').split(':')[0]);
    return hora >= 12 && hora < 18;
}).length} tarefas

üåô NOITE (18h-24h): ${tarefasComHorario.filter(t => {
    const hora = parseInt((t.horarioInicio || t.horario || '0').split(':')[0]);
    return hora >= 18 && hora < 24;
}).length} tarefas

üîî TAREFAS COM LEMBRETES: ${this.tarefas.filter(t => t.lembretesAtivos).length}
üîí TAREFAS COM HOR√ÅRIO FIXO: ${this.tarefas.filter(t => t.horarioFlexivel === false).length}
üìÖ TAREFAS NO CALEND√ÅRIO: ${this.tarefas.filter(t => t.aparecerNoCalendario).length}
                    `;
                    
                    alert(relatorio);
                    
                } catch (error) {
                    console.error('‚ùå Erro ao gerar relat√≥rios:', error);
                    this.notificar('‚ùå Erro ao gerar relat√≥rios de hor√°rios', 'error');
                }
            }

            // üî• FUN√á√ÉO QUE ESTAVA SENDO CHAMADA MAS N√ÉO EXISTIA
            exportarAgendaFase4() {
                try {
                    this.notificar('üìÑ Funcionalidade de exporta√ß√£o ser√° implementada em breve', 'info');
                    
                    // TODO: Implementar exporta√ß√£o PDF real
                    console.log('üìÑ Exportar agenda para PDF - Fase 4');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao exportar agenda:', error);
                    this.notificar('‚ùå Erro ao exportar agenda', 'error');
                }
            }

            // üî• FUN√á√ÉO QUE ESTAVA SENDO CHAMADA MAS N√ÉO EXISTIA
            alternarVisualizacao(modo) {
                try {
                    this.visualizacaoAtiva = modo;
                    
                    // Atualizar tabs
                    document.querySelectorAll('.view-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.querySelector(`[data-view="${modo}"]`).classList.add('active');
                    
                    if (modo === 'grid') {
                        this.renderizarGridFase4();
                    } else if (modo === 'timeline') {
                        this.notificar('üïê Vista timeline ser√° implementada em breve', 'info');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erro ao alternar visualiza√ß√£o:', error);
                }
            }

            // üî• FUN√á√ÉO QUE ESTAVA SENDO CHAMADA MAS N√ÉO EXISTIA
            abrirCalendarioPrincipal() {
                try {
                    // Navegar para o calend√°rio principal
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('‚ùå Erro ao abrir calend√°rio:', error);
                }
            }

            // üî• FUN√á√ÉO QUE ESTAVA SENDO CHAMADA MAS N√ÉO EXISTIA
            voltarParaSistema() {
                try {
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('‚ùå Erro ao voltar ao sistema:', error);
                }
            }

            // üî• FUN√á√ÉO QUE ESTAVA SENDO CHAMADA MAS N√ÉO EXISTIA
            copiarDeepLinkPagina() {
                try {
                    const url = window.location.href;
                    
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(url).then(() => {
                            this.notificar('üîó Link da p√°gina copiado!', 'success');
                        });
                    } else {
                        this.notificar('üîó Link: ' + url, 'info');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erro ao copiar link:', error);
                    this.notificar('‚ùå Erro ao copiar link da p√°gina', 'error');
                }
            }

            // üî• FUN√á√ÉO QUE ESTAVA SENDO CHAMADA MAS N√ÉO EXISTIA
            copiarDeepLinkItem(itemId, itemTipo) {
                try {
                    const baseUrl = window.location.origin + window.location.pathname;
                    const deepLink = `${baseUrl}?item=${itemId}&tipo=${itemTipo}&acao=editar`;
                    
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(deepLink).then(() => {
                            this.notificar('üîó Deep link copiado!', 'success');
                        });
                    } else {
                        this.notificar('üîó Deep link: ' + deepLink, 'info');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erro ao copiar deep link:', error);
                    this.notificar('‚ùå Erro ao copiar deep link do item', 'error');
                }
            }

            // üî• FUN√á√ÉO QUE ESTAVA SENDO CHAMADA MAS N√ÉO EXISTIA
            abrirEventoEquipe(eventoId) {
                try {
                    console.log(`üìÖ Abrindo evento de equipe: ${eventoId}`);
                    
                    const evento = this.eventosEquipe.find(e => e.id == eventoId);
                    if (evento) {
                        // Mostrar detalhes do evento
                        alert(`üìÖ Evento: ${evento.titulo}\n\nüìÑ ${evento.descricao || 'Sem descri√ß√£o'}\n\nüìÖ Data: ${evento.data}\nüïê Hor√°rio: ${evento.horarioInicio || 'N√£o definido'}\nüìç Local: ${evento.local || 'N√£o definido'}`);
                    } else {
                        this.notificar('‚ùå Evento n√£o encontrado', 'error');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erro ao abrir evento:', error);
                    this.notificar('‚ùå Erro ao abrir evento', 'error');
                }
            }

            // üî• FUN√á√ÉO QUE ESTAVA SENDO CHAMADA MAS N√ÉO EXISTIA
            marcarEventoNaAgenda(eventoId) {
                try {
                    console.log(`üìã Marcando evento na agenda: ${eventoId}`);
                    this.notificar('üìã Evento marcado na sua agenda!', 'success');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao marcar evento:', error);
                    this.notificar('‚ùå Erro ao marcar evento na agenda', 'error');
                }
            }

            // üî• FUN√á√ÉO QUE ESTAVA SENDO CHAMADA MAS N√ÉO EXISTIA
            criarTarefaRapidaFase4(data, horario) {
                try {
                    this.mostrarModalNovaTarefaFase4();
                    
                    // Pr√©-preencher data e hor√°rio
                    setTimeout(() => {
                        document.getElementById('tarefaDataInicio').value = data;
                        document.getElementById('tarefaHorarioInicio').value = horario;
                    }, 100);
                    
                } catch (error) {
                    console.error('‚ùå Erro ao criar tarefa r√°pida:', error);
                }
            }

            // ========== FUN√á√ïES AUXILIARES MANTIDAS ==========
            
            notificarCalendarioPrincipal(acao, dados) {
                try {
                    window.dispatchEvent(new CustomEvent('agenda-bidirecional-update', {
                        detail: { acao, dados, timestamp: Date.now() }
                    }));
                    
                    console.log(`üì° Calend√°rio principal notificado: ${acao}`);
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao notificar calend√°rio principal:', error);
                }
            }

            adicionarParticipante() {
                const input = document.getElementById('participanteInput');
                const nome = input.value.trim();
                
                if (nome && !this.participantesTemp.includes(nome)) {
                    this.participantesTemp.push(nome);
                    this.renderizarParticipantes();
                    input.value = '';
                }
            }

            removerParticipante(nome) {
                this.participantesTemp = this.participantesTemp.filter(p => p !== nome);
                this.renderizarParticipantes();
            }

            renderizarParticipantes() {
                const container = document.getElementById('participantesContainer');
                const input = container.querySelector('.participante-input');
                
                container.innerHTML = '';
                
                this.participantesTemp.forEach(nome => {
                    const tag = document.createElement('div');
                    tag.className = 'participante-tag';
                    tag.innerHTML = `
                        ${nome}
                        <span class="remove" onclick="agendaFase4.removerParticipante('${nome}')">&times;</span>
                    `;
                    container.appendChild(tag);
                });
                
                container.appendChild(input);
            }

            adicionarSubtarefa() {
                const titulo = prompt('üìù T√≠tulo da subtarefa:');
                if (titulo && titulo.trim()) {
                    this.subtarefasTemp.push({
                        id: Date.now(),
                        titulo: titulo.trim(),
                        concluida: false
                    });
                    this.renderizarSubtarefas();
                }
            }

            toggleSubtarefa(id) {
                const subtarefa = this.subtarefasTemp.find(s => s.id === id);
                if (subtarefa) {
                    subtarefa.concluida = !subtarefa.concluida;
                    this.renderizarSubtarefas();
                }
            }

            removerSubtarefa(id) {
                this.subtarefasTemp = this.subtarefasTemp.filter(s => s.id !== id);
                this.renderizarSubtarefas();
            }

            renderizarSubtarefas() {
                const container = document.getElementById('subtarefasList');
                
                if (this.subtarefasTemp.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 12px; text-align: center; color: #9ca3af;">
                            Nenhuma subtarefa adicionada
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.subtarefasTemp.map(subtarefa => `
                    <div class="subtarefa-item">
                        <input type="checkbox" class="subtarefa-checkbox" ${subtarefa.concluida ? 'checked' : ''} 
                               onchange="agendaFase4.toggleSubtarefa(${subtarefa.id})">
                        <span class="subtarefa-texto ${subtarefa.concluida ? 'concluida' : ''}">${subtarefa.titulo}</span>
                        <div class="subtarefa-actions">
                            <button class="btn-icon" onclick="agendaFase4.removerSubtarefa(${subtarefa.id})" title="Remover">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            limparFormulario() {
                document.getElementById('formNovaTarefaFase4').reset();
                this.participantesTemp = [];
                this.subtarefasTemp = [];
                this.renderizarParticipantes();
                this.renderizarSubtarefas();
                this.tarefaEditando = null;
                
                const modalTitle = document.querySelector('#modalNovaTarefaFase4 .modal-header h3');
                if (modalTitle) {
                    modalTitle.textContent = '‚ûï Nova Tarefa Fase 4 - Com Hor√°rios';
                }
                
                const saveBtn = document.querySelector('#modalNovaTarefaFase4 .btn-primary');
                if (saveBtn) {
                    saveBtn.textContent = 'üíæ Criar Tarefa Fase 4';
                    saveBtn.onclick = () => this.salvarNovaTarefaFase4();
                }
            }

            notificar(mensagem, tipo = 'info') {
                if (typeof Notifications !== 'undefined') {
                    Notifications[tipo](mensagem);
                } else {
                    console.log(`${tipo.toUpperCase()}: ${mensagem}`);
                    const notification = document.getElementById('notification');
                    const text = document.getElementById('notificationText');
                    if (notification && text) {
                        text.textContent = mensagem;
                        notification.style.display = 'block';
                        setTimeout(() => {
                            notification.style.display = 'none';
                        }, 3000);
                    }
                }
            }

            fecharModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('show');
                    setTimeout(() => {
                        modal.style.display = 'none';
                    }, 300);
                }
            }

            abrirModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'flex';
                    setTimeout(() => {
                        modal.classList.add('show');
                    }, 10);
                }
            }

            inicializarModoFallback() {
                console.log('üîÑ Inicializando modo fallback...');
                this.tarefas = [];
                this.eventos = [];
                this.eventosEquipe = [];
                this.renderizarGridFase4();
                this.renderizarEventosEquipe();
                this.atualizarEstatisticasFase4();
            }
        }

        // ‚úÖ INICIALIZAR INST√ÇNCIA GLOBAL
        let agendaFase4;
        
        // ‚úÖ AGUARDAR CARREGAMENTO COMPLETO
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ DOM carregado - inicializando Agenda Fase 4...');
            agendaFase4 = new AgendaFase4();
        });

        // ‚úÖ FALLBACK PARA CASOS DE CARREGAMENTO TARDIO
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                if (!agendaFase4) {
                    agendaFase4 = new AgendaFase4();
                }
            });
        } else {
            setTimeout(() => {
                if (!agendaFase4) {
                    agendaFase4 = new AgendaFase4();
                }
            }, 100);
        }

        // Atualizar nome do usu√°rio na agenda
        function atualizarUsuarioAgenda() {
            if (window.Auth && Auth.state && Auth.state.usuario) {
                var nome = Auth.state.usuario.displayName || Auth.state.usuario.nome || Auth.state.usuario.email || 'Usu√°rio';
                var email = Auth.state.usuario.email || '-';
                document.querySelectorAll('.nome-usuario').forEach(function(el) {
                    el.textContent = nome;
                });
                var emailEl = document.getElementById('user-email-agenda');
                if (emailEl) emailEl.textContent = email;
            }
        }
        // Atualizar ao logar
        if (window.Auth) {
            if (typeof Auth._executarCallbacksLogin === 'function') {
                var originalLogin = Auth._executarCallbacksLogin;
                Auth._executarCallbacksLogin = function() {
                    originalLogin.apply(Auth, arguments);
                    atualizarUsuarioAgenda();
                };
            }
        }
        // Atualizar ao carregar
        window.addEventListener('DOMContentLoaded', atualizarUsuarioAgenda);
        window.addEventListener('biapo-login', atualizarUsuarioAgenda);
    </script>
</body>
</html>
