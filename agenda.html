<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Agenda - Sistema BIAPO v8.9.0</title>
    
    <!-- ‚úÖ CSS DO SISTEMA -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/calendar.css">
    
    <!-- ‚úÖ FIREBASE SCRIPTS -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- üî• SISTEMA UNIFICADO COMPLETO v8.9.0 -->
    <script src="assets/js/config/firebase.js"></script>
    <script src="assets/js/utils/helpers.js"></script>
    <script src="assets/js/utils/validation.js"></script>
    <script src="assets/js/utils/notifications.js"></script>
    <script src="assets/js/core/data.js"></script>
    <script src="assets/js/core/app.js"></script>
    <script src="assets/js/modules/persistence.js"></script>
    <script src="assets/js/modules/auth.js"></script>

    <style>
        /* üî¥ CORES BIAPO */
        :root {
            --biapo-red: #C53030;
            --biapo-red-light: #E53E3E;
            --biapo-red-dark: #9B2C2C;
            --biapo-orange: #DD6B20;
            --biapo-gray: #2D3748;
            --biapo-gray-light: #4A5568;
            --biapo-gray-lighter: #718096;
            --accent-green: #38A169;
            --accent-yellow: #D69E2E;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        .page-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* üî¥ HEADER DA P√ÅGINA v8.9.0 */
        .page-header {
            background: linear-gradient(135deg, var(--biapo-red) 0%, var(--biapo-red-dark) 100%);
            color: white;
            padding: 24px 32px;
            border-radius: 16px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(197, 48, 48, 0.3);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-biapo {
            height: 60px;
            width: auto;
            background: white;
            padding: 8px;
            border-radius: 8px;
        }

        .header-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info-badge {
            background: rgba(255,255,255,0.1);
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            text-align: center;
        }

        .user-name {
            font-weight: 600;
            font-size: 16px;
        }

        .user-email {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 2px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn-header {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-header:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        /* üéõÔ∏è CONTROLES PRINCIPAIS BIDIRECIONAL v8.9.0 */
        .main-controls {
            background: white;
            padding: 24px 32px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .view-tabs {
            display: flex;
            gap: 4px;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 8px;
        }

        .view-tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--biapo-gray);
        }

        .view-tab.active {
            background: var(--biapo-red);
            color: white;
            box-shadow: 0 2px 4px rgba(197, 48, 48, 0.3);
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f0fdf4;
            border-radius: 6px;
            border: 1px solid #bbf7d0;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .filters-section {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--biapo-gray-lighter);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            color: var(--biapo-gray);
            min-width: 140px;
        }

        .actions-section {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--biapo-red) 0%, var(--biapo-red-light) 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--biapo-red-dark) 0%, var(--biapo-red) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(197, 48, 48, 0.3);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: var(--biapo-gray);
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
        }

        .btn-info {
            background: #06b6d4;
            color: white;
        }

        /* üî• SE√á√ÉO EVENTOS DE EQUIPE v8.9.0 */
        .team-events-section {
            background: white;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .team-events-header {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .team-events-content {
            padding: 20px 24px;
        }

        .team-event-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #06b6d4;
            background: #f0f9ff;
            transition: all 0.2s ease;
        }

        .team-event-item:hover {
            background: #e0f2fe;
            transform: translateX(2px);
        }

        .team-event-icon {
            font-size: 20px;
        }

        .team-event-info {
            flex: 1;
        }

        .team-event-title {
            font-weight: 600;
            color: #0c4a6e;
            margin-bottom: 4px;
        }

        .team-event-meta {
            font-size: 12px;
            color: #0369a1;
        }

        /* üìÖ GRID SEMANAL PRINCIPAL BIDIRECIONAL */
        .agenda-views {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .weekly-navigation {
            background: #f8fafc;
            padding: 20px 32px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .nav-btn {
            background: white;
            border: 1px solid #e2e8f0;
            color: var(--biapo-gray);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .nav-btn:hover {
            border-color: var(--biapo-red);
            color: var(--biapo-red);
        }

        .current-week {
            font-size: 18px;
            font-weight: 700;
            color: var(--biapo-gray);
        }

        .weekly-grid {
            display: grid;
            grid-template-columns: 120px repeat(7, 1fr);
            min-height: 600px;
            background: white;
        }

        /* üìã CABE√áALHO DOS DIAS */
        .time-column {
            background: #f8fafc;
            border-right: 2px solid #e2e8f0;
            padding: 16px 8px;
            text-align: center;
            font-weight: 600;
            color: var(--biapo-gray);
        }

        .day-header {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            padding: 16px 8px;
            text-align: center;
            border-right: 1px solid #e2e8f0;
            border-bottom: 2px solid var(--biapo-red);
        }

        .day-header.today {
            background: linear-gradient(135deg, var(--biapo-red-light) 0%, var(--biapo-red) 100%);
            color: white;
        }

        .day-name {
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .day-date {
            font-size: 20px;
            font-weight: 700;
            margin-top: 4px;
        }

        .day-tasks-count {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* üìã COLUNA DE HOR√ÅRIOS */
        .time-slots {
            background: #f8fafc;
            border-right: 2px solid #e2e8f0;
            display: flex;
            flex-direction: column;
        }

        .time-slot {
            height: 60px;
            padding: 8px 4px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--biapo-gray-lighter);
        }

        /* üìù COLUNAS DOS DIAS */
        .day-column {
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            min-height: 100%;
            position: relative;
        }

        .day-column:last-child {
            border-right: none;
        }

        /* üïê SLOTS DE HOR√ÅRIO NOS DIAS */
        .hour-slot {
            height: 60px;
            border-bottom: 1px solid #f1f5f9;
            position: relative;
            padding: 4px;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        .hour-slot:hover {
            background-color: rgba(197, 48, 48, 0.05);
        }

        /* üìã ITENS NO GRID BIDIRECIONAL v8.9.0 */
        .item-grid {
            background: white;
            border-radius: 6px;
            padding: 8px 10px;
            margin: 2px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            font-size: 11px;
        }

        .item-grid:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* üî• TIPOS DE ITENS COM CORES ESPEC√çFICAS */
        .item-grid.evento-equipe {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        .item-grid.evento-publico {
            border-left: 4px solid #06b6d4;
            background: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%);
        }

        .item-grid.tarefa-pessoal {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .item-grid.tarefa-equipe {
            border-left: 4px solid #8b5cf6;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }

        .item-grid.tarefa-publico {
            border-left: 4px solid #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .item-grid.urgente {
            border-left: 4px solid #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            animation: pulse 2s infinite;
        }

        .item-time {
            font-size: 10px;
            font-weight: 600;
            color: var(--biapo-gray);
            margin-bottom: 2px;
        }

        .item-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--biapo-gray);
            margin-bottom: 2px;
            line-height: 1.2;
        }

        .item-description {
            font-size: 10px;
            color: var(--biapo-gray-lighter);
            line-height: 1.3;
            margin-bottom: 4px;
        }

        .item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
        }

        .item-badge {
            font-size: 8px;
            padding: 2px 4px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .item-badge.evento {
            background: #dbeafe;
            color: #1e40af;
        }

        .item-badge.tarefa {
            background: #fef3c7;
            color: #92400e;
        }

        .item-actions {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .item-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px;
            border-radius: 3px;
            font-size: 10px;
            transition: background-color 0.2s;
        }

        .item-action-btn:hover {
            background: rgba(0,0,0,0.1);
        }

        /* üîÑ LINHA DO TEMPO ATUAL */
        .current-time-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--biapo-red);
            z-index: 10;
            box-shadow: 0 0 4px rgba(197, 48, 48, 0.5);
        }

        .current-time-line::before {
            content: '';
            position: absolute;
            left: -6px;
            top: -4px;
            width: 10px;
            height: 10px;
            background: var(--biapo-red);
            border-radius: 50%;
        }

        /* üìä ESTAT√çSTICAS BIDIRECIONAIS */
        .stats-bar {
            background: #f8fafc;
            padding: 20px 32px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--biapo-red);
        }

        .stat-label {
            font-size: 12px;
            color: var(--biapo-gray-lighter);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* üîî NOTIFICA√á√ïES */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: none;
        }

        /* üî¥ MODAL SISTEMA */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 20000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex !important;
            opacity: 1;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--biapo-red) 0%, var(--biapo-red-dark) 100%);
            color: white;
            padding: 20px 24px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 0 0 16px 16px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* üìù FORMUL√ÅRIOS */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--biapo-gray);
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            box-sizing: border-box;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--biapo-red);
            box-shadow: 0 0 0 3px rgba(197, 48, 48, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .form-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        /* üè∑Ô∏è TAGS PARTICIPANTES */
        .participantes-container {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            min-height: 44px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .participantes-container:focus-within {
            border-color: var(--biapo-red);
            box-shadow: 0 0 0 3px rgba(197, 48, 48, 0.1);
        }

        .participante-tag {
            background: var(--biapo-red);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .participante-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }

        .participante-input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 120px;
            font-size: 14px;
        }

        /* üìã SUBTAREFAS */
        .subtarefas-list {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .subtarefa-item {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .subtarefa-item:last-child {
            border-bottom: none;
        }

        .subtarefa-checkbox {
            width: 18px;
            height: 18px;
        }

        .subtarefa-texto {
            flex: 1;
            font-size: 14px;
        }

        .subtarefa-texto.concluida {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .subtarefa-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .btn-icon:hover {
            background: #f1f5f9;
        }

        /* üé® LOADING */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f1f5f9;
            border-top: 3px solid var(--biapo-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* üì± RESPONSIVIDADE */
        @media (max-width: 1200px) {
            .weekly-grid {
                grid-template-columns: 100px repeat(7, 1fr);
            }
        }

        @media (max-width: 768px) {
            .page-container {
                padding: 12px;
            }
            
            .page-header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
                padding: 20px;
            }
            
            .main-controls {
                flex-direction: column;
                align-items: stretch;
                padding: 20px;
            }
            
            .filters-section,
            .actions-section {
                justify-content: center;
            }
            
            .weekly-grid {
                grid-template-columns: 80px repeat(7, 1fr);
                font-size: 12px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* üéØ ESTADOS ESPECIAIS */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--biapo-gray-lighter);
            grid-column: 1 / -1;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--biapo-gray);
        }

        .empty-description {
            margin-bottom: 24px;
        }

        /* üé® ANIMA√á√ïES */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* üî• INDICADORES SISTEMA BIDIRECIONAL */
        .sync-badge {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #065f46;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-link-badge {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #1e40af;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calendar-link-badge:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <!-- üîî NOTIFICA√á√ïES -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>

    <div class="page-container">
        <!-- üî¥ HEADER DA P√ÅGINA v8.9.0 -->
        <div class="page-header">
            <div class="header-left">
                <img src="assets/img/Logo-biapo.jpg" alt="Logo BIAPO" class="logo-biapo">
                <div>
                    <h1 class="header-title">üìÖ Minha Agenda Pessoal</h1>
                    <p class="header-subtitle">Sistema de Gest√£o BIAPO - Obra 292</p>
                    <div style="margin-top: 8px;">
                        <span class="sync-badge">üîÑ v8.9.0 SINCRONIZA√á√ÉO BIDIRECIONAL</span>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info-badge">
                    <div class="user-name" id="userName">Carregando...</div>
                    <div class="user-email" id="userEmail">Verificando usu√°rio...</div>
                </div>
                <div class="header-actions">
                    <button class="btn-header" onclick="sincronizarBidirecional()">
                        üîÑ Sync Bidirecional
                    </button>
                    <button class="btn-header" onclick="abrirCalendarioPrincipal()">
                        üìÖ Ver Calend√°rio
                    </button>
                    <button class="btn-header" onclick="voltarParaSistema()">
                        üè† Voltar ao Sistema
                    </button>
                </div>
            </div>
        </div>

        <!-- üéõÔ∏è CONTROLES PRINCIPAIS BIDIRECIONAL -->
        <div class="main-controls">
            <div class="view-tabs">
                <button class="view-tab active" onclick="alternarVisualizacao('grid')" data-view="grid">
                    üóìÔ∏è Grid Semanal
                </button>
                <button class="view-tab" onclick="alternarVisualizacao('mixed')" data-view="mixed">
                    üîÑ Vis√£o Mista
                </button>
            </div>

            <div class="sync-status">
                <div class="sync-indicator"></div>
                <span style="font-size: 12px; font-weight: 600; color: #065f46;">
                    Sync Bidirecional Ativo
                </span>
            </div>

            <div class="filters-section">
                <div class="filter-group">
                    <label class="filter-label">Tipo</label>
                    <select class="filter-select" id="filtroTipo" onchange="aplicarFiltros()">
                        <option value="todos">üîÑ Todos os tipos</option>
                        <option value="urgente">üö® Urgente</option>
                        <option value="projeto">üèóÔ∏è Projeto</option>
                        <option value="equipe">üë• Equipe</option>
                        <option value="pessoal">üë§ Pessoal</option>
                        <option value="rotina">üîÑ Rotina</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select class="filter-select" id="filtroStatus" onchange="aplicarFiltros()">
                        <option value="todos">‚ö° Todos os status</option>
                        <option value="pendente">‚è≥ Pendente</option>
                        <option value="andamento">üî• Em andamento</option>
                        <option value="concluida">‚úÖ Conclu√≠da</option>
                        <option value="cancelada">‚ùå Cancelada</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Escopo</label>
                    <select class="filter-select" id="filtroEscopo" onchange="aplicarFiltros()">
                        <option value="todos">üåê Todos os escopos</option>
                        <option value="pessoal">üë§ Pessoal</option>
                        <option value="equipe">üë• Equipe</option>
                        <option value="publico">üåç P√∫blico</option>
                    </select>
                </div>
            </div>

            <div class="actions-section">
                <button class="btn btn-secondary" onclick="exportarAgenda()">
                    üìÑ Exportar PDF
                </button>
                <button class="btn btn-info" onclick="mostrarRelatorios()">
                    üìä Relat√≥rios
                </button>
                <button class="btn btn-success" onclick="mostrarModalNovaTarefa()">
                    ‚ûï Nova Tarefa
                </button>
                <button class="btn btn-primary" onclick="sincronizarBidirecional()">
                    üîÑ Sync Completo
                </button>
            </div>
        </div>

        <!-- üî• SE√á√ÉO EVENTOS DE EQUIPE RELEVANTES v8.9.0 -->
        <div class="team-events-section" id="teamEventsSection">
            <div class="team-events-header">
                <div>
                    <h3>üìÖ Eventos de Equipe Relevantes</h3>
                    <p style="font-size: 12px; opacity: 0.9; margin: 4px 0 0 0;">
                        Eventos onde voc√™ participa ou √© respons√°vel
                    </p>
                </div>
                <div style="display: flex; gap: 8px;">
                    <span id="teamEventsCount" style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 6px; font-size: 12px;">
                        0 eventos
                    </span>
                    <button onclick="abrirCalendarioPrincipal()" style="
                        background: rgba(255,255,255,0.2);
                        border: 1px solid rgba(255,255,255,0.3);
                        color: white;
                        padding: 6px 12px;
                        border-radius: 6px;
                        font-size: 12px;
                        cursor: pointer;
                    ">üìÖ Ver Todos</button>
                </div>
            </div>
            <div class="team-events-content" id="teamEventsContent">
                <!-- Eventos de equipe ser√£o renderizados aqui -->
            </div>
        </div>

        <!-- üìÖ GRID SEMANAL PRINCIPAL BIDIRECIONAL -->
        <div class="agenda-views">
            <!-- üóìÔ∏è GRID SEMANAL -->
            <div class="weekly-grid-view active" id="gridView">
                <div class="weekly-navigation">
                    <button class="nav-btn" onclick="navegarSemana(-1)">‚Üê Semana Anterior</button>
                    <span class="current-week" id="currentWeekDisplay">Carregando...</span>
                    <button class="nav-btn" onclick="navegarSemana(1)">Pr√≥xima Semana ‚Üí</button>
                    <button class="nav-btn" onclick="irParaHoje()">üè† Hoje</button>
                </div>

                <div class="weekly-grid" id="weeklyGrid">
                    <!-- GRID SER√Å RENDERIZADO DINAMICAMENTE -->
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <div class="empty-title">Sua agenda bidirecional est√° pronta</div>
                        <div class="empty-description">
                            Comece criando sua primeira tarefa ou evento para ver a sincroniza√ß√£o bidirecional em a√ß√£o.
                            <br><br>
                            <strong>üîÑ Sistema BIDIRECIONAL v8.9.0:</strong> Tarefas e eventos sincronizam automaticamente entre agenda e calend√°rio!
                        </div>
                        <button class="btn btn-primary" onclick="mostrarModalNovaTarefa()">
                            ‚ûï Criar Primeira Tarefa
                        </button>
                    </div>
                </div>
            </div>

            <!-- üìä BARRA DE ESTAT√çSTICAS BIDIRECIONAL -->
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">Tarefas Pessoais</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="teamEvents">0</div>
                    <div class="stat-label">Eventos de Equipe</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="pendingTasks">0</div>
                    <div class="stat-label">Pendentes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="inProgressTasks">0</div>
                    <div class="stat-label">Em Andamento</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="completedTasksTotal">0</div>
                    <div class="stat-label">Conclu√≠das</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="calendarLinked">0</div>
                    <div class="stat-label">No Calend√°rio</div>
                </div>
            </div>
        </div>
    </div>

    <!-- üî• MODAIS DO SISTEMA DE TAREFAS BIDIRECIONAL -->
    
    <!-- ‚ûï MODAL NOVA TAREFA BIDIRECIONAL -->
    <div id="modalNovaTarefa" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûï Nova Tarefa Bidirecional</h3>
                <button class="modal-close" onclick="fecharModal('modalNovaTarefa')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formNovaTarefa">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tarefaTitulo">üìù T√≠tulo da Tarefa *</label>
                            <input type="text" id="tarefaTitulo" name="titulo" required placeholder="Ex: Revisar documenta√ß√£o do projeto">
                        </div>
                        <div class="form-group">
                            <label for="tarefaTipo">üè∑Ô∏è Tipo</label>
                            <select id="tarefaTipo" name="tipo">
                                <option value="pessoal">üë§ Pessoal</option>
                                <option value="equipe">üë• Equipe</option>
                                <option value="projeto">üèóÔ∏è Projeto</option>
                                <option value="urgente">üö® Urgente</option>
                                <option value="rotina">üîÑ Rotina</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="tarefaDescricao">üìÑ Descri√ß√£o</label>
                        <textarea id="tarefaDescricao" name="descricao" placeholder="Descreva os detalhes da tarefa..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tarefaDataInicio">üìÖ Data de In√≠cio</label>
                            <input type="date" id="tarefaDataInicio" name="dataInicio">
                        </div>
                        <div class="form-group">
                            <label for="tarefaHorario">üïê Hor√°rio</label>
                            <input type="time" id="tarefaHorario" name="horario">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tarefaPrioridade">üéØ Prioridade</label>
                            <select id="tarefaPrioridade" name="prioridade">
                                <option value="baixa">üü¢ Baixa</option>
                                <option value="media" selected>üü° M√©dia</option>
                                <option value="alta">üü† Alta</option>
                                <option value="critica">üî¥ Cr√≠tica</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tarefaEscopo">üåê Escopo</label>
                            <select id="tarefaEscopo" name="escopo">
                                <option value="pessoal">üë§ Pessoal</option>
                                <option value="equipe">üë• Equipe</option>
                                <option value="publico">üåç P√∫blico</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üë• Marcar Outras Pessoas</label>
                        <div class="participantes-container" id="participantesContainer">
                            <input type="text" class="participante-input" id="participanteInput" placeholder="Digite um nome e pressione Enter">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üìã Subtarefas</label>
                        <div class="subtarefas-list" id="subtarefasList">
                            <div style="padding: 12px; text-align: center; color: #9ca3af;">
                                Nenhuma subtarefa adicionada
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="adicionarSubtarefa()" style="margin-top: 8px;">
                            ‚ûï Adicionar Subtarefa
                        </button>
                    </div>

                    <!-- üî• CONTROLES BIDIRECIONAL v8.9.0 -->
                    <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-top: 16px;">
                        <h4 style="margin: 0 0 12px 0; color: var(--biapo-gray); font-size: 14px;">üîÑ Sincroniza√ß√£o Bidirecional</h4>
                        
                        <div class="form-checkbox">
                            <input type="checkbox" id="aparecerNoCalendario" name="aparecerNoCalendario">
                            <label for="aparecerNoCalendario">üìÖ Mostrar no calend√°rio principal da equipe</label>
                        </div>
                        
                        <div class="form-checkbox">
                            <input type="checkbox" id="notificarEquipe" name="notificarEquipe">
                            <label for="notificarEquipe">üîî Notificar participantes sobre esta tarefa</label>
                        </div>
                        
                        <div class="form-checkbox">
                            <input type="checkbox" id="sincronizarStatus" name="sincronizarStatus">
                            <label for="sincronizarStatus">üîÑ Sincronizar mudan√ßas de status automaticamente</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="fecharModal('modalNovaTarefa')">
                    ‚ùå Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="salvarNovaTarefaBidirecional()">
                    üíæ Criar e Sincronizar
                </button>
            </div>
        </div>
    </div>

    <script>
        // üéØ CLASSE PRINCIPAL DA AGENDA BIDIRECIONAL v8.9.0
        class AgendaBidirecional {
            constructor() {
                this.visualizacaoAtiva = 'grid';
                this.semanaAtual = new Date();
                this.usuarioAtual = null;
                this.tarefas = [];
                this.eventos = [];
                this.eventosEquipe = []; // üî• NOVO: Eventos relevantes da equipe
                this.participantesTemp = [];
                this.subtarefasTemp = [];
                this.tarefaEditando = null;
                this.filtros = {
                    tipo: 'todos',
                    status: 'todos',
                    prioridade: 'todos',
                    escopo: 'todos' // üî• NOVO: Filtro por escopo
                };
                
                // üî• CONFIGURA√á√ïES BIDIRECIONAL
                this.configBidirecional = {
                    syncAutomatico: true,
                    mostrarEventosEquipe: true,
                    notificarMudancas: true,
                    atualizarCalendario: true
                };
                
                this.init();
            }

            // üöÄ INICIALIZA√á√ÉO BIDIRECIONAL v8.9.0
            async init() {
                console.log('üìÖ Inicializando Agenda BIDIRECIONAL v8.9.0...');
                
                try {
                    // ‚úÖ AGUARDAR APP.JS UNIFICADO ESTAR PRONTO
                    await this.aguardarAppUnificado();
                    
                    // ‚úÖ VERIFICAR USU√ÅRIO VIA APP.JS
                    this.verificarUsuario();
                    
                    // ‚úÖ CARREGAR DADOS BIDIRECIONAIS
                    await this.carregarDadosBidirecionais();
                    
                    // ‚úÖ CONFIGURAR LISTENERS BIDIRECIONAL
                    this.configurarEventListenersBidirecional();
                    
                    // ‚úÖ RENDERIZAR INTERFACE
                    this.renderizarGridBidirecional();
                    this.renderizarEventosEquipe();
                    this.atualizarSemanaDisplay();
                    this.atualizarEstatisticasBidirecional();
                    
                    console.log('‚úÖ Agenda BIDIRECIONAL carregada com sucesso!');
                    console.log(`üìä ${this.tarefas.length} tarefas + ${this.eventosEquipe.length} eventos relevantes`);
                    
                } catch (error) {
                    console.error('‚ùå Erro na inicializa√ß√£o bidirecional:', error);
                    this.inicializarModoFallback();
                }
            }

            // üî• AGUARDAR APP.JS UNIFICADO v8.7.0+
            async aguardarAppUnificado() {
                let tentativas = 0;
                const maxTentativas = 50; // 5 segundos
                
                while (tentativas < maxTentativas) {
                    if (typeof App !== 'undefined' && 
                        App.estadoSistema && 
                        App.estadoSistema.inicializado &&
                        App.config.estruturaUnificada) {
                        console.log('‚úÖ App.js v8.7.0+ ESTRUTURA UNIFICADA pronto!');
                        return true;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                    tentativas++;
                }
                
                console.warn('‚ö†Ô∏è App.js unificado n√£o carregou completamente, continuando...');
                return false;
            }

            // üë§ VERIFICAR USU√ÅRIO VIA APP.JS (mantido)
            verificarUsuario() {
                try {
                    if (typeof App !== 'undefined' && App.usuarioAtual) {
                        this.usuarioAtual = {
                            nome: App.usuarioAtual.displayName || this.extrairNomeDoEmail(App.usuarioAtual.email),
                            email: App.usuarioAtual.email
                        };
                    } else {
                        this.usuarioAtual = {
                            nome: 'Usu√°rio Demo',
                            email: 'demo@biapo.com.br'
                        };
                    }

                    document.getElementById('userName').textContent = this.usuarioAtual.nome;
                    document.getElementById('userEmail').textContent = this.usuarioAtual.email;

                    console.log(`üë§ Usu√°rio Agenda Bidirecional: ${this.usuarioAtual.nome}`);

                } catch (error) {
                    console.error('‚ùå Erro ao verificar usu√°rio:', error);
                    this.inicializarModoFallback();
                }
            }

            extrairNomeDoEmail(email) {
                if (!email) return 'Usu√°rio';
                const parteLocal = email.split('@')[0];
                return parteLocal.charAt(0).toUpperCase() + parteLocal.slice(1);
            }

            // üìä CARREGAR DADOS BIDIRECIONAIS v8.9.0
            async carregarDadosBidirecionais() {
                try {
                    if (typeof App === 'undefined' || !App.obterItensParaUsuario) {
                        console.warn('‚ö†Ô∏è App.js unificado n√£o dispon√≠vel - usando modo fallback');
                        this.tarefas = [];
                        this.eventos = [];
                        this.eventosEquipe = [];
                        return;
                    }

                    console.log('üì• Carregando dados bidirecionais via App.js v8.7.0...');
                    
                    // ‚úÖ CARREGAR ITENS DO USU√ÅRIO (tarefas + eventos)
                    const { eventos, tarefas } = App.obterItensParaUsuario(this.usuarioAtual.email);
                    
                    // üî• SEPARAR TAREFAS PESSOAIS E EVENTOS DE EQUIPE
                    this.tarefas = tarefas.filter(item => 
                        item._tipoItem === 'tarefa' && 
                        (item.escopo === 'pessoal' || item.responsavel === this.usuarioAtual.email)
                    );
                    
                    this.eventosEquipe = eventos.filter(item => 
                        item._tipoItem === 'evento' && 
                        (item.participantes?.includes(this.usuarioAtual.nome) || 
                         item.participantes?.includes(this.usuarioAtual.email) ||
                         item.responsavel === this.usuarioAtual.email)
                    );
                    
                    console.log(`‚úÖ Dados bidirecionais carregados: ${this.tarefas.length} tarefas + ${this.eventosEquipe.length} eventos`);

                } catch (error) {
                    console.error('‚ùå Erro ao carregar dados bidirecionais:', error);
                    this.tarefas = [];
                    this.eventos = [];
                    this.eventosEquipe = [];
                }
            }

            // üéõÔ∏è CONFIGURAR EVENT LISTENERS BIDIRECIONAL v8.9.0
            configurarEventListenersBidirecional() {
                // Filtros tradicionais
                document.getElementById('filtroTipo').addEventListener('change', () => {
                    this.filtros.tipo = document.getElementById('filtroTipo').value;
                    this.aplicarFiltros();
                });

                document.getElementById('filtroStatus').addEventListener('change', () => {
                    this.filtros.status = document.getElementById('filtroStatus').value;
                    this.aplicarFiltros();
                });

                // üî• NOVO: Filtro por escopo
                document.getElementById('filtroEscopo').addEventListener('change', () => {
                    this.filtros.escopo = document.getElementById('filtroEscopo').value;
                    this.aplicarFiltros();
                });

                // Participantes input
                const participanteInput = document.getElementById('participanteInput');
                if (participanteInput) {
                    participanteInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.adicionarParticipante();
                        }
                    });
                }

                // üî• SYNC EM TEMPO REAL VIA APP.JS BIDIRECIONAL
                window.addEventListener('dados-sincronizados', (e) => {
                    console.log('üîÑ App.js sincronizou - atualizando agenda bidirecional...', e.detail);
                    this.carregarDadosBidirecionais();
                    this.renderizarGridBidirecional();
                    this.renderizarEventosEquipe();
                    this.atualizarEstatisticasBidirecional();
                });
            }

            // üî• RENDERIZAR EVENTOS DE EQUIPE RELEVANTES v8.9.0
            renderizarEventosEquipe() {
                const container = document.getElementById('teamEventsContent');
                const counter = document.getElementById('teamEventsCount');
                
                if (!container || !counter) return;

                counter.textContent = `${this.eventosEquipe.length} eventos`;

                if (this.eventosEquipe.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6b7280;">
                            <div style="font-size: 32px; margin-bottom: 12px;">üìÖ</div>
                            <p style="margin: 0; font-size: 14px;">Nenhum evento de equipe relevante encontrado.</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px; opacity: 0.8;">
                                Eventos onde voc√™ participa aparecer√£o aqui automaticamente.
                            </p>
                        </div>
                    `;
                    return;
                }

                // Filtrar eventos pr√≥ximos (pr√≥ximos 30 dias)
                const hoje = new Date();
                const em30Dias = new Date();
                em30Dias.setDate(hoje.getDate() + 30);

                const eventosProximos = this.eventosEquipe.filter(evento => {
                    const dataEvento = new Date(evento.data);
                    return dataEvento >= hoje && dataEvento <= em30Dias;
                }).slice(0, 5); // M√°ximo 5 eventos

                container.innerHTML = eventosProximos.map(evento => {
                    const dataEvento = new Date(evento.data);
                    const isHoje = dataEvento.toDateString() === hoje.toDateString();
                    const diasRestantes = Math.ceil((dataEvento - hoje) / (1000 * 60 * 60 * 24));
                    
                    return `
                        <div class="team-event-item" onclick="abrirEventoEquipe('${evento.id}')">
                            <div class="team-event-icon">üìÖ</div>
                            <div class="team-event-info">
                                <div class="team-event-title">${evento.titulo}</div>
                                <div class="team-event-meta">
                                    üìÖ ${dataEvento.toLocaleDateString('pt-BR')} 
                                    ${evento.horarioInicio ? 'üïê ' + evento.horarioInicio : ''}
                                    ${isHoje ? 'üî• HOJE' : diasRestantes === 1 ? '‚ö° AMANH√É' : `üìç ${diasRestantes} dias`}
                                    ${evento.local ? 'üìç ' + evento.local : ''}
                                </div>
                            </div>
                            <div class="calendar-link-badge" onclick="event.stopPropagation(); marcarEventoNaAgenda('${evento.id}')" title="Marcar na minha agenda">
                                üìã
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // üóìÔ∏è RENDERIZAR GRID BIDIRECIONAL
            renderizarGridBidirecional() {
                const grid = document.getElementById('weeklyGrid');
                const tarefasFiltradas = this.filtrarTarefas();

                if (tarefasFiltradas.length === 0 && this.eventosEquipe.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <div class="empty-title">Sua agenda bidirecional est√° pronta</div>
                            <div class="empty-description">
                                Comece criando sua primeira tarefa para ver a sincroniza√ß√£o bidirecional em a√ß√£o.
                                <br><br>
                                <strong>üîÑ Sistema BIDIRECIONAL v8.9.0:</strong> 
                                ‚Ä¢ Tarefas sincronizam com o calend√°rio principal<br>
                                ‚Ä¢ Eventos de equipe aparecem automaticamente<br>
                                ‚Ä¢ Mudan√ßas refletem em tempo real em ambos os sistemas
                            </div>
                            <button class="btn btn-primary" onclick="mostrarModalNovaTarefa()">
                                ‚ûï Criar Primeira Tarefa
                            </button>
                        </div>
                    `;
                    return;
                }

                this.renderizarGridCompletoMisto(grid, tarefasFiltradas, this.eventosEquipe);
            }

            renderizarGridCompletoMisto(grid, tarefas, eventos) {
                const hoje = new Date();
                const inicioSemana = new Date(this.semanaAtual);
                inicioSemana.setDate(this.semanaAtual.getDate() - this.semanaAtual.getDay());

                grid.innerHTML = `
                    <!-- Coluna de hor√°rios -->
                    <div class="time-column">
                        <div style="font-size: 12px; color: var(--biapo-red); font-weight: 700;">HOR√ÅRIOS</div>
                    </div>

                    <!-- Cabe√ßalhos dos dias -->
                    ${this.gerarCabecalhosDias(inicioSemana, hoje, tarefas, eventos)}

                    <!-- Slots de hor√°rio -->
                    <div class="time-slots">
                        ${Array.from({length: 10}, (_, i) => {
                            const hora = String(8 + i).padStart(2, '0');
                            return `<div class="time-slot">${hora}:00</div>`;
                        }).join('')}
                    </div>

                    <!-- Colunas dos dias -->
                    ${this.gerarColunasDiasMisto(inicioSemana, tarefas, eventos)}
                `;

                this.adicionarLinhaTempo(grid);
            }

            gerarCabecalhosDias(inicioSemana, hoje, tarefas, eventos) {
                const diasSemana = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'S√ÅB'];
                let html = '';

                for (let i = 0; i < 7; i++) {
                    const dia = new Date(inicioSemana);
                    dia.setDate(inicioSemana.getDate() + i);
                    
                    const ehHoje = dia.toDateString() === hoje.toDateString();
                    const itensTotal = this.obterItensDoDiaMisto(dia, tarefas, eventos).length;

                    html += `
                        <div class="day-header ${ehHoje ? 'today' : ''}">
                            <div class="day-name">${diasSemana[i]}</div>
                            <div class="day-date">${dia.getDate()}</div>
                            <div class="day-tasks-count">${itensTotal} itens</div>
                        </div>
                    `;
                }

                return html;
            }

            gerarColunasDiasMisto(inicioSemana, tarefas, eventos) {
                let html = '';

                for (let i = 0; i < 7; i++) {
                    const dia = new Date(inicioSemana);
                    dia.setDate(inicioSemana.getDate() + i);
                    const itensDia = this.obterItensDoDiaMisto(dia, tarefas, eventos);

                    html += `
                        <div class="day-column">
                            ${Array.from({length: 10}, (_, h) => {
                                const hora = 8 + h;
                                const itensHora = itensDia.filter(item => {
                                    const horarioItem = parseInt(item.horario?.split(':')[0] || '0');
                                    return horarioItem === hora;
                                });

                                return `
                                    <div class="hour-slot" onclick="criarTarefaRapida('${dia.toISOString().split('T')[0]}', '${String(hora).padStart(2, '0')}:00')">
                                        ${itensHora.map(item => this.renderizarItemGridBidirecional(item)).join('')}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }

                return html;
            }

            obterItensDoDiaMisto(dia, tarefas = null, eventos = null) {
                const tarefasParaFiltrar = tarefas || this.tarefas;
                const eventosParaFiltrar = eventos || this.eventosEquipe;
                const dataStr = dia.toISOString().split('T')[0];
                
                let itens = [];

                // Tarefas pessoais
                itens = itens.concat(tarefasParaFiltrar.filter(tarefa => 
                    tarefa.dataInicio === dataStr
                ));

                // Eventos da equipe
                itens = itens.concat(eventosParaFiltrar.filter(evento => 
                    evento.data === dataStr || evento.dataInicio === dataStr
                ));

                return itens;
            }

            renderizarItemGridBidirecional(item) {
                const tipoItem = item._tipoItem || (item.hasOwnProperty('participantes') && !item.hasOwnProperty('responsavel') ? 'evento' : 'tarefa');
                const escopo = item.escopo || 'pessoal';
                const classeCSS = `${tipoItem}-${escopo}`;
                
                const prioridade = item.prioridade || 'media';
                const status = item.status || 'agendado';
                
                // √çcones espec√≠ficos
                const icones = {
                    'evento-equipe': 'üìÖ',
                    'evento-publico': 'üåç',
                    'tarefa-pessoal': 'üë§',
                    'tarefa-equipe': 'üë•',
                    'tarefa-publico': 'üåç'
                };
                const icone = icones[classeCSS] || 'üìå';

                return `
                    <div class="item-grid ${classeCSS} fade-in" onclick="${tipoItem === 'evento' ? `abrirEventoEquipe('${item.id}')` : `editarTarefaBidirecional('${item.id}')`}">
                        <div class="item-time">${item.horario || item.horarioInicio || ''}</div>
                        <div class="item-title">${icone} ${item.titulo}</div>
                        ${item.descricao ? `<div class="item-description">${item.descricao}</div>` : ''}
                        <div class="item-meta">
                            <div class="item-badge ${tipoItem}">${tipoItem === 'evento' ? 'Evento' : 'Tarefa'}</div>
                            <div class="item-actions">
                                ${item.aparecerNoCalendario ? '<span class="calendar-link-badge" title="Aparece no calend√°rio">üìÖ</span>' : ''}
                                <span class="item-action-btn" title="Escopo: ${escopo}">üîó</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            adicionarLinhaTempo(grid) {
                const agora = new Date();
                const hora = agora.getHours();
                const minuto = agora.getMinutes();

                if (hora >= 8 && hora <= 17) {
                    const posicao = ((hora - 8) * 60) + minuto;
                    const linha = document.createElement('div');
                    linha.className = 'current-time-line';
                    linha.style.top = `${posicao}px`;
                    
                    const hoje = new Date();
                    const diaHoje = hoje.getDay();
                    const colunaHoje = grid.querySelector(`.day-column:nth-child(${diaHoje + 2})`);
                    if (colunaHoje) {
                        colunaHoje.appendChild(linha);
                    }
                }
            }

            // üìä ATUALIZAR DISPLAY DA SEMANA (mantido)
            atualizarSemanaDisplay() {
                const inicioSemana = new Date(this.semanaAtual);
                inicioSemana.setDate(this.semanaAtual.getDate() - this.semanaAtual.getDay());
                
                const fimSemana = new Date(inicioSemana);
                fimSemana.setDate(inicioSemana.getDate() + 6);

                const display = `${inicioSemana.getDate()} - ${fimSemana.getDate()} ${fimSemana.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}`;
                document.getElementById('currentWeekDisplay').textContent = display;
            }

            // üîç FILTRAR TAREFAS (atualizado com escopo)
            filtrarTarefas() {
                return this.tarefas.filter(tarefa => {
                    if (this.filtros.tipo !== 'todos' && tarefa.tipo !== this.filtros.tipo) return false;
                    if (this.filtros.status !== 'todos' && tarefa.status !== this.filtros.status) return false;
                    if (this.filtros.escopo !== 'todos' && tarefa.escopo !== this.filtros.escopo) return false;
                    return true;
                });
            }

            // üìä ATUALIZAR ESTAT√çSTICAS BIDIRECIONAL v8.9.0
            atualizarEstatisticasBidirecional() {
                const tarefasFiltradas = this.filtrarTarefas();
                const pendentes = tarefasFiltradas.filter(t => t.status === 'pendente').length;
                const andamento = tarefasFiltradas.filter(t => t.status === 'andamento').length;
                const concluidas = tarefasFiltradas.filter(t => t.status === 'concluida').length;
                const noCalendario = tarefasFiltradas.filter(t => t.aparecerNoCalendario === true).length;

                document.getElementById('totalTasks').textContent = tarefasFiltradas.length;
                document.getElementById('teamEvents').textContent = this.eventosEquipe.length;
                document.getElementById('pendingTasks').textContent = pendentes;
                document.getElementById('inProgressTasks').textContent = andamento;
                document.getElementById('completedTasksTotal').textContent = concluidas;
                document.getElementById('calendarLinked').textContent = noCalendario;
            }

            // üîÑ APLICAR FILTROS
            aplicarFiltros() {
                this.renderizarGridBidirecional();
                this.atualizarEstatisticasBidirecional();
            }

            // üìÖ NAVEGAR SEMANA (mantido)
            navegarSemana(direcao) {
                this.semanaAtual.setDate(this.semanaAtual.getDate() + (direcao * 7));
                this.atualizarSemanaDisplay();
                this.renderizarGridBidirecional();
            }

            irParaHoje() {
                this.semanaAtual = new Date();
                this.atualizarSemanaDisplay();
                this.renderizarGridBidirecional();
            }

            // üî• SALVAR NOVA TAREFA BIDIRECIONAL v8.9.0
            async salvarNovaTarefaBidirecional() {
                try {
                    const form = document.getElementById('formNovaTarefa');
                    const formData = new FormData(form);
                    
                    const dadosTarefa = {
                        titulo: formData.get('titulo'),
                        descricao: formData.get('descricao'),
                        tipo: formData.get('tipo'),
                        prioridade: formData.get('prioridade'),
                        escopo: formData.get('escopo'), // üî• NOVO: Escopo expl√≠cito
                        dataInicio: formData.get('dataInicio') || new Date().toISOString().split('T')[0],
                        horario: formData.get('horario'),
                        participantes: [...this.participantesTemp],
                        subtarefas: [...this.subtarefasTemp],
                        
                        // üî• CONFIGURA√á√ïES BIDIRECIONAL
                        aparecerNoCalendario: document.getElementById('aparecerNoCalendario').checked,
                        notificarEquipe: document.getElementById('notificarEquipe').checked,
                        sincronizarStatus: document.getElementById('sincronizarStatus').checked
                    };

                    // ‚úÖ USAR APP.JS UNIFICADO
                    if (typeof App !== 'undefined' && App.criarTarefa) {
                        await App.criarTarefa(dadosTarefa);
                        this.notificar('‚úÖ Tarefa criada e sincronizada bidirecionalmente!', 'success');
                        
                        // üî• NOTIFICAR CALEND√ÅRIO PRINCIPAL SE MARCADO
                        if (dadosTarefa.aparecerNoCalendario) {
                            this.notificarCalendarioPrincipal('nova-tarefa', dadosTarefa);
                        }
                        
                    } else {
                        throw new Error('App.js n√£o dispon√≠vel');
                    }

                    this.fecharModal('modalNovaTarefa');
                    this.limparFormulario();
                    
                    // Recarregar dados
                    await this.carregarDadosBidirecionais();
                    this.renderizarGridBidirecional();
                    this.renderizarEventosEquipe();
                    this.atualizarEstatisticasBidirecional();

                } catch (error) {
                    console.error('‚ùå Erro ao salvar tarefa bidirecional:', error);
                    this.notificar('‚ùå Erro ao salvar tarefa: ' + error.message, 'error');
                }
            }

            // üî• NOTIFICAR CALEND√ÅRIO PRINCIPAL (bidirecional)
            notificarCalendarioPrincipal(acao, dados) {
                try {
                    // Emitir evento global para calend√°rio principal
                    window.dispatchEvent(new CustomEvent('agenda-bidirecional-update', {
                        detail: { acao, dados, timestamp: Date.now() }
                    }));
                    
                    console.log(`üì° Calend√°rio principal notificado: ${acao}`);
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao notificar calend√°rio principal:', error);
                }
            }

            // üë• GERENCIAR PARTICIPANTES (mantido)
            adicionarParticipante() {
                const input = document.getElementById('participanteInput');
                const nome = input.value.trim();
                
                if (nome && !this.participantesTemp.includes(nome)) {
                    this.participantesTemp.push(nome);
                    this.renderizarParticipantes();
                    input.value = '';
                }
            }

            removerParticipante(nome) {
                this.participantesTemp = this.participantesTemp.filter(p => p !== nome);
                this.renderizarParticipantes();
            }

            renderizarParticipantes() {
                const container = document.getElementById('participantesContainer');
                const input = container.querySelector('.participante-input');
                
                container.innerHTML = '';
                
                this.participantesTemp.forEach(nome => {
                    const tag = document.createElement('div');
                    tag.className = 'participante-tag';
                    tag.innerHTML = `
                        ${nome}
                        <span class="remove" onclick="agendaBidirecional.removerParticipante('${nome}')">&times;</span>
                    `;
                    container.appendChild(tag);
                });
                
                container.appendChild(input);
            }

            // üìã GERENCIAR SUBTAREFAS (mantido)
            adicionarSubtarefa() {
                const titulo = prompt('üìù T√≠tulo da subtarefa:');
                if (titulo && titulo.trim()) {
                    this.subtarefasTemp.push({
                        id: Date.now(),
                        titulo: titulo.trim(),
                        concluida: false
                    });
                    this.renderizarSubtarefas();
                }
            }

            toggleSubtarefa(id) {
                const subtarefa = this.subtarefasTemp.find(s => s.id === id);
                if (subtarefa) {
                    subtarefa.concluida = !subtarefa.concluida;
                    this.renderizarSubtarefas();
                }
            }

            removerSubtarefa(id) {
                this.subtarefasTemp = this.subtarefasTemp.filter(s => s.id !== id);
                this.renderizarSubtarefas();
            }

            renderizarSubtarefas() {
                const container = document.getElementById('subtarefasList');
                
                if (this.subtarefasTemp.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 12px; text-align: center; color: #9ca3af;">
                            Nenhuma subtarefa adicionada
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.subtarefasTemp.map(subtarefa => `
                    <div class="subtarefa-item">
                        <input type="checkbox" class="subtarefa-checkbox" ${subtarefa.concluida ? 'checked' : ''} 
                               onchange="agendaBidirecional.toggleSubtarefa(${subtarefa.id})">
                        <span class="subtarefa-texto ${subtarefa.concluida ? 'concluida' : ''}">${subtarefa.titulo}</span>
                        <div class="subtarefa-actions">
                            <button class="btn-icon" onclick="agendaBidirecional.removerSubtarefa(${subtarefa.id})" title="Remover">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            limparFormulario() {
                document.getElementById('formNovaTarefa').reset();
                this.participantesTemp = [];
                this.subtarefasTemp = [];
                this.renderizarParticipantes();
                this.renderizarSubtarefas();
            }

            // üîî NOTIFICA√á√ÉO
            notificar(mensagem, tipo = 'info') {
                if (typeof Notifications !== 'undefined') {
                    Notifications[tipo](mensagem);
                } else {
                    console.log(`${tipo.toUpperCase()}: ${mensagem}`);
                    // Fallback simples
                    const notification = document.getElementById('notification');
                    const text = document.getElementById('notificationText');
                    if (notification && text) {
                        text.textContent = mensagem;
                        notification.style.display = 'block';
                        setTimeout(() => {
                            notification.style.display = 'none';
                        }, 3000);
                    }
                }
            }

            // üîß UTILIT√ÅRIOS
            fecharModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('show');
                    setTimeout(() => {
                        modal.style.display = 'none';
                    }, 300);
                }
            }

            abrirModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'flex';
                    setTimeout(() => {
                        modal.classList.add('show');
                    }, 10);
                }
            }

            inicializarModoFallback() {
                console.log('üîÑ Inicializando modo fallback bidirecional...');
                this.usuarioAtual = { nome: 'Usu√°rio Demo', email: 'demo@biapo.com.br' };
                this.tarefas = [];
                this.eventos = [];
                this.eventosEquipe = [];
                
                document.getElementById('userName').textContent = this.usuarioAtual.nome;
                document.getElementById('userEmail').textContent = this.usuarioAtual.email;
                
                this.renderizarGridBidirecional();
                this.renderizarEventosEquipe();
                this.atualizarSemanaDisplay();
                this.atualizarEstatisticasBidirecional();
            }
        }

        // üöÄ INST√ÇNCIA GLOBAL
        let agendaBidirecional;

        // üìã FUN√á√ïES GLOBAIS DA INTERFACE BIDIRECIONAL v8.9.0
        function alternarVisualizacao(tipo) {
            agendaBidirecional.visualizacaoAtiva = tipo;
            
            document.querySelectorAll('.view-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-view="${tipo}"]`).classList.add('active');

            if (tipo === 'mixed') {
                // Vis√£o mista j√° √© o padr√£o na v8.9.0
                agendaBidirecional.renderizarGridBidirecional();
            } else if (tipo === 'grid') {
                agendaBidirecional.renderizarGridBidirecional();
            }
        }

        function aplicarFiltros() {
            agendaBidirecional.aplicarFiltros();
        }

        function navegarSemana(direcao) {
            agendaBidirecional.navegarSemana(direcao);
        }

        function irParaHoje() {
            agendaBidirecional.irParaHoje();
        }

        function mostrarModalNovaTarefa() {
            agendaBidirecional.limparFormulario();
            agendaBidirecional.abrirModal('modalNovaTarefa');
            
            // Definir data padr√£o como hoje
            document.getElementById('tarefaDataInicio').value = new Date().toISOString().split('T')[0];
        }

        function editarTarefaBidirecional(id) {
            console.log(`‚úèÔ∏è Editando tarefa bidirecional ID: ${id}`);
            // TODO: Implementar edi√ß√£o bidirecional
            alert('üöß Edi√ß√£o bidirecional ser√° implementada em breve!');
        }

        function abrirEventoEquipe(id) {
            console.log(`üìÖ Abrindo evento de equipe ID: ${id}`);
            
            // Tentar abrir via Events.js se dispon√≠vel
            if (typeof Events !== 'undefined' && Events.editarEvento) {
                Events.editarEvento(id);
            } else {
                // Abrir detalhes do evento
                const evento = agendaBidirecional.eventosEquipe.find(e => e.id == id);
                if (evento) {
                    const detalhes = `üìÖ EVENTO DE EQUIPE

T√≠tulo: ${evento.titulo}
Data: ${evento.data}
${evento.horarioInicio ? 'Hor√°rio: ' + evento.horarioInicio : ''}
${evento.local ? 'Local: ' + evento.local : ''}
Participantes: ${evento.participantes?.join(', ') || 'N/A'}

${evento.descricao ? 'Descri√ß√£o: ' + evento.descricao : ''}

üí° Este evento √© gerenciado pelo calend√°rio principal da equipe.`;
                    
                    alert(detalhes);
                }
            }
        }

        function marcarEventoNaAgenda(eventoId) {
            console.log(`üìã Marcando evento ${eventoId} na agenda pessoal`);
            // TODO: Implementar marca√ß√£o de evento na agenda
            agendaBidirecional.notificar('üìã Evento marcado na sua agenda pessoal!', 'success');
        }

        function criarTarefaRapida(data, horario) {
            console.log(`üöÄ Cria√ß√£o r√°pida bidirecional: ${data} √†s ${horario}`);
            mostrarModalNovaTarefa();
            document.getElementById('tarefaDataInicio').value = data;
            document.getElementById('tarefaHorario').value = horario;
        }

        function salvarNovaTarefaBidirecional() {
            agendaBidirecional.salvarNovaTarefaBidirecional();
        }

        function adicionarSubtarefa() {
            agendaBidirecional.adicionarSubtarefa();
        }

        function fecharModal(modalId) {
            agendaBidirecional.fecharModal(modalId);
        }

        // üî• FUN√á√ïES BIDIRECIONAL ESPEC√çFICAS v8.9.0
        function sincronizarBidirecional() {
            console.log('üîÑ Sincroniza√ß√£o bidirecional manual...');
            
            if (typeof App !== 'undefined' && App._salvarDadosUnificados) {
                App._salvarDadosUnificados().then(() => {
                    agendaBidirecional.carregarDadosBidirecionais();
                    agendaBidirecional.renderizarGridBidirecional();
                    agendaBidirecional.renderizarEventosEquipe();
                    agendaBidirecional.atualizarEstatisticasBidirecional();
                    agendaBidirecional.notificar('‚úÖ Sincroniza√ß√£o bidirecional completa!', 'success');
                });
            } else {
                agendaBidirecional.notificar('‚ö†Ô∏è App.js n√£o dispon√≠vel para sincroniza√ß√£o', 'warning');
            }
        }

        function abrirCalendarioPrincipal() {
            console.log('üìÖ Abrindo calend√°rio principal...');
            window.location.href = 'index.html';
        }

        function exportarAgenda() {
            agendaBidirecional.notificar('üìÑ Exporta√ß√£o ser√° implementada em breve!', 'info');
        }

        function mostrarRelatorios() {
            agendaBidirecional.notificar('üìä Relat√≥rios ser√£o implementados em breve!', 'info');
        }

        function voltarParaSistema() {
            window.location.href = 'index.html';
        }

        // üöÄ INICIALIZA√á√ÉO
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÖ Inicializando Agenda BIDIRECIONAL v8.9.0...');
            
            setTimeout(() => {
                agendaBidirecional = new AgendaBidirecional();
            }, 1000);
        });

        // ‚è∞ ATUALIZAR LINHA DO TEMPO A CADA MINUTO
        setInterval(() => {
            if (agendaBidirecional) {
                agendaBidirecional.renderizarGridBidirecional();
            }
        }, 60000);

        // üîß EVENTOS DE TECLADO
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    modal.classList.remove('show');
                    setTimeout(() => modal.style.display = 'none', 300);
                });
            }
        });

        // üî• LISTENER PARA CALEND√ÅRIO PRINCIPAL
        window.addEventListener('calendar-update', (e) => {
            console.log('üìÖ Calend√°rio principal atualizou - sincronizando agenda...', e.detail);
            if (agendaBidirecional) {
                agendaBidirecional.carregarDadosBidirecionais();
                agendaBidirecional.renderizarGridBidirecional();
                agendaBidirecional.renderizarEventosEquipe();
            }
        });

        // üî• LOGS BIDIRECIONAL
        console.log('üìÖ Agenda BIDIRECIONAL v8.9.0 carregada!');
        console.log('üî• FUNCIONALIDADES BIDIRECIONAL:');
        console.log('  ‚úÖ Sincroniza√ß√£o autom√°tica agenda ‚Üî calend√°rio');
        console.log('  ‚úÖ Eventos de equipe relevantes exibidos');
        console.log('  ‚úÖ Tarefas podem aparecer no calend√°rio principal');
        console.log('  ‚úÖ Navega√ß√£o fluida entre sistemas');
        console.log('  ‚úÖ Filtros por escopo (pessoal/equipe/p√∫blico)');
        console.log('  ‚úÖ Notifica√ß√£o de mudan√ßas em tempo real');
        console.log('üì° Sistema BIDIRECIONAL funcionando!');
    </script>
</body>
</html>
