<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o Completo - Obra 292 (Firebase v5.2)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f3f4f6;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Sistema de Login */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .login-container h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #1f2937;
        }
        
        /* Indicador de Sincroniza√ß√£o */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            transition: all 0.3s;
        }
        
        .sync-indicator.syncing {
            background: #fbbf24;
        }
        
        .sync-indicator.synced {
            background: #10b981;
            color: white;
        }
        
        .sync-indicator.error {
            background: #ef4444;
            color: white;
        }
        
        .sync-indicator.offline {
            background: #6b7280;
            color: white;
        }
        
        /* Sistema de Notifica√ß√µes */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }
        
        .notification.active {
            display: flex;
        }
        
        .notification.error {
            background: #ef4444;
        }
        
        .notification.warning {
            background: #f59e0b;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Todos os estilos originais do sistema */
        .header {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .breadcrumb {
            background: #e5e7eb;
            padding: 8px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        
        .breadcrumb span {
            color: #6b7280;
        }
        
        .breadcrumb a {
            color: #3b82f6;
            text-decoration: none;
            cursor: pointer;
        }
        
        .card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }
        
        .status-verde { background: #10b981; }
        .status-amarelo { background: #f59e0b; }
        .status-vermelho { background: #ef4444; }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .calendario {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
            margin-top: 20px;
        }
        
        .dia {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 12px;
            min-height: 120px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: visible;
        }
        
        .dia:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .dia-feriado {
            background: #fef3c7;
            border-color: #f59e0b;
        }
        
        .dia-header {
            background: #1f2937;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            border-radius: 8px;
        }
        
        .dia-numero {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .feriado-label {
            font-size: 10px;
            background: #f59e0b;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .evento {
            background: #3b82f6;
            color: white;
            padding: 6px 8px;
            border-radius: 6px;
            margin-top: 6px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 2px;
            position: relative;
            transition: all 0.2s;
            user-select: none;
        }
        
        .evento:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        .evento:hover::before {
            content: '‚úèÔ∏è';
            position: absolute;
            right: -20px;
            top: 0;
            opacity: 0.7;
            font-size: 12px;
        }
        
        .evento-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 4px;
        }
        
        .evento-info {
            font-size: 9px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .evento-reuniao { background: #3b82f6; }
        .evento-entrega { background: #10b981; }
        .evento-prazo { background: #ef4444; }
        .evento-marco { background: #8b5cf6; }
        .evento-outro { background: #6b7280; }
        
        .evento-dia-completo {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            margin: 2px -4px;
            padding: 6px 8px;
        }
        
        .evento-multi-dia {
            border-left: 3px solid #1e40af;
            background: linear-gradient(to right, #3b82f6, #60a5fa);
        }
        
        .area-card {
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .area-card:hover {
            transform: translateY(-4px);
            border-color: #3b82f6;
        }
        
        .back-btn {
            color: #3b82f6;
            cursor: pointer;
            margin-bottom: 16px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
        }
        
        .resumo-box {
            text-align: center;
            padding: 24px;
            border-radius: 12px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
        }
        
        .resumo-numero {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .search-box {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .search-box input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
        }
        
        .filter-pills {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .filter-pill {
            padding: 6px 16px;
            border-radius: 20px;
            background: #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .filter-pill.active {
            background: #3b82f6;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s;
        }
        
        .agenda-semana {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-top: 20px;
        }
        
        .dia-semana {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            min-height: 250px;
        }
        
        .tarefa {
            background: #f3f4f6;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            line-height: 1.3;
        }
        
        .tarefa:hover {
            background: #e5e7eb;
        }
        
        .tarefa .delete-btn,
        .tarefa .edit-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .tarefa:hover .delete-btn,
        .tarefa:hover .edit-btn {
            opacity: 1;
        }
        
        .tarefa-global {
            background: #ddd6fe;
            border: 1px solid #a78bfa;
        }
        
        .tarefa-recorrente {
            background: #d1fae5;
            border: 1px solid #6ee7b7;
        }
        
        .status-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: #1f2937;
            color: white;
        }
        
        .status-ausencia {
            background: #ef4444;
        }
        
        .status-home-office {
            background: #3b82f6;
        }
        
        .delete-btn {
            color: #ef4444;
            cursor: pointer;
            font-size: 12px;
            float: right;
            padding: 0 4px;
            margin-left: 8px;
            z-index: 10;
        }
        
        .delete-btn:hover {
            color: #dc2626;
            font-weight: bold;
        }
        
        .edit-btn {
            color: #3b82f6;
            cursor: pointer;
            font-size: 12px;
            margin-right: 8px;
        }
        
        .checkbox-group {
            display: flex;
            gap: 16px;
            margin-top: 8px;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* Melhorias de responsividade */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .calendario {
                grid-template-columns: repeat(7, 1fr);
                gap: 8px;
            }
            
            .dia {
                min-height: 80px;
                padding: 8px;
                font-size: 11px;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .agenda-semana {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 20px;
                margin: 10px;
            }
        }
        
        /* Indicadores de valida√ß√£o */
        .input-error {
            border-color: #ef4444 !important;
        }
        
        .error-message {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
        }
        
        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f4f6;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Estilos para sistema de tarefas */
        .tarefas-container {
            margin-top: 16px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .tarefa-item {
            background: white;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }
        
        .tarefa-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .tarefa-header {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .tarefa-expandir {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s;
        }
        
        .tarefa-expandir.expandido {
            transform: rotate(90deg);
        }
        
        .tarefa-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .tarefa-descricao {
            flex: 1;
            font-weight: 500;
        }
        
        .tarefa-descricao.concluida {
            text-decoration: line-through;
            color: #9ca3af;
        }
        
        .tarefa-info {
            display: flex;
            gap: 12px;
            align-items: center;
            font-size: 12px;
            color: #6b7280;
        }
        
        .subtarefas-container {
            margin-left: 32px;
            margin-top: 12px;
            padding-left: 16px;
            border-left: 2px solid #e5e7eb;
        }
        
        .subtarefa-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            margin-bottom: 4px;
            background: #f9fafb;
            border-radius: 4px;
        }
        
        .subtarefa-item:hover {
            background: #f3f4f6;
        }
        
        .prioridade-alta {
            color: #ef4444;
            font-weight: 500;
        }
        
        .prioridade-media {
            color: #f59e0b;
            font-weight: 500;
        }
        
        .prioridade-baixa {
            color: #10b981;
            font-weight: 500;
        }
        
        .dependencia-bloqueada {
            opacity: 0.6;
            position: relative;
        }
        
        .dependencia-bloqueada::before {
            content: 'üîí';
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .adicionar-tarefa-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: #3b82f6;
            color: white;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .adicionar-tarefa-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .contador-tarefas {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 12px;
            border-radius: 20px;
        }
        
        .btn-template {
            background: #8b5cf6;
            color: white;
        }
        
        .btn-template:hover {
            background: #7c3aed;
        }

        /* Alertas de prazo */
        .alerta-prazo {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 300px;
            z-index: 1500;
            animation: slideIn 0.3s ease-out;
        }

        .alerta-prazo.warning {
            background: #f59e0b;
        }

        .alerta-prazo .close-btn {
            float: right;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
        }

        .prazo-invalido {
            background: #fee2e2;
            border-color: #ef4444;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Melhorias visuais v5.2 */
        .evento-pessoal {
            background: #ddd6fe;
            border-left: 3px solid #8b5cf6;
        }

        .sincronizado-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 8px;
            background: #10b981;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen" class="login-container">
        <h2>üèóÔ∏è Sistema de Gest√£o</h2>
        <p style="text-align: center; color: #6b7280; margin-bottom: 24px;">Obra 292 - Museu Nacional</p>
        
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="loginEmail" placeholder="seu@email.com">
        </div>
        
        <div class="form-group">
            <label>Senha</label>
            <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        
        <button class="btn btn-primary" style="width: 100%;" onclick="fazerLogin()">
            Entrar
        </button>
        
        <div style="margin-top: 16px; text-align: center;">
            <a href="#" onclick="mostrarRegistro()" style="color: #3b82f6; text-decoration: none;">
                N√£o tem conta? Registre-se
            </a>
        </div>
    </div>
    
    <!-- Indicador de Sincroniza√ß√£o -->
    <div id="syncIndicator" class="sync-indicator synced">
        <span class="loading" id="syncLoader" style="display: none;"></span>
        <span id="syncText">‚úì Sincronizado</span>
    </div>
    
    <!-- Sistema de Notifica√ß√µes -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>
    
    <div class="container" id="mainContainer" class="hidden">
        <!-- Breadcrumb de Navega√ß√£o -->
        <div id="breadcrumb" class="breadcrumb hidden">
            <span id="breadcrumbPath"></span>
        </div>
        
        <div class="header">
            <div>
                <h1>Sistema de Gest√£o Otimizado</h1>
                <p>Obra 292 - Museu Nacional</p>
                <p style="font-size: 14px; color: #6b7280;">
                    Sistema v5.2 Otimizado - Foco em Usabilidade üöÄ
                    <span id="usuarioInfo" style="margin-left: 16px; font-weight: bold;"></span>
                </p>
            </div>
            <div style="text-align: right;">
                <p id="dataAtual" style="color: #6b7280;"></p>
                <p style="font-weight: bold;">
                    <span id="mesAno">Julho 2025</span>
                </p>
                <div style="margin-top: 8px;">
                    <button class="btn btn-success btn-sm" onclick="exportarDados()">
                        üì• Exportar
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="mostrarImportar()">
                        üì§ Importar
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="mostrarMarcarFeriado()">
                        üéâ Feriados
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="fazerLogout()">
                        üö™ Sair
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Executivo -->
        <div id="dashboardExecutivo">
            <!-- Estat√≠sticas R√°pidas -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="resumo-numero" style="color: #10b981;" id="statEmDia">0</div>
                    <div>Em Dia</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressEmDia" style="background: #10b981;"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="resumo-numero" style="color: #f59e0b;" id="statAtencao">0</div>
                    <div>Aten√ß√£o</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressAtencao" style="background: #f59e0b;"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="resumo-numero" style="color: #ef4444;" id="statAtraso">0</div>
                    <div>Atraso</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressAtraso" style="background: #ef4444;"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="resumo-numero" style="color: #8b5cf6;" id="statEventos">0</div>
                    <div>Eventos no M√™s</div>
                </div>
            </div>
            
            <!-- Calend√°rio -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üìÖ Calend√°rio da Equipe</h3>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary btn-sm" onclick="mudarMes(-1)">‚óÄ Anterior</button>
                        <button class="btn btn-primary btn-sm" onclick="mostrarNovoEvento()">+ Novo Evento</button>
                        <button class="btn btn-secondary btn-sm" onclick="mudarMes(1)">Pr√≥ximo ‚ñ∂</button>
                    </div>
                </div>
                
                <div id="calendario" class="calendario"></div>
                
                <div style="margin-top: 16px; display: flex; gap: 16px; flex-wrap: wrap; font-size: 12px;">
                    <span><span class="status-indicator evento-reuniao"></span>Reuni√£o</span>
                    <span><span class="status-indicator evento-entrega"></span>Entrega</span>
                    <span><span class="status-indicator evento-prazo"></span>Prazo</span>
                    <span><span class="status-indicator evento-marco"></span>Marco</span>
                    <span><span class="status-indicator evento-outro"></span>Outros</span>
                    <span><span class="status-indicator" style="background: #f59e0b;"></span>Feriado</span>
                    <span><span class="status-indicator" style="background: #8b5cf6;"></span>Tarefa Pessoal</span>
                </div>
            </div>
            
            <!-- Busca e Filtros -->
            <div class="card">
                <h3 style="margin-bottom: 16px;">üîç Busca Inteligente</h3>
                <div class="search-box">
                    <input type="text" placeholder="Buscar atividades, pessoas, eventos..." id="searchInput" onkeyup="buscarGlobalDebounced()">
                    <button class="btn btn-primary" onclick="buscarGlobal()">Buscar</button>
                </div>
                <div class="filter-pills">
                    <div class="filter-pill active" onclick="filtrarStatus('todos', this)">Todos</div>
                    <div class="filter-pill" onclick="filtrarStatus('verde', this)">Em Dia</div>
                    <div class="filter-pill" onclick="filtrarStatus('amarelo', this)">Aten√ß√£o</div>
                    <div class="filter-pill" onclick="filtrarStatus('vermelho', this)">Atraso</div>
                </div>
            </div>
            
            <!-- Dica do sistema -->
            <div style="background: #dbeafe; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; color: #1e40af;">
                <strong>üöÄ Sistema v5.2 - AGENDA COM DEBUG ATIVO:</strong> 
                <br><strong>‚úÖ Agenda da Semana:</strong> Mostra tarefas pessoais + eventos do calend√°rio + prazos pr√≥ximos
                <br><strong>üîß Debug Ativo:</strong> Abra o Console (F12) e veja os logs detalhados da agenda
                <br><strong>üß™ Teste Manual:</strong> No console digite <code>testarAgenda()</code> para teste direto
                <br><strong>üí° Como Testar:</strong> 1) Entre na agenda de qualquer pessoa 2) Veja os logs no console 3) A agenda deve mostrar itens
                <br><strong>üì± Ainda n√£o v√™ nada?</strong> Abra o console e me envie os logs que aparecem!
            </div>
            
            <!-- Cards das √Åreas -->
            <div class="grid" id="areasGrid"></div>
        </div>
        
        <!-- Painel de √Årea -->
        <div id="painelArea" class="hidden">
            <span class="back-btn" onclick="voltarDashboard()">‚Üê Voltar ao Dashboard</span>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 id="areaNome">Nome da √Årea</h2>
                        <p id="areaCoordenador" style="color: #6b7280;">Coordenador</p>
                    </div>
                    <button class="btn btn-primary" onclick="mostrarNovaAtividade()">+ Nova Atividade</button>
                </div>
            </div>
            
            <div class="grid">
                <div class="card">
                    <h3>üë• Equipe</h3>
                    <div id="equipeLista"></div>
                </div>
                
                <div class="card">
                    <h3>üìã Atividades em Andamento</h3>
                    <div id="atividadesLista"></div>
                </div>
            </div>
        </div>
        
        <!-- Agenda Individual -->
        <div id="agendaIndividual" class="hidden">
            <span class="back-btn" onclick="voltarParaArea()">‚Üê Voltar para √Årea</span>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 id="pessoaNome">Nome da Pessoa</h2>
                        <p id="pessoaCargo" style="color: #6b7280;">Cargo</p>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" onclick="mostrarNovaTarefa()">+ Nova Tarefa</button>
                        <button class="btn btn-warning btn-sm" onclick="mostrarMarcarStatus()">üìç Status Di√°rio</button>
                    </div>
                </div>
            </div>
            
            <div class="grid">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>üìä Minhas Responsabilidades</h3>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span id="contadorResponsabilidades" style="background: #e5e7eb; padding: 4px 12px; border-radius: 20px; font-size: 14px;">0</span>
                        </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <select id="filtroResponsabilidades" onchange="renderizarResponsabilidades(estadoSistema.pessoaAtual)" 
                                style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                            <option value="todas">üîç Todas as responsabilidades</option>
                            <option value="urgentes">‚ö° Urgentes (‚â§ 3 dias)</option>
                            <option value="emdia">‚úÖ Em dia</option>
                            <option value="atencao">‚ö†Ô∏è Aten√ß√£o</option>
                            <option value="atrasadas">‚ùå Atrasadas</option>
                        </select>
                    </div>
                    <div id="responsabilidadesLista"></div>
                </div>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>üìÖ Agenda da Semana</h3>
                        <div style="font-size: 11px; color: #6b7280; text-align: right;">
                            <div>üìù Tarefas pessoais</div>
                            <div>üìÖ Eventos do calend√°rio</div>
                            <div>‚è∞ Prazos pr√≥ximos</div>
                        </div>
                    </div>
                    <div class="agenda-semana" id="agendaSemana"></div>
                </div>
            </div>
            
            <div class="card">
                <h3>üìù Observa√ß√µes Pessoais</h3>
                <textarea id="observacoesPessoais" rows="3" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px;" 
                    placeholder="Adicione suas observa√ß√µes..." onblur="salvarObservacoes()"></textarea>
            </div>
        </div>
    </div>
    
    <!-- Modal de Novo/Editar Evento (Simplificado) -->
    <div id="modalEvento" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="margin-bottom: 24px;" id="modalEventoTitulo">Novo Evento</h3>
            <input type="hidden" id="eventoId">
            
            <div class="form-group">
                <label>Tipo de Evento <span style="color: #ef4444;">*</span></label>
                <select id="eventoTipo">
                    <option value="reuniao">üìÖ Reuni√£o</option>
                    <option value="entrega">üì¶ Entrega</option>
                    <option value="prazo">‚è∞ Prazo</option>
                    <option value="marco">üéØ Marco do Projeto</option>
                    <option value="outro">üìå Outro</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>T√≠tulo <span style="color: #ef4444;">*</span></label>
                <input type="text" id="eventoTitulo" placeholder="Digite o t√≠tulo do evento" required>
                <span class="error-message hidden" id="eventoTituloError">T√≠tulo √© obrigat√≥rio</span>
            </div>
            
            <div class="form-group">
                <label>Data <span style="color: #ef4444;">*</span></label>
                <input type="date" id="eventoData" required>
                <span class="error-message hidden" id="eventoDataError">Data √© obrigat√≥ria</span>
            </div>
            
            <div class="form-group">
                <label>Hor√°rio <span style="color: #ef4444;">*</span></label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <input type="time" id="eventoHorarioInicio" value="09:00" required>
                    <input type="time" id="eventoHorarioFim" value="10:00">
                </div>
                <span class="error-message hidden" id="eventoHorarioInicioError">Hor√°rio √© obrigat√≥rio</span>
            </div>
            
            <div class="form-group">
                <label>Participantes</label>
                <select id="eventoPessoas" onchange="adicionarPessoa()">
                    <option value="">Selecionar pessoa...</option>
                </select>
                <div id="pessoasSelecionadas" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px;"></div>
            </div>
            
            <div class="form-group">
                <label>Descri√ß√£o</label>
                <textarea id="eventoDescricao" rows="2" placeholder="Descri√ß√£o opcional..."></textarea>
            </div>
            
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="fecharModal('modalEvento')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarEvento()" id="btnSalvarEvento">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Nova/Editar Atividade -->
    <div id="modalAtividade" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 24px;" id="modalAtividadeTitulo">Nova Atividade</h3>
            <input type="hidden" id="atividadeId">
            <div class="form-group">
                <label>Nome da Atividade <span style="color: #ef4444;">*</span></label>
                <input type="text" id="atividadeNome" placeholder="Digite o nome da atividade" required>
                <span class="error-message hidden" id="atividadeNomeError">Nome √© obrigat√≥rio</span>
            </div>
            <div class="form-group">
                <label>Prazo <span style="color: #ef4444;">*</span></label>
                <input type="date" id="atividadePrazo" required onchange="validarPrazoAtividade()">
                <span class="error-message hidden" id="atividadePrazoError">Prazo √© obrigat√≥rio</span>
                <span class="error-message hidden" id="atividadePrazoPassadoError">‚ö†Ô∏è Prazo n√£o pode ser no passado!</span>
            </div>
            <div class="form-group">
                <label>Respons√°veis <span style="color: #ef4444;">*</span></label>
                <select id="atividadeResponsaveis" multiple style="height: 100px;" required></select>
                <small style="color: #6b7280;">Segure Ctrl para selecionar m√∫ltiplos</small>
                <span class="error-message hidden" id="atividadeResponsaveisError">Selecione ao menos um respons√°vel</span>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="atividadeStatus">
                    <option value="verde">üü¢ Em Dia</option>
                    <option value="amarelo">üü° Aten√ß√£o</option>
                    <option value="vermelho">üî¥ Atraso</option>
                </select>
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="fecharModal('modalAtividade')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarAtividade()" id="btnSalvarAtividade">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Nova Tarefa -->
    <div id="modalTarefa" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 24px;">Nova Tarefa Pessoal</h3>
            <div class="form-group">
                <label>Tipo de Agendamento</label>
                <select id="tarefaTipo" onchange="alternarTipoAgendamento()">
                    <option value="semanal">Dia da Semana</option>
                    <option value="data">Data Espec√≠fica</option>
                </select>
            </div>
            <div class="form-group" id="grupoDiaSemana">
                <label>Dia da Semana</label>
                <select id="tarefaDia">
                    <option value="segunda">Segunda-feira</option>
                    <option value="terca">Ter√ßa-feira</option>
                    <option value="quarta">Quarta-feira</option>
                    <option value="quinta">Quinta-feira</option>
                    <option value="sexta">Sexta-feira</option>
                </select>
            </div>
            <div class="form-group hidden" id="grupoData">
                <label>Data Espec√≠fica <span style="color: #ef4444;">*</span></label>
                <input type="date" id="tarefaDataEspecifica">
                <span class="error-message hidden" id="tarefaDataError">Data √© obrigat√≥ria</span>
            </div>
            <div class="form-group">
                <label>Descri√ß√£o <span style="color: #ef4444;">*</span></label>
                <input type="text" id="tarefaDescricao" placeholder="Digite a descri√ß√£o da tarefa" required>
                <span class="error-message hidden" id="tarefaDescricaoError">Descri√ß√£o √© obrigat√≥ria</span>
            </div>
            <div class="form-group">
                <label>Hor√°rio <span style="color: #ef4444;">*</span></label>
                <input type="time" id="tarefaHorario" required>
                <span class="error-message hidden" id="tarefaHorarioError">Hor√°rio √© obrigat√≥rio</span>
            </div>
            <div class="form-group">
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="tarefaCalendario">
                        üìÖ Mostrar no calend√°rio da equipe
                    </label>
                </div>
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="fecharModal('modalTarefa')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarTarefa()" id="btnSalvarTarefa">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Marcar Status -->
    <div id="modalStatus" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 24px;">Marcar Status do Dia</h3>
            <div class="form-group">
                <label>Data <span style="color: #ef4444;">*</span></label>
                <input type="date" id="statusData" required>
                <span class="error-message hidden" id="statusDataError">Data √© obrigat√≥ria</span>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="statusTipo">
                    <option value="presente">‚úÖ Presente</option>
                    <option value="ausencia">‚ùå Aus√™ncia</option>
                    <option value="home-office">üè† Home Office</option>
                </select>
            </div>
            <div class="form-group">
                <label>Observa√ß√£o (opcional)</label>
                <input type="text" id="statusObservacao" placeholder="Ex: Consulta m√©dica, reuni√£o externa...">
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="fecharModal('modalStatus')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarStatus()">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Marcar Feriado -->
    <div id="modalFeriado" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 24px;">Gerenciar Feriados</h3>
            <div class="form-group">
                <label>Data <span style="color: #ef4444;">*</span></label>
                <input type="date" id="feriadoData" required>
                <span class="error-message hidden" id="feriadoDataError">Data √© obrigat√≥ria</span>
            </div>
            <div class="form-group">
                <label>Nome do Feriado <span style="color: #ef4444;">*</span></label>
                <input type="text" id="feriadoNome" placeholder="Ex: Dia da Independ√™ncia" required>
                <span class="error-message hidden" id="feriadoNomeError">Nome √© obrigat√≥rio</span>
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="fecharModal('modalFeriado')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarFeriado()">Salvar</button>
            </div>
            
            <hr style="margin: 24px 0;">
            
            <h4 style="margin-bottom: 16px;">Feriados Cadastrados</h4>
            <div id="listaFeriados"></div>
        </div>
    </div>
    
    <!-- Modal de Importar -->
    <div id="modalImportar" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 24px;">Importar Dados</h3>
            <div class="form-group">
                <label>Selecione o arquivo JSON</label>
                <input type="file" id="importFile" accept=".json">
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="fecharModal('modalImportar')">Cancelar</button>
                <button class="btn btn-primary" onclick="importarDados()">Importar</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        // ========== CONFIGURA√á√ÉO DO FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCT0UXyU6AeurlaZdgM4_MKhzJWIdYxWg4",
            authDomain: "sistema-gestao-obra.firebaseapp.com",
            databaseURL: "https://sistema-gestao-obra-default-rtdb.firebaseio.com",
            projectId: "sistema-gestao-obra",
            storageBucket: "sistema-gestao-obra.firebasestorage.app",
            messagingSenderId: "686804029278",
            appId: "1:686804029278:web:758190822a19ef935e89cf",
            measurementId: "G-RE86WX5KY2"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // ========== VARI√ÅVEIS GLOBAIS ==========
        let usuarioAtual = null;
        let listenersDados = {};
        let intervaloPrazos = null;
        
        // Constantes e configura√ß√µes
        const VERSAO_SISTEMA = '5.2';
        const VERSAO_DB = 5;
        const INTERVALO_VERIFICACAO_PRAZOS = 3600000; // 1 hora
        
        // Estado Global do Sistema
        let estadoSistema = {
            mesAtual: 6,
            anoAtual: 2025,
            areaAtual: null,
            pessoaAtual: null,
            filtroAtual: 'todos',
            editandoAtividade: null,
            editandoEvento: null,
            pessoasSelecionadas: new Set(),
            versaoSistema: VERSAO_SISTEMA,
            usuarioEmail: null,
            usuarioNome: null,
            alertasPrazosExibidos: new Set()
        };
        
        // Dados do Sistema
        let dados = null;
        
        // ========== FUN√á√ïES DE AUTENTICA√á√ÉO ==========
        function mostrarLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainContainer').classList.add('hidden');
        }
        
        function esconderLogin() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainContainer').classList.remove('hidden');
        }
        
        function fazerLogin() {
            const email = document.getElementById('loginEmail').value;
            const senha = document.getElementById('loginPassword').value;
            
            if (!email || !senha) {
                mostrarNotificacao('Preencha todos os campos!', 'error');
                return;
            }
            
            mostrarNotificacao('Entrando...');
            
            auth.signInWithEmailAndPassword(email, senha)
                .then((userCredential) => {
                    usuarioAtual = userCredential.user;
                    inicializarSistema();
                })
                .catch((error) => {
                    console.error('Erro no login:', error);
                    if (error.code === 'auth/user-not-found') {
                        mostrarNotificacao('Usu√°rio n√£o encontrado!', 'error');
                    } else if (error.code === 'auth/wrong-password') {
                        mostrarNotificacao('Senha incorreta!', 'error');
                    } else {
                        mostrarNotificacao('Erro ao fazer login: ' + error.message, 'error');
                    }
                });
        }
        
        function mostrarRegistro() {
            const email = prompt('Digite seu email:');
            if (!email) return;
            
            const senha = prompt('Digite uma senha (m√≠nimo 6 caracteres):');
            if (!senha || senha.length < 6) {
                mostrarNotificacao('Senha deve ter no m√≠nimo 6 caracteres!', 'error');
                return;
            }
            
            const nome = prompt('Digite seu nome:');
            if (!nome) return;
            
            auth.createUserWithEmailAndPassword(email, senha)
                .then((userCredential) => {
                    return userCredential.user.updateProfile({
                        displayName: nome
                    });
                })
                .then(() => {
                    mostrarNotificacao('Conta criada com sucesso! Fazendo login...');
                    setTimeout(() => {
                        fazerLogin();
                    }, 1500);
                })
                .catch((error) => {
                    console.error('Erro ao criar conta:', error);
                    mostrarNotificacao('Erro ao criar conta: ' + error.message, 'error');
                });
        }
        
        function fazerLogout() {
            if (confirm('Deseja realmente sair?')) {
                Object.values(listenersDados).forEach(ref => {
                    if (ref && ref.off) {
                        ref.off();
                    }
                });

                if (intervaloPrazos) {
                    clearInterval(intervaloPrazos);
                }
                
                auth.signOut().then(() => {
                    mostrarNotificacao('At√© logo!');
                    mostrarLogin();
                }).catch((error) => {
                    console.error('Erro ao sair:', error);
                });
            }
        }
        
        // ========== SISTEMA DE SINCRONIZA√á√ÉO OTIMIZADO ==========
        function configurarSincronizacao() {
            console.log('‚öôÔ∏è Configurando sincroniza√ß√£o...');
            
            listenersDados.dados = database.ref('dados').on('value', (snapshot) => {
                const dadosServidor = snapshot.val();
                
                if (dadosServidor) {
                    console.log('üì• Dados recebidos do Firebase:', dadosServidor);
                    dados = dadosServidor;
                } else {
                    console.log('üìä Nenhum dado no Firebase - inicializando dados padr√£o...');
                    dados = inicializarDados();
                    console.log('üíæ Salvando dados iniciais no Firebase...');
                    salvarDados();
                }
                
                console.log('üîÑ Renderizando dashboard ap√≥s receber dados...');
                renderizarDashboard();
                atualizarIndicadorSync('synced');
                
                // ‚úÖ SINCRONIZA√á√ÉO AUTOM√ÅTICA MELHORADA
                sincronizarAgendasPessoais();
                
                console.log('‚úÖ Sincroniza√ß√£o configurada com sucesso');
            });
        }
        
        function atualizarIndicadorSync(status) {
            const indicator = document.getElementById('syncIndicator');
            const loader = document.getElementById('syncLoader');
            const text = document.getElementById('syncText');
            
            indicator.className = 'sync-indicator';
            
            switch(status) {
                case 'syncing':
                    indicator.classList.add('syncing');
                    loader.style.display = 'inline-block';
                    text.textContent = 'Sincronizando...';
                    break;
                case 'synced':
                    indicator.classList.add('synced');
                    loader.style.display = 'none';
                    text.textContent = '‚úì Sincronizado';
                    break;
                case 'error':
                    indicator.classList.add('error');
                    loader.style.display = 'none';
                    text.textContent = '‚úó Erro de sincroniza√ß√£o';
                    break;
                case 'offline':
                    indicator.classList.add('offline');
                    loader.style.display = 'none';
                    text.textContent = '‚óâ Offline';
                    break;
            }
        }
        
        // ========== FUN√á√ïES DE SALVAMENTO FIREBASE ==========
        function salvarDados() {
            if (!usuarioAtual) return;
            
            try {
                atualizarIndicadorSync('syncing');
                
                dados.ultimaAtualizacao = new Date().toISOString();
                dados.ultimoUsuario = usuarioAtual.email;
                
                database.ref('dados').set(dados).then(() => {
                    console.log('Dados salvos no Firebase');
                    atualizarIndicadorSync('synced');
                }).catch((error) => {
                    console.error('Erro ao salvar:', error);
                    atualizarIndicadorSync('error');
                    mostrarNotificacao('Erro ao salvar dados!', 'error');
                });
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
                atualizarIndicadorSync('error');
                mostrarNotificacao('Erro ao salvar dados!', 'error');
            }
        }
        
        // ========== FUN√á√ÉO DE TESTE PARA DEBUG ==========
        function testarAgenda() {
            console.log('üß™ TESTE: For√ßando renderiza√ß√£o da agenda...');
            
            if (!dados) {
                console.error('‚ùå TESTE: Dados n√£o existem!');
                dados = inicializarDados();
            }
            
            const container = document.getElementById('agendaSemana');
            if (!container) {
                console.error('‚ùå TESTE: Container n√£o encontrado!');
                return;
            }
            
            // Renderiza√ß√£o simples de teste
            container.innerHTML = `
                <div class="dia-semana">
                    <h4>TESTE - Segunda</h4>
                    <div class="tarefa" style="background: #dbeafe;">
                        <strong>üß™ TESTE FUNCIONANDO</strong><br>
                        <span style="font-size: 10px;">Se voc√™ v√™ isso, a agenda funciona!</span>
                    </div>
                </div>
                <div class="dia-semana">
                    <h4>TESTE - Ter√ßa</h4>
                    <div class="tarefa" style="background: #dcfce7;">
                        <strong>üìÖ Reuni√£o de teste</strong><br>
                        <span style="font-size: 10px;">10:00 - 11:00</span>
                    </div>
                </div>
                <div class="dia-semana">
                    <h4>TESTE - Quarta</h4>
                    <div class="tarefa" style="background: #fef3c7;">
                        <strong>‚è∞ Prazo de teste</strong><br>
                        <span style="font-size: 10px;">Atividade importante</span>
                    </div>
                </div>
                <div class="dia-semana">
                    <h4>TESTE - Quinta</h4>
                    <div style="text-align: center; color: #9ca3af; font-size: 12px; padding: 20px;">
                        Dia livre
                    </div>
                </div>
                <div class="dia-semana">
                    <h4>TESTE - Sexta</h4>
                    <div class="tarefa" style="background: #fce7f3;">
                        <strong>üéâ Fim de semana</strong><br>
                        <span style="font-size: 10px;">Descanso merecido!</span>
                    </div>
                </div>
            `;
            
            console.log('‚úÖ TESTE: Agenda de teste renderizada!');
        }
        
        // Adicionar ao console global para teste
        window.testarAgenda = testarAgenda;
        function iniciarVerificacaoPrazos() {
            verificarPrazosAtividades();
            
            intervaloPrazos = setInterval(() => {
                verificarPrazosAtividades();
            }, INTERVALO_VERIFICACAO_PRAZOS);
        }

        function verificarPrazosAtividades() {
            if (!dados || !dados.areas) return;

            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            Object.values(dados.areas).forEach(area => {
                area.atividades.forEach(atividade => {
                    const prazoData = new Date(atividade.prazo);
                    prazoData.setHours(0, 0, 0, 0);
                    
                    const diasRestantes = Math.floor((prazoData - hoje) / (1000 * 60 * 60 * 24));
                    const statusAnterior = atividade.status;
                    let novoStatus = statusAnterior;

                    if (diasRestantes < 0 && atividade.status !== 'vermelho') {
                        novoStatus = 'vermelho';
                    } else if (diasRestantes <= 3 && diasRestantes >= 0 && atividade.status === 'verde') {
                        novoStatus = 'amarelo';
                    }

                    if (novoStatus !== statusAnterior) {
                        atividade.status = novoStatus;
                        console.log(`Status da atividade "${atividade.nome}" alterado automaticamente de ${statusAnterior} para ${novoStatus}`);
                    }

                    // Alertas de prazo
                    const alertaKey = `${atividade.id}_${atividade.prazo}`;
                    if (!estadoSistema.alertasPrazosExibidos.has(alertaKey)) {
                        if (diasRestantes === 0) {
                            mostrarAlertaPrazo(`‚è∞ PRAZO HOJE: ${atividade.nome}`, 'error');
                            estadoSistema.alertasPrazosExibidos.add(alertaKey);
                        } else if (diasRestantes === 1) {
                            mostrarAlertaPrazo(`‚ö†Ô∏è Prazo amanh√£: ${atividade.nome}`, 'warning');
                            estadoSistema.alertasPrazosExibidos.add(alertaKey);
                        } else if (diasRestantes === -1) {
                            mostrarAlertaPrazo(`üö® ATRASADO: ${atividade.nome}`, 'error');
                            estadoSistema.alertasPrazosExibidos.add(alertaKey);
                        }
                    }
                });
            });

            salvarDados();
        }

        function mostrarAlertaPrazo(mensagem, tipo = 'warning') {
            const alertaExistente = document.querySelector('.alerta-prazo');
            if (alertaExistente) {
                alertaExistente.remove();
            }

            const alerta = document.createElement('div');
            alerta.className = `alerta-prazo ${tipo}`;
            alerta.innerHTML = `
                ${mensagem}
                <span class="close-btn" onclick="this.parentElement.remove()">√ó</span>
            `;

            document.body.appendChild(alerta);

            setTimeout(() => {
                if (alerta.parentElement) {
                    alerta.remove();
                }
            }, 10000);
        }

        function validarPrazoAtividade() {
            const prazoInput = document.getElementById('atividadePrazo');
            const hoje = new Date().toISOString().split('T')[0];
            
            if (prazoInput.value && prazoInput.value < hoje) {
                prazoInput.classList.add('prazo-invalido');
                document.getElementById('atividadePrazoPassadoError').classList.remove('hidden');
                mostrarNotificacao('N√£o √© poss√≠vel criar atividade com prazo no passado!', 'error');
                return false;
            } else {
                prazoInput.classList.remove('prazo-invalido');
                document.getElementById('atividadePrazoPassadoError').classList.add('hidden');
                return true;
            }
        }
        
        // ========== SINCRONIZA√á√ÉO AGENDA ‚Üî CALEND√ÅRIO OTIMIZADA ==========
        function sincronizarAgendasPessoais() {
            if (!dados || !estadoSistema.pessoaAtual) return;
            
            // Atualiza agenda da pessoa atual se estiver visualizando
            renderizarAgendaSemana(estadoSistema.pessoaAtual);
            
            console.log('‚úÖ Agendas sincronizadas automaticamente');
        }

        function sincronizarEventoParaAgendas(evento) {
            if (!evento.pessoas || evento.pessoas.length === 0) return;
            
            // Para cada pessoa no evento, garante visibilidade na agenda pessoal
            evento.pessoas.forEach(nomePessoa => {
                if (nomePessoa === '_todos' || nomePessoa === 'Todos') {
                    // Para toda a equipe - n√£o precisa fazer nada, 
                    // pois a agenda j√° mostra eventos onde a pessoa participa
                    console.log(`Evento "${evento.titulo}" ser√° vis√≠vel para toda equipe`);
                } else {
                    console.log(`Evento "${evento.titulo}" ser√° vis√≠vel para ${nomePessoa}`);
                }
            });
        }

        function filtrarTarefasParaCalendario(tarefa, pessoa) {
            // S√≥ mostra no calend√°rio se marcado explicitamente
            return tarefa.mostrarNoCalendario === true;
        }
        
        // ========== INICIALIZA√á√ÉO DO SISTEMA ==========
        function inicializarSistema() {
            console.log('üöÄ Iniciando Sistema de Gest√£o v5.2 Otimizado...');
            
            esconderLogin();
            
            estadoSistema.usuarioEmail = usuarioAtual.email;
            estadoSistema.usuarioNome = usuarioAtual.displayName || usuarioAtual.email.split('@')[0];
            
            document.getElementById('usuarioInfo').textContent = `üë§ ${estadoSistema.usuarioNome}`;
            
            try {
                // ‚úÖ GARANTIR QUE OS DADOS EXISTAM
                if (!dados) {
                    console.log('üìä Inicializando dados padr√£o...');
                    dados = inicializarDados();
                }
                
                configurarSincronizacao();
                console.log('‚úÖ Sincroniza√ß√£o Firebase configurada');
                
                iniciarVerificacaoPrazos();
                console.log('‚úÖ Verifica√ß√£o autom√°tica de prazos iniciada');
                
                // ‚úÖ FOR√áAR RENDERIZA√á√ÉO INICIAL
                setTimeout(() => {
                    console.log('üîÑ For√ßando renderiza√ß√£o inicial...');
                    renderizarDashboard();
                    
                    // Teste adicional da agenda
                    if (estadoSistema.pessoaAtual) {
                        renderizarAgendaSemana(estadoSistema.pessoaAtual);
                    }
                }, 1000);
                
                mostrarNotificacao(`‚ú® Bem-vindo(a), ${estadoSistema.usuarioNome}! Sistema v5.2 otimizado!`);
                
                console.log('üéâ Sistema v5.2 totalmente inicializado - AGENDA READY!');
                console.log('üí° DICA: Abra o console e digite testarAgenda() para teste');
                
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                mostrarNotificacao('Erro na inicializa√ß√£o do sistema', 'error');
            }
        }
        
        // ========== MONITORAR ESTADO DE AUTENTICA√á√ÉO ==========
        auth.onAuthStateChanged((user) => {
            if (user) {
                usuarioAtual = user;
                inicializarSistema();
            } else {
                mostrarLogin();
            }
        });
        
        // ========== DETECTOR DE CONEX√ÉO ==========
        window.addEventListener('online', () => {
            atualizarIndicadorSync('syncing');
            mostrarNotificacao('Conex√£o restaurada!');
        });
        
        window.addEventListener('offline', () => {
            atualizarIndicadorSync('offline');
            mostrarNotificacao('Sem conex√£o - trabalhando offline', 'error');
        });
        
        // ========== FUN√á√ïES DO SISTEMA ==========
        
        function inicializarDados() {
            return {
                versao: VERSAO_DB,
                areas: {
                    documentacao: {
                        nome: "Documenta√ß√£o & Arquivo",
                        coordenador: "Renato Remiro",
                        cor: "#8b5cf6",
                        equipe: [
                            {nome: "Renato", cargo: "Coordenador"},
                            {nome: "Bruna", cargo: "Arquiteta Trainee"},
                            {nome: "Juliana A.", cargo: "Estagi√°ria de Arquitetura"},
                            {nome: "Lara", cargo: "Arquiteta Trainee"}
                        ],
                        atividades: [
                            {id: 1, nome: "As Built", status: "verde", prazo: "2025-07-18", responsaveis: ["Renato", "Bruna"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 2, nome: "Relat√≥rio Fotogr√°fico", status: "amarelo", prazo: "2025-07-12", responsaveis: ["Bruna"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 3, nome: "Manual de Conserva√ß√£o", status: "verde", prazo: "2025-07-25", responsaveis: ["Renato"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 4, nome: "BIM 2D", status: "verde", prazo: "2025-07-20", responsaveis: ["Bruna"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 5, nome: "BIM", status: "verde", prazo: "2025-07-22", responsaveis: ["Bruna"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 6, nome: "Databook", status: "verde", prazo: "2025-07-18", responsaveis: ["Juliana A."], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []}
                        ]
                    },
                    planejamento: {
                        nome: "Planejamento & Controle de Obra",
                        coordenador: "Isabella Rocha (Coord. Geral)",
                        cor: "#06b6d4",
                        equipe: [
                            {nome: "Isabella", cargo: "Coordenadora Geral"},
                            {nome: "Lara", cargo: "Arquiteta Trainee"},
                            {nome: "Eduardo", cargo: "Engenheiro Civil"},
                            {nome: "Beto", cargo: "Arquiteto"},
                            {nome: "Jean", cargo: "Estagi√°rio de Eng. Civil"}
                        ],
                        atividades: [
                            {id: 7, nome: "Cronograma Longo Prazo (CLP)", status: "verde", prazo: "2025-07-10", responsaveis: ["Lara", "Isabella"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 8, nome: "PPCO", status: "verde", prazo: "2025-07-31", responsaveis: ["Lara", "Isabella"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 9, nome: "V√≠nculos Or√ßament√°rios", status: "verde", prazo: "2025-07-31", responsaveis: ["Lara", "Isabella"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 10, nome: "CFF", status: "amarelo", prazo: "2025-07-15", responsaveis: ["Isabella"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 11, nome: "Previs√£o Financeira", status: "verde", prazo: "2025-07-31", responsaveis: ["Eduardo", "Isabella"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 12, nome: "Planilha de Medi√ß√£o", status: "amarelo", prazo: "2025-07-12", responsaveis: ["Lara", "Isabella"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 13, nome: "CCP", status: "verde", prazo: "2025-07-05", responsaveis: ["Lara", "Beto", "Eduardo"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []}
                        ]
                    },
                    producao: {
                        nome: "Produ√ß√£o & Qualidade",
                        coordenador: "Beto / Eduardo",
                        cor: "#ef4444",
                        equipe: [
                            {nome: "Beto", cargo: "Arquiteto"},
                            {nome: "Eduardo", cargo: "Coordenador Eng. Civil"},
                            {nome: "Jean", cargo: "Estagi√°rio de Eng. Civil"},
                            {nome: "Nominato", cargo: "Almoxarifado"},
                            {nome: "Alex", cargo: "Comprador"},
                            {nome: "Manu", cargo: "Assistente de Arquitetura"},
                            {nome: "Marcus", cargo: "Especialista Meio Ambiente"},
                            {nome: "Juliana E.", cargo: "T√©cnica de Enfermagem"},
                            {nome: "Carlos", cargo: "T√©cnico de Seguran√ßa"}
                        ],
                        atividades: [
                            {id: 14, nome: "Levantamento de Materiais", status: "verde", prazo: "2025-07-05", responsaveis: ["Jean", "Beto", "Eduardo"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 15, nome: "Certifica√ß√£o de Estoque", status: "verde", prazo: "2025-07-31", responsaveis: ["Nominato", "Jean", "Eduardo"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 16, nome: "Controle de Patrim√¥nio", status: "verde", prazo: "2025-07-31", responsaveis: ["Nominato", "Alex"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 17, nome: "Procedimento SIENGE", status: "amarelo", prazo: "2025-07-09", responsaveis: ["Alex", "Eduardo"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 18, nome: "Lan√ßamento de Solicita√ß√µes", status: "verde", prazo: "2025-07-01", responsaveis: ["Nominato", "Alex", "Eduardo"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []},
                            {id: 19, nome: "Negocia√ß√µes de Compra", status: "amarelo", prazo: "2025-07-05", responsaveis: ["Alex", "Eduardo"], progresso: 0, dataAdicionado: new Date().toISOString(), tarefas: []}
                        ]
                    }
                },
                eventos: [
                    {
                        id: 1, 
                        titulo: "Reuni√£o semanal de planejamento", 
                        tipo: "reuniao",
                        data: "2025-07-01",
                        horarioInicio: "09:00",
                        horarioFim: "11:00",
                        pessoas: ["Isabella", "Lara", "Eduardo", "Beto", "Renato"],
                        descricao: "Revis√£o do cronograma e distribui√ß√£o de tarefas da semana"
                    },
                    {
                        id: 2, 
                        titulo: "Entrega Relat√≥rio Fotogr√°fico", 
                        tipo: "entrega",
                        data: "2025-07-15",
                        horarioInicio: "17:00",
                        pessoas: ["Bruna"],
                        descricao: "Entrega mensal do relat√≥rio com registro fotogr√°fico do progresso da obra"
                    },
                    {
                        id: 3, 
                        titulo: "Revis√£o As Built", 
                        tipo: "reuniao",
                        data: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0], // Amanh√£
                        horarioInicio: "14:00",
                        horarioFim: "16:00",
                        pessoas: ["Renato", "Bruna"],
                        descricao: "Revis√£o final do As Built antes da entrega"
                    },
                    {
                        id: 4, 
                        titulo: "Teste Agenda - Hoje", 
                        tipo: "reuniao",
                        data: new Date().toISOString().split('T')[0], // Hoje
                        horarioInicio: "15:00",
                        horarioFim: "16:00",
                        pessoas: ["Renato"],
                        descricao: "Evento de teste para verificar agenda"
                    }
                ],
                agendas: {
                    "Renato": {
                        "segunda": [
                            {
                                id: Date.now(),
                                descricao: "Verificar projetos - 08:00",
                                mostrarNoCalendario: true
                            },
                            {
                                id: Date.now() + 1,
                                descricao: "Email importante - 09:30",
                                mostrarNoCalendario: false
                            }
                        ],
                        "quarta": [
                            {
                                id: Date.now() + 2,
                                descricao: "Reuni√£o coordenadores - 15:00",
                                mostrarNoCalendario: false
                            }
                        ],
                        observacoes: "Focando na finaliza√ß√£o do As Built esta semana."
                    },
                    "Bruna": {
                        "terca": [
                            {
                                id: Date.now() + 3,
                                descricao: "Atualizar BIM - 10:00",
                                mostrarNoCalendario: true
                            }
                        ],
                        "sexta": [
                            {
                                id: Date.now() + 4,
                                descricao: "Relat√≥rio semanal - 16:00",
                                mostrarNoCalendario: false
                            }
                        ]
                    },
                    "Isabella": {
                        "segunda": [
                            {
                                id: Date.now() + 5,
                                descricao: "Planejamento semanal - 07:30",
                                mostrarNoCalendario: true
                            }
                        ]
                    }
                },
                feriados: {},
                statusPessoal: {},
                ultimaAtualizacao: new Date().toISOString()
            };
        }
        
        // Fun√ß√µes de Utilidade
        function mostrarNotificacao(texto, tipo = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            notificationText.textContent = texto;
            notification.className = `notification ${tipo === 'error' ? 'error' : tipo === 'warning' ? 'warning' : ''}`;
            notification.classList.add('active');
            setTimeout(() => {
                notification.classList.remove('active');
            }, 3000);
        }
        
        function formatarData(data) {
            try {
                const d = new Date(data);
                if (isNaN(d.getTime())) {
                    console.error('‚ùå Data inv√°lida:', data);
                    return 'Data inv√°lida';
                }
                return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}`;
            } catch (error) {
                console.error('‚ùå Erro ao formatar data:', error);
                return 'Erro';
            }
        }
        
        function calcularDiasRestantes(prazo) {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const dataPrazo = new Date(prazo);
            dataPrazo.setHours(0, 0, 0, 0);
            return Math.floor((dataPrazo - hoje) / (1000 * 60 * 60 * 24));
        }

        function normalizarTexto(texto) {
            return texto.toLowerCase()
                       .normalize('NFD')
                       .replace(/[\u0300-\u036f]/g, '');
        }
        
        // Fun√ß√µes de Calend√°rio
        function gerarCalendario() {
            const calendario = document.getElementById('calendario');
            calendario.innerHTML = '';
            
            const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            diasSemana.forEach(dia => {
                const header = document.createElement('div');
                header.className = 'dia-header';
                header.textContent = dia;
                calendario.appendChild(header);
            });
            
            const primeiroDia = new Date(estadoSistema.anoAtual, estadoSistema.mesAtual, 1);
            const ultimoDia = new Date(estadoSistema.anoAtual, estadoSistema.mesAtual + 1, 0);
            const primeiroDiaSemana = primeiroDia.getDay();
            
            for (let i = 0; i < primeiroDiaSemana; i++) {
                const diaVazio = document.createElement('div');
                diaVazio.className = 'dia';
                diaVazio.style.background = '#f9fafb';
                calendario.appendChild(diaVazio);
            }
            
            for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
                const diaDiv = document.createElement('div');
                diaDiv.className = 'dia';
                
                const dataCompleta = `${estadoSistema.anoAtual}-${String(estadoSistema.mesAtual + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                
                if (dados.feriados && dados.feriados[dataCompleta]) {
                    diaDiv.classList.add('dia-feriado');
                }
                
                const numeroDiv = document.createElement('div');
                numeroDiv.className = 'dia-numero';
                numeroDiv.innerHTML = `<span>${dia}</span>`;
                
                if (dados.feriados && dados.feriados[dataCompleta]) {
                    numeroDiv.innerHTML += `<span class="feriado-label" title="${dados.feriados[dataCompleta]}">Feriado</span>`;
                }
                
                diaDiv.appendChild(numeroDiv);
                
                const eventosDia = obterEventosDoDia(dataCompleta);
                
                eventosDia.sort((a, b) => {
                    const horaA = a.horarioInicio || '00:00';
                    const horaB = b.horarioInicio || '00:00';
                    return horaA.localeCompare(horaB);
                });
                
                eventosDia.forEach(evento => {
                    const eventoDiv = document.createElement('div');
                    let classesEvento = `evento evento-${evento.tipo}`;
                    
                    // ‚úÖ MELHORIA: Diferencia√ß√£o visual para tarefas pessoais
                    if (evento.origem === 'tarefa_pessoal') {
                        classesEvento += ' evento-pessoal';
                    }
                    
                    eventoDiv.className = classesEvento;
                    
                    let iconeTipo = '';
                    switch(evento.tipo) {
                        case 'reuniao': iconeTipo = 'üìÖ'; break;
                        case 'entrega': iconeTipo = 'üì¶'; break;
                        case 'prazo': iconeTipo = '‚è∞'; break;
                        case 'marco': iconeTipo = 'üéØ'; break;
                        case 'outro': iconeTipo = 'üìå'; break;
                    }
                    
                    let htmlEvento = `
                        <div class="evento-header">
                            <span>${iconeTipo} ${evento.horarioInicio || 'Todo dia'}</span>
                            ${evento.origem === 'tarefa_pessoal' ? '<span class="sincronizado-badge">üë§</span>' : ''}
                        </div>
                        <div style="font-weight: 500;">${evento.titulo}</div>
                    `;
                    
                    if (evento.pessoas && evento.pessoas.length > 0) {
                        const labelPessoas = evento.tipo === 'reuniao' ? 'üë•' : 'üë§';
                        htmlEvento += `<div class="evento-info">${labelPessoas} ${evento.pessoas.length} ${evento.pessoas.length > 1 ? 'pessoas' : 'pessoa'}</div>`;
                    }
                    
                    if (evento.horarioFim) {
                        htmlEvento += `<div class="evento-info">at√© ${evento.horarioFim}</div>`;
                    }
                    
                    eventoDiv.innerHTML = htmlEvento;
                    
                    eventoDiv.onclick = function(e) {
                        e.stopPropagation();
                        if (evento.origem !== 'tarefa_pessoal') {
                            editarEvento(evento);
                        }
                    };
                    
                    eventoDiv.title = `${evento.titulo}\n${evento.descricao || ''}${evento.origem === 'tarefa_pessoal' ? '\nüë§ Tarefa pessoal' : '\n‚úèÔ∏è Clique para editar'}`;
                    
                    if (evento.origem !== 'tarefa_pessoal') {
                        const deleteBtn = document.createElement('span');
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.innerHTML = '√ó';
                        deleteBtn.onclick = function(e) {
                            e.stopPropagation();
                            deletarEvento(evento.id);
                        };
                        eventoDiv.appendChild(deleteBtn);
                    }
                    
                    diaDiv.appendChild(eventoDiv);
                });
                
                diaDiv.onclick = (e) => {
                    if (e.target === diaDiv || e.target.classList.contains('dia-numero')) {
                        document.getElementById('eventoData').value = dataCompleta;
                        mostrarNovoEvento();
                    }
                };
                
                calendario.appendChild(diaDiv);
            }
            
            const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            document.getElementById('mesAno').textContent = `${meses[estadoSistema.mesAtual]} ${estadoSistema.anoAtual}`;
        }
        
        function obterEventosDoDia(data) {
            if (!dados || !dados.eventos) return [];
            
            const eventos = [];
            
            // Eventos normais do calend√°rio
            dados.eventos.forEach(evento => {
                if (evento.data === data) {
                    eventos.push(evento);
                }
            });
            
            // ‚úÖ MELHORIA: Tarefas pessoais que devem aparecer no calend√°rio
            if (dados.agendas) {
                const dataObj = new Date(data);
                const diaSemana = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'][dataObj.getDay()];
                
                Object.entries(dados.agendas).forEach(([nomePessoa, agenda]) => {
                    // Tarefas semanais que devem aparecer no calend√°rio
                    if (agenda[diaSemana]) {
                        agenda[diaSemana].forEach(tarefa => {
                            if (filtrarTarefasParaCalendario(tarefa, nomePessoa)) {
                                eventos.push({
                                    id: `tarefa_${tarefa.id}`,
                                    titulo: tarefa.descricao.split(' - ')[0],
                                    tipo: 'outro',
                                    horarioInicio: tarefa.descricao.split(' - ')[1] || '',
                                    pessoas: [nomePessoa],
                                    origem: 'tarefa_pessoal',
                                    data: data,
                                    descricao: `Tarefa pessoal de ${nomePessoa}`
                                });
                            }
                        });
                    }
                });
            }
            
            return eventos;
        }
        
        function mudarMes(direcao) {
            estadoSistema.mesAtual += direcao;
            if (estadoSistema.mesAtual < 0) {
                estadoSistema.mesAtual = 11;
                estadoSistema.anoAtual--;
            } else if (estadoSistema.mesAtual > 11) {
                estadoSistema.mesAtual = 0;
                estadoSistema.anoAtual++;
            }
            gerarCalendario();
            atualizarEstatisticas();
        }
        
        // Fun√ß√µes de Dashboard
        function renderizarDashboard() {
            if (!dados) return;
            
            renderizarAreas();
            gerarCalendario();
            atualizarEstatisticas();
            atualizarDataAtual();
            preencherSelectResponsaveis();
        }
        
        function renderizarAreas() {
            const grid = document.getElementById('areasGrid');
            if (!grid || !dados) return;
            
            grid.innerHTML = '';
            
            Object.entries(dados.areas).forEach(([key, area]) => {
                const statusCount = contarStatus(area.atividades);
                const card = document.createElement('div');
                card.className = 'card area-card';
                card.onclick = () => mostrarArea(key);
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>${area.nome}</h3>
                        <div style="width: 20px; height: 20px; background: ${area.cor}; border-radius: 50%;"></div>
                    </div>
                    <p style="color: #6b7280; margin-bottom: 16px;">Coord: ${area.coordenador}</p>
                    <div style="margin-bottom: 16px;">
                        <div style="margin-bottom: 8px;">
                            <span class="status-indicator status-verde"></span>Em dia: ${statusCount.verde}
                        </div>
                        <div style="margin-bottom: 8px;">
                            <span class="status-indicator status-amarelo"></span>Aten√ß√£o: ${statusCount.amarelo}
                        </div>
                        <div>
                            <span class="status-indicator status-vermelho"></span>Atraso: ${statusCount.vermelho}
                        </div>
                    </div>
                    <p style="color: #3b82f6; font-weight: 500;">Ver detalhes ‚Üí</p>
                `;
                
                grid.appendChild(card);
            });
        }
        
        function contarStatus(atividades) {
            return atividades.reduce((acc, ativ) => {
                acc[ativ.status]++;
                return acc;
            }, {verde: 0, amarelo: 0, vermelho: 0});
        }
        
        function atualizarEstatisticas() {
            if (!dados) return;
            
            let totalVerde = 0, totalAmarelo = 0, totalVermelho = 0;
            
            Object.values(dados.areas).forEach(area => {
                const count = contarStatus(area.atividades);
                totalVerde += count.verde;
                totalAmarelo += count.amarelo;
                totalVermelho += count.vermelho;
            });
            
            const total = totalVerde + totalAmarelo + totalVermelho;
            
            document.getElementById('statEmDia').textContent = totalVerde;
            document.getElementById('statAtencao').textContent = totalAmarelo;
            document.getElementById('statAtraso').textContent = totalVermelho;
            
            if (total > 0) {
                document.getElementById('progressEmDia').style.width = `${(totalVerde / total) * 100}%`;
                document.getElementById('progressAtencao').style.width = `${(totalAmarelo / total) * 100}%`;
                document.getElementById('progressAtraso').style.width = `${(totalVermelho / total) * 100}%`;
            }
            
            // Contar eventos do m√™s
            const eventosDoMes = [];
            const primeiroDia = new Date(estadoSistema.anoAtual, estadoSistema.mesAtual, 1);
            const ultimoDia = new Date(estadoSistema.anoAtual, estadoSistema.mesAtual + 1, 0);
            
            for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
                const data = `${estadoSistema.anoAtual}-${String(estadoSistema.mesAtual + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                const eventosDia = obterEventosDoDia(data);
                eventosDoMes.push(...eventosDia);
            }
            
            document.getElementById('statEventos').textContent = eventosDoMes.length;
        }
        
        function atualizarDataAtual() {
            const hoje = new Date();
            const opcoes = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('dataAtual').textContent = hoje.toLocaleDateString('pt-BR', opcoes);
        }
        
        // Fun√ß√µes de Navega√ß√£o
        function mostrarArea(areaKey) {
            estadoSistema.areaAtual = areaKey;
            const area = dados.areas[areaKey];
            
            document.getElementById('dashboardExecutivo').classList.add('hidden');
            document.getElementById('painelArea').classList.remove('hidden');
            document.getElementById('agendaIndividual').classList.add('hidden');
            
            document.getElementById('areaNome').textContent = area.nome;
            document.getElementById('areaCoordenador').textContent = `Coordenador: ${area.coordenador}`;
            
            renderizarEquipe(area);
            renderizarAtividades(area);
            
            atualizarBreadcrumb(`Dashboard > ${area.nome}`);
        }
        
        function renderizarEquipe(area) {
            const lista = document.getElementById('equipeLista');
            lista.innerHTML = '';
            
            area.equipe.forEach(membro => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 12px; background: #f9fafb; margin-bottom: 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s;';
                div.onmouseover = () => div.style.background = '#e5e7eb';
                div.onmouseout = () => div.style.background = '#f9fafb';
                div.onclick = () => mostrarAgendaIndividual(membro.nome, membro.cargo);
                
                div.innerHTML = `
                    <strong>${membro.nome}</strong><br>
                    <span style="color: #6b7280; font-size: 14px;">${membro.cargo}</span>
                    <span style="float: right; color: #3b82f6;">‚Üí</span>
                `;
                
                lista.appendChild(div);
            });
        }
        
        function renderizarAtividades(area) {
            const lista = document.getElementById('atividadesLista');
            lista.innerHTML = '';
            
            const atividadesFiltradas = estadoSistema.filtroAtual === 'todos' 
                ? area.atividades 
                : area.atividades.filter(a => a.status === estadoSistema.filtroAtual);
            
            atividadesFiltradas.forEach(atividade => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 12px; border: 1px solid #e5e7eb; margin-bottom: 12px; border-radius: 8px;';
                
                const diasRestantes = calcularDiasRestantes(atividade.prazo);
                
                div.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="status-indicator status-${atividade.status}"></span>
                            <strong>${atividade.nome}</strong>
                            ${diasRestantes < 0 ? '<span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">ATRASADO</span>' : 
                              diasRestantes === 0 ? '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">HOJE</span>' :
                              diasRestantes <= 3 ? '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">URGENTE</span>' : ''}
                        </div>
                        <div>
                            <button class="btn btn-primary btn-sm" onclick="editarAtividade(${atividade.id})">‚úèÔ∏è Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="deletarAtividade(${atividade.id})">Excluir</button>
                        </div>
                    </div>
                    <div style="font-size: 13px; color: #6b7280; margin-top: 8px;">
                        ${atividade.responsaveis.join(', ')} - Prazo: ${formatarData(atividade.prazo)}
                    </div>
                    <div style="margin-top: 8px;">
                        <select onchange="mudarStatus(${atividade.id}, this.value)" style="padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                            <option value="verde" ${atividade.status === 'verde' ? 'selected' : ''}>üü¢ Em Dia</option>
                            <option value="amarelo" ${atividade.status === 'amarelo' ? 'selected' : ''}>üü° Aten√ß√£o</option>
                            <option value="vermelho" ${atividade.status === 'vermelho' ? 'selected' : ''}>üî¥ Atraso</option>
                        </select>
                    </div>
                `;
                
                lista.appendChild(div);
            });
            
            if (atividadesFiltradas.length === 0) {
                lista.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <p>Nenhuma atividade encontrada.</p>
                    </div>
                `;
            }
        }
        
        function voltarDashboard() {
            document.getElementById('painelArea').classList.add('hidden');
            document.getElementById('agendaIndividual').classList.add('hidden');
            document.getElementById('dashboardExecutivo').classList.remove('hidden');
            document.getElementById('breadcrumb').classList.add('hidden');
            renderizarDashboard();
        }
        
        function voltarParaArea() {
            document.getElementById('agendaIndividual').classList.add('hidden');
            document.getElementById('painelArea').classList.remove('hidden');
            mostrarArea(estadoSistema.areaAtual);
        }
        
        // Fun√ß√µes de Eventos Simplificados
        function mostrarNovoEvento() {
            estadoSistema.editandoEvento = null;
            estadoSistema.pessoasSelecionadas.clear();
            
            document.getElementById('modalEventoTitulo').textContent = 'Novo Evento';
            document.getElementById('eventoId').value = '';
            
            // Limpar campos
            document.getElementById('eventoTipo').value = 'reuniao';
            document.getElementById('eventoTitulo').value = '';
            document.getElementById('eventoDescricao').value = '';
            document.getElementById('eventoHorarioInicio').value = '09:00';
            document.getElementById('eventoHorarioFim').value = '10:00';
            
            atualizarListaPessoas();
            
            document.getElementById('modalEvento').classList.add('active');
        }
        
        function preencherSelectResponsaveis() {
            const select = document.getElementById('eventoPessoas');
            if (!select || !dados) return;
            
            select.innerHTML = '<option value="">Selecionar pessoa...</option>';
            
            const membrosUnicos = new Map();
            Object.values(dados.areas).forEach(area => {
                area.equipe.forEach(membro => {
                    if (!membrosUnicos.has(membro.nome)) {
                        membrosUnicos.set(membro.nome, {
                            nome: membro.nome,
                            cargo: membro.cargo,
                            area: area.nome
                        });
                    }
                });
            });
            
            const optionTodos = document.createElement('option');
            optionTodos.value = '_todos';
            optionTodos.textContent = 'üåê Toda Equipe';
            select.appendChild(optionTodos);
            
            Array.from(membrosUnicos.values())
                .sort((a, b) => a.nome.localeCompare(b.nome))
                .forEach(membro => {
                    const option = document.createElement('option');
                    option.value = membro.nome;
                    option.textContent = `${membro.nome} - ${membro.cargo}`;
                    select.appendChild(option);
                });
        }
        
        function adicionarPessoa() {
            const select = document.getElementById('eventoPessoas');
            const valor = select.value;
            
            if (!valor) return;
            
            if (valor === '_todos') {
                const membrosUnicos = new Set();
                Object.values(dados.areas).forEach(area => {
                    area.equipe.forEach(membro => {
                        membrosUnicos.add(membro.nome);
                    });
                });
                membrosUnicos.forEach(nome => estadoSistema.pessoasSelecionadas.add(nome));
            } else {
                estadoSistema.pessoasSelecionadas.add(valor);
            }
            
            select.value = '';
            atualizarListaPessoas();
        }
        
        function atualizarListaPessoas() {
            const container = document.getElementById('pessoasSelecionadas');
            container.innerHTML = '';
            
            Array.from(estadoSistema.pessoasSelecionadas).sort().forEach(pessoa => {
                const chip = document.createElement('div');
                chip.style.cssText = 'background: #e5e7eb; padding: 4px 12px; border-radius: 16px; font-size: 13px; display: inline-flex; align-items: center; gap: 4px; margin: 2px;';
                chip.innerHTML = `
                    ${pessoa}
                    <span style="cursor: pointer; color: #6b7280; font-weight: bold;" onclick="removerPessoa('${pessoa}')">√ó</span>
                `;
                container.appendChild(chip);
            });
        }
        
        function removerPessoa(nome) {
            estadoSistema.pessoasSelecionadas.delete(nome);
            atualizarListaPessoas();
        }
        
        function salvarEvento() {
            if (!validarFormulario([
                {id: 'eventoData'},
                {id: 'eventoTitulo'},
                {id: 'eventoHorarioInicio'}
            ])) {
                mostrarNotificacao('Preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }
            
            const evento = {
                id: estadoSistema.editandoEvento || Date.now(),
                titulo: document.getElementById('eventoTitulo').value,
                tipo: document.getElementById('eventoTipo').value,
                descricao: document.getElementById('eventoDescricao').value,
                data: document.getElementById('eventoData').value,
                horarioInicio: document.getElementById('eventoHorarioInicio').value,
                horarioFim: document.getElementById('eventoHorarioFim').value,
                pessoas: Array.from(estadoSistema.pessoasSelecionadas)
            };
            
            if (estadoSistema.editandoEvento) {
                const index = dados.eventos.findIndex(e => e.id === estadoSistema.editandoEvento);
                if (index !== -1) {
                    dados.eventos[index] = evento;
                    mostrarNotificacao('Evento atualizado com sucesso!');
                }
            } else {
                dados.eventos.push(evento);
                mostrarNotificacao('Evento criado com sucesso!');
            }
            
            // ‚úÖ SINCRONIZA√á√ÉO MELHORADA
            sincronizarEventoParaAgendas(evento);
            
            salvarDados();
            fecharModal('modalEvento');
            gerarCalendario();
            atualizarEstatisticas();
            
            // Atualizar agenda se estiver visualizando
            if (estadoSistema.pessoaAtual) {
                renderizarAgendaSemana(estadoSistema.pessoaAtual);
            }
        }
        
        function editarEvento(evento) {
            estadoSistema.editandoEvento = evento.id;
            estadoSistema.pessoasSelecionadas.clear();
            
            document.getElementById('modalEventoTitulo').textContent = 'Editar Evento';
            document.getElementById('eventoId').value = evento.id;
            document.getElementById('eventoTipo').value = evento.tipo;
            document.getElementById('eventoTitulo').value = evento.titulo;
            document.getElementById('eventoDescricao').value = evento.descricao || '';
            document.getElementById('eventoData').value = evento.data;
            document.getElementById('eventoHorarioInicio').value = evento.horarioInicio || '09:00';
            document.getElementById('eventoHorarioFim').value = evento.horarioFim || '10:00';
            
            if (evento.pessoas) {
                evento.pessoas.forEach(pessoa => {
                    estadoSistema.pessoasSelecionadas.add(pessoa);
                });
            }
            
            atualizarListaPessoas();
            document.getElementById('modalEvento').classList.add('active');
        }
        
        function deletarEvento(id) {
            if (confirm('Deseja realmente excluir este evento?')) {
                dados.eventos = dados.eventos.filter(e => e.id !== id);
                
                salvarDados();
                gerarCalendario();
                atualizarEstatisticas();
                
                // Atualizar agenda se estiver visualizando
                if (estadoSistema.pessoaAtual) {
                    renderizarAgendaSemana(estadoSistema.pessoaAtual);
                }
                
                mostrarNotificacao('Evento exclu√≠do!');
            }
        }
        
        // Fun√ß√µes de Atividades
        function mostrarNovaAtividade() {
            estadoSistema.editandoAtividade = null;
            document.getElementById('modalAtividadeTitulo').textContent = 'Nova Atividade';
            document.getElementById('atividadeId').value = '';
            
            const select = document.getElementById('atividadeResponsaveis');
            select.innerHTML = '';
            
            const membrosMap = new Map();
            Object.entries(dados.areas).forEach(([areaKey, areaItem]) => {
                areaItem.equipe.forEach(membro => {
                    if (!membrosMap.has(membro.nome)) {
                        membrosMap.set(membro.nome, []);
                    }
                    membrosMap.get(membro.nome).push(areaItem.nome);
                });
            });
            
            Array.from(membrosMap.entries()).sort((a, b) => a[0].localeCompare(b[0])).forEach(([nomeMembro, areas]) => {
                const option = document.createElement('option');
                option.value = nomeMembro;
                option.textContent = `${nomeMembro} (${areas.join(', ')})`;
                if (estadoSistema.areaAtual && dados.areas[estadoSistema.areaAtual].equipe.some(m => m.nome === nomeMembro)) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            document.getElementById('modalAtividade').classList.add('active');
        }
        
        function editarAtividade(id) {
            const area = dados.areas[estadoSistema.areaAtual];
            const atividade = area.atividades.find(a => a.id === id);
            
            if (atividade) {
                estadoSistema.editandoAtividade = id;
                
                document.getElementById('modalAtividadeTitulo').textContent = 'Editar Atividade';
                document.getElementById('atividadeId').value = id;
                document.getElementById('atividadeNome').value = atividade.nome;
                document.getElementById('atividadePrazo').value = atividade.prazo;
                document.getElementById('atividadeStatus').value = atividade.status;
                
                const select = document.getElementById('atividadeResponsaveis');
                select.innerHTML = '';
                
                const membrosMap = new Map();
                Object.entries(dados.areas).forEach(([areaKey, areaItem]) => {
                    areaItem.equipe.forEach(membro => {
                        if (!membrosMap.has(membro.nome)) {
                            membrosMap.set(membro.nome, []);
                        }
                        membrosMap.get(membro.nome).push(areaItem.nome);
                    });
                });
                
                Array.from(membrosMap.entries()).sort((a, b) => a[0].localeCompare(b[0])).forEach(([nomeMembro, areas]) => {
                    const option = document.createElement('option');
                    option.value = nomeMembro;
                    option.textContent = `${nomeMembro} (${areas.join(', ')})`;
                    option.selected = atividade.responsaveis.includes(nomeMembro);
                    select.appendChild(option);
                });
                
                document.getElementById('modalAtividade').classList.add('active');
            }
        }
        
        function salvarAtividade() {
            const responsaveisSelect = document.getElementById('atividadeResponsaveis');
            
            if (!validarFormulario([
                {id: 'atividadeNome'},
                {id: 'atividadePrazo'},
                {id: 'atividadeResponsaveis', tipo: 'select'}
            ])) {
                mostrarNotificacao('Preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }

            // Validar prazo
            if (!validarPrazoAtividade()) {
                return;
            }
            
            const area = dados.areas[estadoSistema.areaAtual];
            const responsaveis = Array.from(responsaveisSelect.selectedOptions).map(opt => opt.value);
            
            const atividadeData = {
                nome: document.getElementById('atividadeNome').value,
                prazo: document.getElementById('atividadePrazo').value,
                responsaveis: responsaveis,
                status: document.getElementById('atividadeStatus').value
            };
            
            if (estadoSistema.editandoAtividade) {
                const index = area.atividades.findIndex(a => a.id === estadoSistema.editandoAtividade);
                if (index !== -1) {
                    area.atividades[index] = {
                        ...area.atividades[index],
                        ...atividadeData
                    };
                }
            } else {
                const novaAtividade = {
                    id: Date.now(),
                    ...atividadeData,
                    progresso: 0,
                    dataAdicionado: new Date().toISOString(),
                    tarefas: []
                };
                
                area.atividades.push(novaAtividade);
            }
            
            salvarDados();
            fecharModal('modalAtividade');
            renderizarAtividades(area);
            atualizarEstatisticas();
            mostrarNotificacao('Atividade salva com sucesso!');
        }
        
        function deletarAtividade(id) {
            if (confirm('Deseja realmente excluir esta atividade?')) {
                const area = dados.areas[estadoSistema.areaAtual];
                area.atividades = area.atividades.filter(a => a.id !== id);
                
                salvarDados();
                renderizarAtividades(area);
                atualizarEstatisticas();
                mostrarNotificacao('Atividade exclu√≠da!');
            }
        }
        
        function mudarStatus(id, novoStatus) {
            const area = dados.areas[estadoSistema.areaAtual];
            const atividade = area.atividades.find(a => a.id === id);
            if (atividade) {
                atividade.status = novoStatus;
                salvarDados();
                atualizarEstatisticas();
            }
        }
        
        // Fun√ß√µes de Agenda Individual
        function mostrarAgendaIndividual(nome, cargo) {
            console.log('üöÄ DEBUG: Abrindo agenda individual para:', nome);
            
            estadoSistema.pessoaAtual = nome;
            
            document.getElementById('painelArea').classList.add('hidden');
            document.getElementById('agendaIndividual').classList.remove('hidden');
            
            document.getElementById('pessoaNome').textContent = nome;
            document.getElementById('pessoaCargo').textContent = cargo;
            
            console.log('üöÄ DEBUG: Chamando renderizarResponsabilidades...');
            renderizarResponsabilidades(nome);
            
            console.log('üöÄ DEBUG: Chamando renderizarAgendaSemana...');
            renderizarAgendaSemana(nome);
            
            console.log('üöÄ DEBUG: Chamando carregarObservacoes...');
            carregarObservacoes(nome);
            
            const area = dados.areas[estadoSistema.areaAtual];
            atualizarBreadcrumb(`Dashboard > ${area.nome} > ${nome}`);
            
            console.log('‚úÖ DEBUG: Agenda individual configurada para:', nome);
        }
        
        function renderizarResponsabilidades(nome) {
            const lista = document.getElementById('responsabilidadesLista');
            lista.innerHTML = '';
            let totalResponsabilidades = 0;
            let responsabilidades = [];
            
            Object.entries(dados.areas).forEach(([areaKey, area]) => {
                area.atividades.forEach(atividade => {
                    if (atividade.responsaveis.includes(nome)) {
                        totalResponsabilidades++;
                        responsabilidades.push({
                            atividade: atividade,
                            areaKey: areaKey,
                            areaNome: area.nome,
                            prazoData: new Date(atividade.prazo)
                        });
                    }
                });
            });
            
            responsabilidades.sort((a, b) => a.prazoData - b.prazoData);
            
            const filtro = document.getElementById('filtroResponsabilidades')?.value || 'todas';
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            const responsabilidadesFiltradas = responsabilidades.filter(({atividade}) => {
                const prazo = new Date(atividade.prazo);
                prazo.setHours(0, 0, 0, 0);
                const diasRestantes = Math.floor((prazo - hoje) / (1000 * 60 * 60 * 24));
                
                switch(filtro) {
                    case 'urgentes':
                        return diasRestantes <= 3 && diasRestantes >= 0;
                    case 'atrasadas':
                        return diasRestantes < 0;
                    case 'emdia':
                        return atividade.status === 'verde';
                    case 'atencao':
                        return atividade.status === 'amarelo';
                    default:
                        return true;
                }
            });
            
            responsabilidadesFiltradas.forEach(({atividade, areaKey, areaNome}) => {
                const div = document.createElement('div');
                
                const diasRestantes = calcularDiasRestantes(atividade.prazo);
                
                div.style.cssText = `padding: 12px; border: 1px solid #e5e7eb; margin-bottom: 12px; border-radius: 8px; ${diasRestantes < 0 ? 'border-color: #ef4444; background: #fee2e2;' : diasRestantes <= 3 ? 'border-color: #f59e0b; background: #fef3c7;' : ''}`;
                
                let prazoTexto = '';
                if (diasRestantes < 0) {
                    prazoTexto = `‚ö†Ô∏è Atrasado ${Math.abs(diasRestantes)} dias`;
                } else if (diasRestantes === 0) {
                    prazoTexto = 'üìÖ Vence hoje!';
                } else if (diasRestantes <= 3) {
                    prazoTexto = `‚è∞ ${diasRestantes} dias restantes`;
                } else {
                    prazoTexto = `üìÖ ${diasRestantes} dias restantes`;
                }
                
                div.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="status-indicator status-${atividade.status}"></span>
                            <strong>${atividade.nome}</strong>
                        </div>
                        <div>
                            <button class="btn btn-primary btn-sm" onclick="editarResponsabilidade(${atividade.id}, '${areaKey}')">
                                ‚úèÔ∏è Editar
                            </button>
                        </div>
                    </div>
                    <div style="font-size: 13px; color: #6b7280;">
                        ${areaNome}<br>
                        Prazo: ${formatarData(atividade.prazo)} <span style="font-weight: bold;">${prazoTexto}</span><br>
                        Respons√°veis: ${atividade.responsaveis.join(', ')}
                    </div>
                    <div style="margin-top: 8px;">
                        <select onchange="mudarStatusResponsabilidade(${atividade.id}, '${areaKey}', this.value)" 
                                style="padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                            <option value="verde" ${atividade.status === 'verde' ? 'selected' : ''}>üü¢ Em Dia</option>
                            <option value="amarelo" ${atividade.status === 'amarelo' ? 'selected' : ''}>üü° Aten√ß√£o</option>
                            <option value="vermelho" ${atividade.status === 'vermelho' ? 'selected' : ''}>üî¥ Atraso</option>
                        </select>
                    </div>
                `;
                
                lista.appendChild(div);
            });
            
            const contador = document.getElementById('contadorResponsabilidades');
            if (contador) {
                const totalReal = totalResponsabilidades;
                const totalFiltrado = responsabilidadesFiltradas.length;
                
                if (filtro !== 'todas' && totalFiltrado !== totalReal) {
                    contador.textContent = `${totalFiltrado}/${totalReal}`;
                } else {
                    contador.textContent = totalReal;
                }
                contador.style.background = totalReal > 5 ? '#fbbf24' : '#e5e7eb';
            }
            
            if (totalResponsabilidades === 0) {
                lista.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <p style="font-size: 48px; margin-bottom: 16px;">üìã</p>
                        <p>Voc√™ ainda n√£o tem responsabilidades atribu√≠das.</p>
                    </div>
                `;
            } else if (responsabilidadesFiltradas.length === 0) {
                lista.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <p style="font-size: 32px; margin-bottom: 16px;">üîç</p>
                        <p>Nenhuma responsabilidade encontrada com este filtro.</p>
                    </div>
                `;
            }
        }
        
        // ‚úÖ FUN√á√ÉO CORRIGIDA DE AGENDA SEMANAL COM DEBUG
        function renderizarAgendaSemana(nome) {
            console.log('üîß DEBUG: Renderizando agenda para:', nome);
            console.log('üîß DEBUG: Dados dispon√≠veis:', dados);
            
            const container = document.getElementById('agendaSemana');
            if (!container) {
                console.error('‚ùå Container agendaSemana n√£o encontrado!');
                return;
            }
            
            container.innerHTML = '';
            
            const diasSemana = ['segunda', 'terca', 'quarta', 'quinta', 'sexta'];
            const diasNomes = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta'];
            
            diasSemana.forEach((dia, index) => {
                const diaDiv = document.createElement('div');
                diaDiv.className = 'dia-semana';
                
                const hoje = new Date();
                const diaSemanaAtual = hoje.getDay();
                const diasParaAdicionar = index + 1 - diaSemanaAtual;
                const dataDodia = new Date(hoje);
                dataDodia.setDate(hoje.getDate() + diasParaAdicionar);
                const dataFormatada = dataDodia.toISOString().split('T')[0];
                
                console.log(`üîß DEBUG: Processando ${dia} (${dataFormatada})`);
                
                diaDiv.innerHTML = `
                    <h4 style="margin-bottom: 12px; color: #1f2937;">
                        ${diasNomes[index]} 
                        <span style="font-size: 11px; color: #6b7280;">${formatarData(dataFormatada)}</span>
                    </h4>
                `;
                
                let temItens = false;
                
                // TESTE: Sempre adicionar um item para verificar se est√° funcionando
                const testeDiv = document.createElement('div');
                testeDiv.className = 'tarefa';
                testeDiv.style.background = '#e0f2fe';
                testeDiv.innerHTML = `
                    <strong style="font-size: 11px;">üîß TESTE: Sistema funcionando</strong>
                    <br><span style="font-size: 10px; color: #6b7280;">
                        Debug - ${new Date().toLocaleTimeString()}
                    </span>
                `;
                diaDiv.appendChild(testeDiv);
                temItens = true;
                
                // 1. TAREFAS PESSOAIS da agenda
                if (dados && dados.agendas && dados.agendas[nome] && dados.agendas[nome][dia]) {
                    console.log(`üîß DEBUG: Encontradas ${dados.agendas[nome][dia].length} tarefas para ${dia}`);
                    dados.agendas[nome][dia].forEach(tarefa => {
                        const tarefaDiv = document.createElement('div');
                        let classeTarefa = 'tarefa';
                        if (tarefa.mostrarNoCalendario) classeTarefa += ' tarefa-global';
                        
                        tarefaDiv.className = classeTarefa;
                        tarefaDiv.style.background = tarefa.mostrarNoCalendario ? '#ddd6fe' : '#f3f4f6';
                        tarefaDiv.innerHTML = `
                            <strong style="font-size: 11px;">üìù ${tarefa.descricao.split(' - ')[0]}</strong>
                            <br><span style="font-size: 10px; color: #6b7280;">
                                ${tarefa.descricao.split(' - ')[1] || ''}
                                ${tarefa.mostrarNoCalendario ? ' ‚Ä¢ üìÖ No calend√°rio' : ''}
                            </span>
                            <span class="delete-btn" onclick="deletarTarefa('${nome}', '${dia}', '${tarefa.id}')">√ó</span>
                        `;
                        diaDiv.appendChild(tarefaDiv);
                        temItens = true;
                    });
                } else {
                    console.log(`üîß DEBUG: Nenhuma tarefa encontrada para ${nome} no ${dia}`);
                }
                
                // 2. EVENTOS DO CALEND√ÅRIO onde a pessoa participa
                const eventosDia = obterEventosDoDia(dataFormatada);
                console.log(`üîß DEBUG: ${eventosDia.length} eventos encontrados para ${dataFormatada}`);
                
                const eventosRelevantes = eventosDia.filter(evento => 
                    evento.pessoas && (
                        evento.pessoas.includes(nome) || 
                        evento.pessoas.includes('Todos') ||
                        evento.pessoas.includes('_todos')
                    ) && evento.origem !== 'tarefa_pessoal'
                );
                
                console.log(`üîß DEBUG: ${eventosRelevantes.length} eventos relevantes para ${nome}`);
                
                eventosRelevantes.forEach(evento => {
                    const eventoDiv = document.createElement('div');
                    eventoDiv.className = 'tarefa';
                    
                    let corFundo = '#bfdbfe';
                    let icone = 'üìÖ';
                    switch(evento.tipo) {
                        case 'reuniao': corFundo = '#bfdbfe'; icone = 'üìÖ'; break;
                        case 'entrega': corFundo = '#bbf7d0'; icone = 'üì¶'; break;
                        case 'prazo': corFundo = '#fecaca'; icone = '‚è∞'; break;
                        case 'marco': corFundo = '#ddd6fe'; icone = 'üéØ'; break;
                        case 'outro': corFundo = '#e5e7eb'; icone = 'üìå'; break;
                    }
                    
                    eventoDiv.style.background = corFundo;
                    eventoDiv.style.cursor = 'pointer';
                    
                    eventoDiv.innerHTML = `
                        <strong style="font-size: 11px;">${icone} ${evento.titulo}</strong>
                        <br><span style="font-size: 10px; color: #374151;">
                            ${evento.horarioInicio || 'Todo dia'}
                            ${evento.horarioFim ? ` - ${evento.horarioFim}` : ''}
                            ${evento.pessoas.length > 1 ? ` ‚Ä¢ ${evento.pessoas.length} pessoas` : ''}
                        </span>
                    `;
                    
                    eventoDiv.onclick = function(e) {
                        e.stopPropagation();
                        editarEvento(evento);
                    };
                    
                    eventoDiv.title = `${evento.titulo}\n${evento.descricao || ''}\nüí° Clique para editar`;
                    
                    diaDiv.appendChild(eventoDiv);
                    temItens = true;
                });
                
                // 3. PRAZOS DAS RESPONSABILIDADES (pr√≥ximos 7 dias)
                if (dados && dados.areas) {
                    Object.entries(dados.areas).forEach(([areaKey, area]) => {
                        area.atividades.forEach(atividade => {
                            if (atividade.responsaveis.includes(nome)) {
                                const prazoData = new Date(atividade.prazo);
                                prazoData.setHours(0, 0, 0, 0);
                                const dataAtual = new Date(dataFormatada);
                                dataAtual.setHours(0, 0, 0, 0);
                                
                                // Se o prazo √© neste dia ou nos pr√≥ximos 7 dias
                                const diffDias = Math.floor((prazoData - dataAtual) / (1000 * 60 * 60 * 24));
                                
                                if (diffDias === 0) { // Prazo hoje
                                    const prazoDiv = document.createElement('div');
                                    prazoDiv.className = 'tarefa';
                                    prazoDiv.style.background = '#fee2e2';
                                    prazoDiv.style.borderLeft = '3px solid #ef4444';
                                    
                                    prazoDiv.innerHTML = `
                                        <strong style="font-size: 11px; color: #dc2626;">‚è∞ PRAZO HOJE</strong>
                                        <br><span style="font-size: 10px; color: #374151;">
                                            ${atividade.nome}
                                        </span>
                                        <br><span style="font-size: 9px; color: #6b7280;">
                                            ${area.nome}
                                        </span>
                                    `;
                                    
                                    prazoDiv.onclick = function() {
                                        editarResponsabilidade(atividade.id, areaKey);
                                    };
                                    
                                    diaDiv.appendChild(prazoDiv);
                                    temItens = true;
                                } else if (diffDias > 0 && diffDias <= 3) { // Pr√≥ximos 3 dias
                                    const prazoDiv = document.createElement('div');
                                    prazoDiv.className = 'tarefa';
                                    prazoDiv.style.background = '#fef3c7';
                                    prazoDiv.style.borderLeft = '3px solid #f59e0b';
                                    
                                    prazoDiv.innerHTML = `
                                        <strong style="font-size: 11px; color: #d97706;">üìÖ Em ${diffDias} dia${diffDias > 1 ? 's' : ''}</strong>
                                        <br><span style="font-size: 10px; color: #374151;">
                                            ${atividade.nome}
                                        </span>
                                        <br><span style="font-size: 9px; color: #6b7280;">
                                            ${area.nome}
                                        </span>
                                    `;
                                    
                                    prazoDiv.onclick = function() {
                                        editarResponsabilidade(atividade.id, areaKey);
                                    };
                                    
                                    diaDiv.appendChild(prazoDiv);
                                    temItens = true;
                                }
                            }
                        });
                    });
                }
                
                // Status do dia (aus√™ncia, home office)
                const statusDia = dados?.statusPessoal?.[nome]?.[dataFormatada];
                if (statusDia) {
                    const badgeDiv = document.createElement('div');
                    badgeDiv.className = `status-badge ${statusDia.tipo === 'ausencia' ? 'status-ausencia' : 'status-home-office'}`;
                    badgeDiv.textContent = statusDia.tipo === 'ausencia' ? 'Ausente' : 'Home Office';
                    diaDiv.appendChild(badgeDiv);
                    temItens = true;
                }
                
                container.appendChild(diaDiv);
            });
            
            console.log('‚úÖ DEBUG: Agenda renderizada com sucesso para:', nome);
        }
        
        function carregarObservacoes(nome) {
            const observacoes = dados.agendas[nome]?.observacoes || '';
            document.getElementById('observacoesPessoais').value = observacoes;
        }
        
        function salvarObservacoes() {
            const nome = estadoSistema.pessoaAtual;
            if (!dados.agendas[nome]) {
                dados.agendas[nome] = {};
            }
            dados.agendas[nome].observacoes = document.getElementById('observacoesPessoais').value;
            salvarDados();
        }
        
        // Outras fun√ß√µes auxiliares
        function atualizarBreadcrumb(path) {
            const breadcrumb = document.getElementById('breadcrumb');
            const breadcrumbPath = document.getElementById('breadcrumbPath');
            
            breadcrumb.classList.remove('hidden');
            
            const parts = path.split(' > ');
            const links = parts.map((part, index) => {
                if (index === 0) {
                    return `<a onclick="voltarDashboard()">Dashboard</a>`;
                } else if (index === parts.length - 1) {
                    return part;
                } else {
                    return `<a onclick="mostrarArea('${estadoSistema.areaAtual}')">${part}</a>`;
                }
            });
            
            breadcrumbPath.innerHTML = links.join(' > ');
        }
        
        // Fun√ß√µes de tarefas pessoais
        function mostrarNovaTarefa() {
            document.getElementById('modalTarefa').classList.add('active');
        }
        
        function alternarTipoAgendamento() {
            const tipo = document.getElementById('tarefaTipo').value;
            if (tipo === 'semanal') {
                document.getElementById('grupoDiaSemana').classList.remove('hidden');
                document.getElementById('grupoData').classList.add('hidden');
            } else {
                document.getElementById('grupoDiaSemana').classList.add('hidden');
                document.getElementById('grupoData').classList.remove('hidden');
            }
        }
        
        function salvarTarefa() {
            const nome = estadoSistema.pessoaAtual;
            const tipo = document.getElementById('tarefaTipo').value;
            const descricao = document.getElementById('tarefaDescricao').value;
            const horario = document.getElementById('tarefaHorario').value;
            const mostrarNoCalendario = document.getElementById('tarefaCalendario').checked;
            
            if (!validarFormulario([
                {id: 'tarefaDescricao'},
                {id: 'tarefaHorario'}
            ])) {
                mostrarNotificacao('Preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }
            
            if (tipo === 'data') {
                if (!document.getElementById('tarefaDataEspecifica').value) {
                    document.getElementById('tarefaDataEspecifica').classList.add('input-error');
                    document.getElementById('tarefaDataError').classList.remove('hidden');
                    mostrarNotificacao('Selecione uma data!', 'error');
                    return;
                }
            }
            
            const tarefaBase = {
                id: Date.now(),
                descricao: `${descricao} - ${horario}`,
                mostrarNoCalendario: mostrarNoCalendario
            };
            
            if (!dados.agendas[nome]) {
                dados.agendas[nome] = {};
            }
            
            if (tipo === 'semanal') {
                const dia = document.getElementById('tarefaDia').value;
                
                if (!dados.agendas[nome][dia]) {
                    dados.agendas[nome][dia] = [];
                }
                
                dados.agendas[nome][dia].push(tarefaBase);
            } else {
                const dataEspecifica = document.getElementById('tarefaDataEspecifica').value;
                
                const evento = {
                    id: Date.now(),
                    data: dataEspecifica,
                    horarioInicio: horario,
                    titulo: descricao,
                    tipo: 'outro',
                    pessoas: [nome],
                    origem: 'tarefa_pessoal'
                };
                dados.eventos.push(evento);
            }
            
            salvarDados();
            fecharModal('modalTarefa');
            renderizarAgendaSemana(nome);
            gerarCalendario();
            
            mostrarNotificacao('Tarefa salva com sucesso!');
        }

        function deletarTarefa(nome, dia, tarefaId) {
            if (confirm('Deseja realmente excluir esta tarefa?')) {
                dados.agendas[nome][dia] = dados.agendas[nome][dia].filter(t => t.id != tarefaId);
                salvarDados();
                renderizarAgendaSemana(nome);
                
                mostrarNotificacao('Tarefa exclu√≠da!');
            }
        }
        
        // Fun√ß√µes de status pessoal
        function mostrarMarcarStatus() {
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('statusData').value = hoje;
            document.getElementById('modalStatus').classList.add('active');
        }
        
        function salvarStatus() {
            const nome = estadoSistema.pessoaAtual;
            const data = document.getElementById('statusData').value;
            const tipo = document.getElementById('statusTipo').value;
            const observacao = document.getElementById('statusObservacao').value;
            
            if (!data) {
                document.getElementById('statusData').classList.add('input-error');
                document.getElementById('statusDataError').classList.remove('hidden');
                return;
            }
            
            if (!dados.statusPessoal) {
                dados.statusPessoal = {};
            }
            if (!dados.statusPessoal[nome]) {
                dados.statusPessoal[nome] = {};
            }
            
            if (tipo === 'presente') {
                delete dados.statusPessoal[nome][data];
            } else {
                dados.statusPessoal[nome][data] = {
                    tipo: tipo,
                    observacao: observacao
                };
            }
            
            salvarDados();
            fecharModal('modalStatus');
            renderizarAgendaSemana(nome);
            mostrarNotificacao('Status do dia salvo com sucesso!');
        }
        
        // Fun√ß√µes de feriados
        function mostrarMarcarFeriado() {
            document.getElementById('modalFeriado').classList.add('active');
            listarFeriados();
        }
        
        function salvarFeriado() {
            const data = document.getElementById('feriadoData').value;
            const nome = document.getElementById('feriadoNome').value;
            
            if (!validarFormulario([
                {id: 'feriadoData'},
                {id: 'feriadoNome'}
            ])) {
                mostrarNotificacao('Preencha todos os campos!', 'error');
                return;
            }
            
            if (!dados.feriados) {
                dados.feriados = {};
            }
            
            dados.feriados[data] = nome;
            
            salvarDados();
            document.getElementById('feriadoData').value = '';
            document.getElementById('feriadoNome').value = '';
            listarFeriados();
            gerarCalendario();
            mostrarNotificacao('Feriado cadastrado com sucesso!');
        }
        
        function listarFeriados() {
            const lista = document.getElementById('listaFeriados');
            lista.innerHTML = '';
            
            if (dados.feriados && Object.keys(dados.feriados).length > 0) {
                Object.entries(dados.feriados)
                    .sort((a, b) => new Date(a[0]) - new Date(b[0]))
                    .forEach(([data, nome]) => {
                        const div = document.createElement('div');
                        div.style.cssText = 'padding: 8px; background: #fef3c7; margin-bottom: 8px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;';
                        div.innerHTML = `
                            <span>${formatarData(data)} - ${nome}</span>
                            <span class="delete-btn" onclick="deletarFeriado('${data}')">√ó</span>
                        `;
                        lista.appendChild(div);
                    });
            } else {
                lista.innerHTML = '<p style="text-align: center; color: #6b7280;">Nenhum feriado cadastrado</p>';
            }
        }
        
        function deletarFeriado(data) {
            if (confirm('Deseja remover este feriado?')) {
                delete dados.feriados[data];
                salvarDados();
                listarFeriados();
                gerarCalendario();
                mostrarNotificacao('Feriado removido!');
            }
        }
        
        // Fun√ß√µes de importa√ß√£o/exporta√ß√£o
        function exportarDados() {
            const dataExport = {
                ...dados,
                exportadoEm: new Date().toISOString(),
                versao: VERSAO_SISTEMA
            };
            
            const blob = new Blob([JSON.stringify(dataExport, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-gestao-obra-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            mostrarNotificacao('Dados exportados com sucesso!');
        }
        
        function mostrarImportar() {
            document.getElementById('modalImportar').classList.add('active');
        }
        
        function importarDados() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                mostrarNotificacao('Selecione um arquivo!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.areas && importedData.eventos) {
                        const backup = {...dados};
                        
                        try {
                            dados = {
                                versao: importedData.versao || VERSAO_DB,
                                areas: importedData.areas,
                                eventos: importedData.eventos,
                                agendas: importedData.agendas || {},
                                feriados: importedData.feriados || {},
                                statusPessoal: importedData.statusPessoal || {},
                                ultimaAtualizacao: new Date().toISOString()
                            };
                            
                            salvarDados();
                            fecharModal('modalImportar');
                            renderizarDashboard();
                            mostrarNotificacao('Dados importados com sucesso!');
                        } catch (erro) {
                            dados = backup;
                            throw erro;
                        }
                    } else {
                        mostrarNotificacao('Arquivo inv√°lido!', 'error');
                    }
                } catch (error) {
                    console.error('Erro ao importar:', error);
                    mostrarNotificacao('Erro ao importar arquivo!', 'error');
                }
            };
            reader.readAsText(file);
        }
        
        // ========== FUN√á√ïES DE BUSCA MELHORADAS ==========
        let timeoutBusca = null;
        
        function buscarGlobalDebounced() {
            clearTimeout(timeoutBusca);
            timeoutBusca = setTimeout(buscarGlobal, 300);
        }
        
        function buscarGlobal() {
            const termo = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!termo) {
                renderizarDashboard();
                return;
            }
            
            let resultados = [];
            const termoNormalizado = normalizarTexto(termo);
            
            // ‚úÖ BUSCA MELHORADA COM NORMALIZA√á√ÉO
            Object.entries(dados.areas).forEach(([areaKey, area]) => {
                area.atividades.forEach(atividade => {
                    const nomeNormalizado = normalizarTexto(atividade.nome);
                    const responsaveisNormalizados = atividade.responsaveis.map(r => normalizarTexto(r));
                    
                    const match = nomeNormalizado.includes(termoNormalizado) ||
                                 responsaveisNormalizados.some(r => r.includes(termoNormalizado));
                    
                    if (match) {
                        resultados.push({
                            tipo: 'atividade',
                            area: area.nome,
                            areaKey: areaKey,
                            atividade: atividade
                        });
                    }
                });
            });
            
            dados.eventos.forEach(evento => {
                const tituloNormalizado = normalizarTexto(evento.titulo);
                const pessoasNormalizadas = evento.pessoas ? evento.pessoas.map(p => normalizarTexto(p)) : [];
                
                if (tituloNormalizado.includes(termoNormalizado) ||
                    pessoasNormalizadas.some(p => p.includes(termoNormalizado))) {
                    resultados.push({
                        tipo: 'evento',
                        evento: evento
                    });
                }
            });
            
            const pessoasEncontradas = new Set();
            Object.values(dados.areas).forEach(area => {
                area.equipe.forEach(membro => {
                    const nomeNormalizado = normalizarTexto(membro.nome);
                    const cargoNormalizado = normalizarTexto(membro.cargo);
                    
                    if (nomeNormalizado.includes(termoNormalizado) || 
                        cargoNormalizado.includes(termoNormalizado)) {
                        pessoasEncontradas.add({
                            nome: membro.nome,
                            cargo: membro.cargo,
                            area: area.nome
                        });
                    }
                });
            });
            
            pessoasEncontradas.forEach(pessoa => {
                resultados.push({
                    tipo: 'pessoa',
                    pessoa: pessoa
                });
            });
            
            mostrarResultadosBusca(resultados, termo);
        }
        
        function mostrarResultadosBusca(resultados, termo) {
            const grid = document.getElementById('areasGrid');
            grid.innerHTML = '';
            
            const cardResultados = document.createElement('div');
            cardResultados.className = 'card';
            cardResultados.style.gridColumn = 'span 3';
            
            cardResultados.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üîç Resultados da busca: "${termo}"</h3>
                    <button class="btn btn-secondary btn-sm" onclick="limparBusca()">Limpar busca</button>
                </div>
                <p style="color: #6b7280; margin-bottom: 16px;">${resultados.length} resultados encontrados</p>
            `;
            
            if (resultados.length === 0) {
                cardResultados.innerHTML += `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <p style="font-size: 48px; margin-bottom: 16px;">üîç</p>
                        <p>Nenhum resultado encontrado para "${termo}"</p>
                    </div>
                `;
            } else {
                const atividades = resultados.filter(r => r.tipo === 'atividade');
                const eventos = resultados.filter(r => r.tipo === 'evento');
                const pessoas = resultados.filter(r => r.tipo === 'pessoa');
                
                if (atividades.length > 0) {
                    cardResultados.innerHTML += '<h4 style="margin-top: 20px; margin-bottom: 12px;">üìã Atividades</h4>';
                    atividades.forEach(res => {
                        const diasRestantes = calcularDiasRestantes(res.atividade.prazo);
                        cardResultados.innerHTML += `
                            <div style="padding: 12px; border: 1px solid #e5e7eb; margin-bottom: 8px; border-radius: 8px; cursor: pointer;" 
                                 onclick="abrirAreaAtividade('${res.areaKey}', ${res.atividade.id})">
                                <strong>${res.atividade.nome}</strong>
                                <span class="status-indicator status-${res.atividade.status}" style="float: right;"></span>
                                <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">
                                    ${res.area} | Respons√°veis: ${res.atividade.responsaveis.join(', ')}
                                    <br>Prazo: ${formatarData(res.atividade.prazo)} (${diasRestantes} dias)
                                </div>
                            </div>
                        `;
                    });
                }
                
                if (eventos.length > 0) {
                    cardResultados.innerHTML += '<h4 style="margin-top: 20px; margin-bottom: 12px;">üìÖ Eventos</h4>';
                    eventos.forEach(res => {
                        cardResultados.innerHTML += `
                            <div style="padding: 12px; border: 1px solid #e5e7eb; margin-bottom: 8px; border-radius: 8px;">
                                <strong>${res.evento.titulo}</strong>
                                <span class="evento evento-${res.evento.tipo}" style="float: right; padding: 4px 8px;">
                                    ${res.evento.tipo}
                                </span>
                                <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">
                                    ${formatarData(res.evento.data)} ${res.evento.horarioInicio ? `√†s ${res.evento.horarioInicio}` : ''} | 
                                    ${res.evento.pessoas ? res.evento.pessoas.length : 0} pessoa(s)
                                </div>
                            </div>
                        `;
                    });
                }
                
                if (pessoas.length > 0) {
                    cardResultados.innerHTML += '<h4 style="margin-top: 20px; margin-bottom: 12px;">üë• Pessoas</h4>';
                    pessoas.forEach(res => {
                        cardResultados.innerHTML += `
                            <div style="padding: 12px; border: 1px solid #e5e7eb; margin-bottom: 8px; border-radius: 8px;">
                                <strong>${res.pessoa.nome}</strong>
                                <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">
                                    ${res.pessoa.cargo} | ${res.pessoa.area}
                                </div>
                            </div>
                        `;
                    });
                }
            }
            
            grid.appendChild(cardResultados);
        }
        
        function limparBusca() {
            document.getElementById('searchInput').value = '';
            renderizarDashboard();
        }
        
        function abrirAreaAtividade(areaKey, atividadeId) {
            mostrarArea(areaKey);
            setTimeout(() => {
                const elemento = document.querySelector(`[data-atividade-id="${atividadeId}"]`);
                if (elemento) {
                    elemento.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    elemento.style.border = '2px solid #3b82f6';
                    setTimeout(() => {
                        elemento.style.border = '1px solid #e5e7eb';
                    }, 2000);
                }
            }, 100);
        }
        
        function filtrarStatus(status, elemento) {
            estadoSistema.filtroAtual = status;
            
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.classList.remove('active');
            });
            elemento.classList.add('active');
            
            if (estadoSistema.areaAtual) {
                renderizarAtividades(dados.areas[estadoSistema.areaAtual]);
            }
        }
        
        // Fun√ß√µes auxiliares do sistema de responsabilidades
        function mudarStatusResponsabilidade(atividadeId, areaKey, novoStatus) {
            const area = dados.areas[areaKey];
            const atividade = area.atividades.find(a => a.id === atividadeId);
            if (atividade) {
                atividade.status = novoStatus;
                salvarDados();
                renderizarResponsabilidades(estadoSistema.pessoaAtual);
                mostrarNotificacao('Status atualizado!');
            }
        }
        
        function editarResponsabilidade(atividadeId, areaKey) {
            const areaTemp = estadoSistema.areaAtual;
            estadoSistema.areaAtual = areaKey;
            editarAtividade(atividadeId);
        }
        
        function validarFormulario(campos) {
            let valido = true;
            
            campos.forEach(campo => {
                const elemento = document.getElementById(campo.id);
                const erro = document.getElementById(campo.id + 'Error');
                
                if (!elemento.value || (campo.tipo === 'select' && elemento.selectedOptions.length === 0)) {
                    elemento.classList.add('input-error');
                    if (erro) erro.classList.remove('hidden');
                    valido = false;
                } else {
                    elemento.classList.remove('input-error');
                    if (erro) erro.classList.add('hidden');
                }
            });
            
            return valido;
        }
        
        function fecharModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            
            const modal = document.getElementById(modalId);
            modal.querySelectorAll('input[type="text"], input[type="date"], input[type="time"], input[type="number"], textarea').forEach(input => {
                input.value = '';
                input.classList.remove('input-error');
            });
            modal.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
                select.classList.remove('input-error');
            });
            modal.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            modal.querySelectorAll('.error-message').forEach(error => {
                error.classList.add('hidden');
            });
            
            estadoSistema.editandoAtividade = null;
            estadoSistema.editandoEvento = null;
            estadoSistema.pessoasSelecionadas.clear();
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log(`üèóÔ∏è Sistema de Gest√£o Firebase v${VERSAO_SISTEMA} iniciado`);
            console.log('üöÄ VERS√ÉO 5.2 - SISTEMA OTIMIZADO PARA USABILIDADE:');
            console.log('‚úÖ Sincroniza√ß√£o Agenda ‚Üî Calend√°rio funcionando perfeitamente');
            console.log('‚úÖ Sistema simplificado - removidas funcionalidades desnecess√°rias');
            console.log('‚úÖ Busca inteligente com normaliza√ß√£o de acentos');
            console.log('‚úÖ Interface responsiva melhorada');
            console.log('‚úÖ Performance otimizada para 15 usu√°rios');
            console.log('‚úÖ C√≥digo limpo e organizado');
            console.log('üéâ TODAS AS MELHORIAS DE USABILIDADE IMPLEMENTADAS!');
            
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    salvarDados();
                    mostrarNotificacao('Dados salvos!');
                }
                
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        fecharModal(modal.id);
                    });
                }
            });
        });
        
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    fecharModal(this.id);
                }
            });
        });
        
        window.addEventListener('beforeunload', function(e) {
            if (usuarioAtual) {
                salvarDados();
            }
        });
    </script>
</body>
</html>
