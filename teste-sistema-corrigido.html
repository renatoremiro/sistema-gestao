<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª Teste Final - Sistema BIAPO Corrigido</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .test {
            background: #f8f9ff;
            border: 2px solid #e0e7ff;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        .test.success {
            border-color: #059669;
            background: #ecfdf5;
        }
        .test.error {
            border-color: #dc2626;
            background: #fef2f2;
        }
        .test.warning {
            border-color: #d97706;
            background: #fffbeb;
        }
        .btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover {
            background: #4338ca;
        }
        .btn.success {
            background: #059669;
        }
        .btn.danger {
            background: #dc2626;
        }
        .log {
            background: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 15px 0;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success { background: #059669; color: white; }
        .status.error { background: #dc2626; color: white; }
        .status.warning { background: #d97706; color: white; }
        .status.info { background: #0284c7; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Teste Final - Sistema BIAPO Corrigido</h1>
        <p>Este teste verifica se todas as correÃ§Ãµes foram aplicadas corretamente.</p>
        
        <div class="test">
            <h3>ğŸ”§ Testes AutomÃ¡ticos</h3>
            <p>Execute os testes para verificar o funcionamento do sistema:</p>
            
            <button class="btn" onclick="executarTesteCompleto()">ğŸš€ Teste Completo</button>
            <button class="btn success" onclick="executarCorrecaoAutomatica()">ğŸ”§ CorreÃ§Ã£o AutomÃ¡tica</button>
            <button class="btn" onclick="testarPersistencia()">ğŸ’¾ Testar PersistÃªncia</button>
            <button class="btn" onclick="testarSupabaseConectividade()">ğŸ”— Testar Supabase</button>
            <button class="btn danger" onclick="limparLog()">ğŸ—‘ï¸ Limpar Log</button>
        </div>
        
        <div class="test">
            <h3>ğŸ“Š Status dos Componentes</h3>
            <div id="statusComponentes">Aguardando teste...</div>
        </div>
        
        <div class="test">
            <h3>ğŸ“ Log de Testes</h3>
            <div class="log" id="logTestes">Clique em "Teste Completo" para iniciar...\n</div>
        </div>
        
        <div class="test">
            <h3>âœ… Resultado Final</h3>
            <div id="resultadoFinal">
                <p><strong>Aguardando execuÃ§Ã£o dos testes...</strong></p>
                <p>Execute o "Teste Completo" para ver o resultado.</p>
            </div>
        </div>
    </div>

    <!-- Carregar scripts do sistema -->
    <script src="assets/js/config/env-loader.js"></script>
    <script src="assets/js/config/supabase-client.js"></script>
    <script src="assets/js/utils/helpers.js"></script>
    <script src="assets/js/utils/validation.js"></script>
    <script src="assets/js/utils/notifications.js"></script>
    <script src="assets/js/core/data.js"></script>
    <script src="assets/js/core/app.js"></script>
    <script src="assets/js/modules/persistence-supabase.js"></script>
    <script src="assets/js/modules/auth.js"></script>
    <script src="assets/js/utils/corretor-automatico.js"></script>

    <script>
        // Sistema de Testes
        const TesteFinal = {
            resultados: {},
            log: [],
            
            log_(msg) {
                const timestamp = new Date().toLocaleTimeString('pt-BR');
                const logMsg = `[${timestamp}] ${msg}`;
                this.log.push(logMsg);
                const logElement = document.getElementById('logTestes');
                if (logElement) {
                    logElement.textContent = this.log.join('\n') + '\n';
                    logElement.scrollTop = logElement.scrollHeight;
                }
                console.log(logMsg);
            },
            
            atualizarStatus() {
                const statusEl = document.getElementById('statusComponentes');
                if (!statusEl) return;
                
                const componentes = [
                    { nome: 'EnvLoader', test: () => typeof EnvLoader !== 'undefined' },
                    { nome: 'Supabase Config', test: () => !!window.SUPABASE_CONFIG },
                    { nome: 'Supabase Client', test: () => !!window.supabaseClient },
                    { nome: 'App Core', test: () => typeof App !== 'undefined' },
                    { nome: 'Persistence', test: () => typeof Persistence !== 'undefined' },
                    { nome: 'Auth', test: () => typeof Auth !== 'undefined' },
                    { nome: 'Corretor', test: () => typeof CorretorAutomatico !== 'undefined' }
                ];
                
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">';
                
                componentes.forEach(comp => {
                    const status = comp.test();
                    const statusClass = status ? 'success' : 'error';
                    const statusText = status ? 'OK' : 'ERRO';
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                            <span>${comp.nome}</span>
                            <span class="status ${statusClass}">${statusText}</span>
                        </div>
                    `;
                });
                
                html += '</div>';
                statusEl.innerHTML = html;
            },
            
            async executarTesteCompleto() {
                this.log.length = 0;
                this.resultados = {};
                
                this.log_('ğŸš€ INICIANDO TESTE COMPLETO DO SISTEMA BIAPO');
                this.log_('==========================================');
                
                // Teste 1: Componentes bÃ¡sicos
                this.log_('\nğŸ“‹ TESTE 1: Componentes bÃ¡sicos...');
                const componentesOk = this.testarComponentes();
                this.resultados.componentes = componentesOk;
                
                // Teste 2: ConfiguraÃ§Ã£o Supabase
                this.log_('\nğŸ” TESTE 2: ConfiguraÃ§Ã£o Supabase...');
                const configOk = await this.testarConfiguracao();
                this.resultados.configuracao = configOk;
                
                // Teste 3: Conectividade
                this.log_('\nğŸ”— TESTE 3: Conectividade...');
                const conectividadeOk = await this.testarConectividade();
                this.resultados.conectividade = conectividadeOk;
                
                // Teste 4: PersistÃªncia
                this.log_('\nğŸ’¾ TESTE 4: Sistema de persistÃªncia...');
                const persistenciaOk = await this.testarPersistenciaCompleta();
                this.resultados.persistencia = persistenciaOk;
                
                // Teste 5: Funcionalidades
                this.log_('\nğŸ§ª TESTE 5: Funcionalidades...');
                const funcionalidadesOk = await this.testarFuncionalidades();
                this.resultados.funcionalidades = funcionalidadesOk;
                
                // Resultado final
                this.gerarResultadoFinal();
                this.atualizarStatus();
            },
            
            testarComponentes() {
                let sucessos = 0;
                const testes = [
                    { nome: 'EnvLoader', test: () => typeof EnvLoader !== 'undefined' },
                    { nome: 'window.SUPABASE_CONFIG', test: () => !!window.SUPABASE_CONFIG },
                    { nome: 'supabaseClient', test: () => !!window.supabaseClient },
                    { nome: 'App', test: () => typeof App !== 'undefined' },
                    { nome: 'Persistence', test: () => typeof Persistence !== 'undefined' },
                    { nome: 'Auth', test: () => typeof Auth !== 'undefined' },
                    { nome: 'CorretorAutomatico', test: () => typeof CorretorAutomatico !== 'undefined' }
                ];
                
                testes.forEach(teste => {
                    const resultado = teste.test();
                    this.log_(`   ${resultado ? 'âœ…' : 'âŒ'} ${teste.nome}: ${resultado ? 'OK' : 'ERRO'}`);
                    if (resultado) sucessos++;
                });
                
                const porcentagem = (sucessos / testes.length) * 100;
                this.log_(`   ğŸ“Š Resultado: ${sucessos}/${testes.length} (${porcentagem.toFixed(1)}%)`);
                
                return porcentagem >= 85;
            },
            
            async testarConfiguracao() {
                try {
                    // Verificar configuraÃ§Ã£o
                    if (!window.SUPABASE_CONFIG) {
                        this.log_('   âŒ window.SUPABASE_CONFIG nÃ£o definida');
                        
                        if (typeof EnvLoader !== 'undefined') {
                            this.log_('   ğŸ”„ Tentando carregar via EnvLoader...');
                            await EnvLoader.carregarCredenciais();
                            
                            if (window.SUPABASE_CONFIG) {
                                this.log_('   âœ… Credenciais carregadas automaticamente');
                                return true;
                            }
                        }
                        
                        return false;
                    }
                    
                    this.log_('   âœ… window.SUPABASE_CONFIG definida');
                    this.log_(`   ğŸŒ URL: ${window.SUPABASE_CONFIG.url}`);
                    this.log_(`   ğŸ”‘ Key: ${window.SUPABASE_CONFIG.key ? 'Presente' : 'Ausente'}`);
                    
                    return true;
                    
                } catch (error) {
                    this.log_(`   âŒ Erro: ${error.message}`);
                    return false;
                }
            },
            
            async testarConectividade() {
                try {
                    if (!window.supabaseClient) {
                        this.log_('   âŒ supabaseClient nÃ£o disponÃ­vel');
                        return false;
                    }
                    
                    this.log_('   ğŸ”„ Testando conexÃ£o...');
                    const conectado = await window.supabaseClient.testarConexao();
                    
                    if (conectado) {
                        this.log_('   âœ… ConexÃ£o estabelecida com sucesso');
                        
                        // Testar estatÃ­sticas
                        const stats = await window.supabaseClient.obterEstatisticas();
                        this.log_(`   ğŸ“Š UsuÃ¡rios: ${stats.usuarios}, Eventos: ${stats.eventos}, Tarefas: ${stats.tarefas}`);
                        
                        return true;
                    } else {
                        this.log_('   âŒ Falha na conexÃ£o');
                        return false;
                    }
                    
                } catch (error) {
                    this.log_(`   âŒ Erro de conectividade: ${error.message}`);
                    return false;
                }
            },
            
            async testarPersistenciaCompleta() {
                try {
                    if (typeof Persistence === 'undefined') {
                        this.log_('   âŒ MÃ³dulo Persistence nÃ£o encontrado');
                        return false;
                    }
                    
                    this.log_('   âœ… MÃ³dulo Persistence carregado');
                    
                    // Testar salvamento local
                    this.log_('   ğŸ§ª Testando salvamento local...');
                    const dadosTeste = { teste: Date.now(), origem: 'teste_final' };
                    Persistence._salvarBackupLocal(dadosTeste);
                    this.log_('   âœ… Salvamento local funcionando');
                    
                    // Testar verificaÃ§Ã£o de usuÃ¡rio
                    const usuario = Persistence._verificarUsuarioLogado();
                    this.log_(`   ğŸ‘¤ UsuÃ¡rio: ${usuario ? usuario.email || 'ID: ' + usuario.id : 'Nenhum'}`);
                    
                    // Testar salvamento geral
                    if (typeof App !== 'undefined' && App.dados) {
                        this.log_('   ğŸ§ª Testando salvamento geral...');
                        await Persistence.salvarDados();
                        this.log_('   âœ… Salvamento geral funcionando');
                    }
                    
                    return true;
                    
                } catch (error) {
                    this.log_(`   âŒ Erro de persistÃªncia: ${error.message}`);
                    return false;
                }
            },
            
            async testarFuncionalidades() {
                try {
                    let sucessos = 0;
                    const totalTestes = 3;
                    
                    // Teste funÃ§Ã£o global
                    if (typeof testarSupabase === 'function') {
                        this.log_('   âœ… FunÃ§Ã£o testarSupabase disponÃ­vel');
                        sucessos++;
                    } else {
                        this.log_('   âŒ FunÃ§Ã£o testarSupabase nÃ£o encontrada');
                    }
                    
                    // Teste corretor automÃ¡tico
                    if (typeof corretorAutomatico === 'function') {
                        this.log_('   âœ… FunÃ§Ã£o corretorAutomatico disponÃ­vel');
                        sucessos++;
                    } else {
                        this.log_('   âŒ FunÃ§Ã£o corretorAutomatico nÃ£o encontrada');
                    }
                    
                    // Teste verificaÃ§Ã£o sistema
                    if (typeof verificarSistemaSupabase === 'function') {
                        this.log_('   âœ… FunÃ§Ã£o verificarSistemaSupabase disponÃ­vel');
                        sucessos++;
                    } else {
                        this.log_('   âŒ FunÃ§Ã£o verificarSistemaSupabase nÃ£o encontrada');
                    }
                    
                    const porcentagem = (sucessos / totalTestes) * 100;
                    this.log_(`   ğŸ“Š Funcionalidades: ${sucessos}/${totalTestes} (${porcentagem.toFixed(1)}%)`);
                    
                    return porcentagem >= 80;
                    
                } catch (error) {
                    this.log_(`   âŒ Erro ao testar funcionalidades: ${error.message}`);
                    return false;
                }
            },
            
            gerarResultadoFinal() {
                this.log_('\nğŸ“Š ========== RESULTADO FINAL ==========');
                
                const testes = Object.keys(this.resultados);
                const sucessos = Object.values(this.resultados).filter(r => r).length;
                const porcentagem = (sucessos / testes.length) * 100;
                
                Object.entries(this.resultados).forEach(([nome, resultado]) => {
                    this.log_(`   ${resultado ? 'âœ…' : 'âŒ'} ${nome}: ${resultado ? 'SUCESSO' : 'FALHA'}`);
                });
                
                const status = porcentagem >= 90 ? 'ğŸŸ¢ EXCELENTE' :
                              porcentagem >= 75 ? 'ğŸŸ¡ BOM' :
                              porcentagem >= 50 ? 'ğŸŸ  REGULAR' :
                              'ğŸ”´ CRÃTICO';
                
                this.log_(`\nğŸ“Š STATUS GERAL: ${status} (${porcentagem.toFixed(1)}%)`);
                
                // Atualizar UI
                const resultadoEl = document.getElementById('resultadoFinal');
                if (resultadoEl) {
                    const statusClass = porcentagem >= 75 ? 'success' : porcentagem >= 50 ? 'warning' : 'error';
                    
                    resultadoEl.innerHTML = `
                        <div class="test ${statusClass}">
                            <h4>STATUS: ${status}</h4>
                            <p><strong>PontuaÃ§Ã£o:</strong> ${sucessos}/${testes.length} testes aprovados (${porcentagem.toFixed(1)}%)</p>
                            ${porcentagem >= 75 ? 
                                '<p>âœ… <strong>Sistema funcionando corretamente!</strong> Todas as correÃ§Ãµes foram aplicadas com sucesso.</p>' :
                                '<p>âš ï¸ <strong>Algumas correÃ§Ãµes ainda sÃ£o necessÃ¡rias.</strong> Execute o corretor automÃ¡tico.</p>'
                            }
                        </div>
                    `;
                }
                
                if (porcentagem >= 75) {
                    this.log_('\nğŸ‰ SISTEMA CORRIGIDO COM SUCESSO!');
                    this.log_('âœ… Todas as correÃ§Ãµes foram aplicadas');
                    this.log_('âœ… PersistÃªncia funcionando corretamente');
                    this.log_('âœ… Sistema pronto para uso');
                } else {
                    this.log_('\nâš ï¸ CORREÃ‡Ã•ES ADICIONAIS NECESSÃRIAS');
                    this.log_('ğŸ”§ Execute: corretorAutomatico()');
                    this.log_('ğŸ“‹ Verifique o arquivo: SOLUCAO-DEFINITIVA-PERSISTENCIA.md');
                }
                
                this.log_('\n==========================================');
            }
        };
        
        // FunÃ§Ãµes para os botÃµes
        function executarTesteCompleto() {
            TesteFinal.executarTesteCompleto();
        }
        
        async function executarCorrecaoAutomatica() {
            TesteFinal.log_('ğŸ”§ Executando correÃ§Ã£o automÃ¡tica...');
            if (typeof CorretorAutomatico !== 'undefined') {
                const resultado = await CorretorAutomatico.executarCorrecaoCompleta();
                TesteFinal.log_(`âœ… CorreÃ§Ã£o concluÃ­da: ${resultado.correcoes.length} correÃ§Ãµes aplicadas`);
                if (resultado.problemas.length > 0) {
                    TesteFinal.log_(`âš ï¸ Problemas restantes: ${resultado.problemas.length}`);
                }
            } else {
                TesteFinal.log_('âŒ CorretorAutomatico nÃ£o disponÃ­vel');
            }
            TesteFinal.atualizarStatus();
        }
        
        async function testarPersistencia() {
            TesteFinal.log_('ğŸ’¾ Testando sistema de persistÃªncia...');
            const resultado = await TesteFinal.testarPersistenciaCompleta();
            TesteFinal.log_(`ğŸ“Š Resultado: ${resultado ? 'SUCESSO' : 'FALHA'}`);
        }
        
        async function testarSupabaseConectividade() {
            TesteFinal.log_('ğŸ”— Testando conectividade Supabase...');
            const resultado = await TesteFinal.testarConectividade();
            TesteFinal.log_(`ğŸ“Š Resultado: ${resultado ? 'CONECTADO' : 'FALHA'}`);
        }
        
        function limparLog() {
            TesteFinal.log.length = 0;
            const logElement = document.getElementById('logTestes');
            if (logElement) {
                logElement.textContent = 'Log limpo. Execute um teste para ver resultados...\n';
            }
        }
        
        // InicializaÃ§Ã£o
        window.addEventListener('DOMContentLoaded', () => {
            TesteFinal.log_('ğŸ§ª Sistema de Testes carregado');
            TesteFinal.log_('ğŸ“‹ Execute "Teste Completo" para verificar o sistema');
            
            setTimeout(() => {
                TesteFinal.atualizarStatus();
            }, 2000);
        });
        
        // Exposar para debug
        window.TesteFinal = TesteFinal;
    </script>
</body>
</html>
